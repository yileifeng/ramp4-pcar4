const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lclayout-d38TF2sa.js","./_commonjsHelpers-DCkdB7M8.js"])))=>i.map(i=>d[i]);
import{O as nt,s as P,a4 as it,az as G,b8 as ct,cB as ut,x as rt,B as h,D as m,N as Ie,aN as yt,n as ot,u as ht,cl as B,bB as le,hD as Le,bR as at,aM as Se,ea as mt,d_ as ie,cU as te,fI as ft,aY as gt,aS as bt,bE as Tt,v as x,b9 as wt,G as It,bz as Et}from"./main-asQ7SttR.js";import{e as _t,s as Me}from"./OptimizedFeature-CYyXKDHx.js";import{i as Ee,r as Nt,a as _e,F as J,W as $t}from"./knowledgeGraphService-BL8Uqg6E.js";import{Q as fe,O as se}from"./projection-G6EI4E6A.js";import{I as pe,t as de,_ as O,E as re,S as Ne,o as ge}from"./constants-B4mRqufT.js";import{s as Lt}from"./featureConversionUtils-pNtCHoNi.js";import"./GraphicsLayer-CZo360Kr.js";import{_ as St}from"./preload-helper-ExcqyqRp.js";import{p as Q}from"./Relationship-CKTuQU_6.js";import{b as Y}from"./Query-D7n22axe.js";import{S as Mt}from"./MultiOriginJSONSupport-BgTEONJv.js";import{E as vt}from"./workers-BJlMhhTk.js";import{f as Dt}from"./Layer-Bx8UpsMJ.js";import{f as Rt}from"./FeatureStore-OMQPlh-S.js";import{L as Ct}from"./QueryEngine-pdhAoID6.js";import{y as kt,u as ve}from"./clientSideDefaults-C8pjUAkf.js";import{s as xt}from"./fieldProperties-DO9v7LnS.js";import{C as K,e as oe,n as At}from"./labelingInfo-C6cu4L4_.js";import{p as Ft,n as Ot,l as jt}from"./BlendLayer-DQc1-4op.js";import{a as qt,p as Gt,l as Pt}from"./DisplayFilteredLayer-Can002Zs.js";import{c as Ut,p as zt}from"./FeatureEffectLayer-B7oH4PZH.js";import{d as Bt,p as Ht}from"./FeatureReductionLayer-DBGKy5I4.js";import{p as Qt,c as Vt}from"./OrderedLayer-JMonx__F.js";import{f as Wt}from"./RefreshableLayer-D-fI9Hjo.js";import{t as Jt}from"./ScaleRangeLayer-59UbR5Hw.js";import{l as Yt,f as Zt}from"./TemporalLayer-3uOs5aS1.js";import{d as Kt,v as Xt,j as en,f as tn,l as nn}from"./commonProperties-BAQ0_iGY.js";import{y as ae}from"./Field-BLAoQZ_0.js";import{d as rn}from"./TimeInfo-CoJs_xDI.js";import{p as on}from"./SimpleRenderer-CnXOtoBL.js";import{fromJSON as De}from"./jsonUtils-Bfgh5fRb.js";import{m as an}from"./typeUtils-CM8gcbcJ.js";import{d as sn}from"./FeatureSet-BbkVLp0y.js";import{p as ln}from"./popupUtils-ChjfLide.js";import{g as Re}from"./utils-CwuU6R9D.js";let pn=class{constructor(){this.version="",this.queryResult=new dn}},dn=class{constructor(){this.featureResult=new cn}},cn=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new un,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new yn,this.geometryType=null,this.spatialReference=new nt,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new st,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},un=class{constructor(){this.name="",this.isSystemMaintained=!1}},yn=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},st=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new hn,this.translate=new mn}};class hn{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}let mn=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},fn=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},gn=class{constructor(){this.attributes=[],this.compressedGeometry=new be,this.centroid=new be,this.aggregateGeometries=[]}},be=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var X;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(X||(X={}));const bn=[X.ELEMENTUID,X.TYPENAME];var Ce,ke;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(Ce||(Ce={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(ke||(ke={}));var xe,Te,we,Z;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(xe||(xe={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(Te||(Te={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(we||(we={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(Z||(Z={}));function Tn(e){const t=new pn;t.version=e.version;const i=e.get_query_result();if(i.results_type.value!==0)throw new Error("Got a non-feature collection type");const n=i.get_feature_result(),r=t.queryResult.featureResult;r.objectIdFieldName=n.objectid_field_name,r.exceededTransferLimit=n.exceeded_transfer_limit,r.hasM=n.has_m,r.hasZ=n.has_z,r.geometryType=Ee[n.geometry_type.value],r.globalIdFieldName=n.globalid_field_name,r.geohashFieldName=n.geohash_field_name;const o=r.uniqueIdField,l=n.unique_id_field;o.name=l.name,o.isSystemMaintained=l.isSystemMaintained;const s=r.geometryProperties,y=n.geometry_properties;s.shapeAreaFieldName=y.shapeAreaFieldName,s.shapeLengthFieldName=y.shapeLengthFieldName,s.units=y.units;const a=r.spatialReference,p=n.spatial_reference;a.wkid=p.wkid,a.latestWkid=p.latestWkid,a.vcsWkid=p.vcsWkid,a.latestVcsWkid=p.latestVcsWkid,a.wkt=p.wkt,r.transform=In(n.transform);const c=r.fields,d=r.fieldNameToAttributeIndexMap,u=n.fields,f=u.size();for(let T=0;T<f;T++){const S=u.get(T),v=lt(S);c.push(v),d[v.name]=T,S.delete()}u.delete();const b=r.values,L=n.values_count();for(let T=0;T<L;T++)b.push(n.get_value_at(T));const $=r.features,N=n.features,_=N.size();if(_>0){for(const T of bn)if(d[T]===void 0)throw new Error(`Feature collection missing required attribute: ${T}`)}for(let T=0;T<_;T++){const S=new gn,v=N.get(T),j=S.attributes,q=v.attributes_count();for(let D=0;D<q;D++)j.push(v.get_attribute_at(D));const C=v.get_compressed_geometry();C&&(S.compressedGeometry=ye(C),S.centroid=ye(v.get_centroid()));const k=S.aggregateGeometries,R=v.aggregate_geometries,z=R.size();for(let D=0;D<z;D++){const W=R.get(D),ee=ye(W);k.push(ee),W.delete()}R.delete(),$.push(S),v.delete()}N.delete();const M=r.geometryFields,I=n.geometry_fields,g=I.size();for(let T=0;T<g;T++){const S=I.get(T),v=wn(S);M.push(v),S.delete()}return I.delete(),t}function ye(e){const t=new be;t.geometryType=Ee[e.geometry_type.value];const i=[],n=[];for(let r=0;r<e.lengths.length;r++)i.push(e.lengths[r]);for(let r=0;r<e.coords.length;r++)n.push(e.coords[r]);return t.lengths=i,t.coords=n,t}function lt(e){const t=new fn;return t.name=e.name,t.alias=e.alias,t.fieldType=Nt[e.field_type.value],t.sqlType=we[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function wn(e){const t=lt(e);return t.geometryType=Ee[e.geometry_type.value],t}function In(e){const t=new st;t.quantizeOriginPosition=Te[e.quantizeOriginPosition.value];const i=t.scale,n=e.scale;i.xScale=n.xScale,i.yScale=n.yScale,i.mScale=n.mScale,i.zScale=n.zScale;const r=t.translate,o=e.translate;return r.xTranslate=o.xTranslate,r.yTranslate=o.yTranslate,r.mTranslate=o.mTranslate,r.zTranslate=o.zTranslate,t}async function En(e){const t=[],i={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(Ae(e.entitiesUrl).then(n=>{Fe(n,i)})),e.relationshipsUrl&&t.push(Ae(e.relationshipsUrl).then(n=>{Fe(n,i)})),await Promise.all(t),i}async function xi(e,t){t??=!1;const i={generateAllSublayers:t,namedTypeDefinitions:new Map};return await $n(e).then(n=>{Sn(n,i)}),i}async function Ai(e){const t=await _e(),i=new t.MapOfObjectIdentifierSets;_n(i,t,e);const n=new t.MapOfObjectIdentifierSetsEncoder;try{n.set_map_of_identifier_sets(i),n.encode();const r=n.get_encoding_result();if(r.error.error_code!==0)throw new P("knowledge-graph:layer-support-utils",r.error.error_message);const o=structuredClone(r.get_byte_buffer());return n.delete(),o}finally{i.delete()}}function _n(e,t,i){for(const[n,r]of i.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const o=r.members.keys();let l=!1,s=!0;const y=new t.ObjectIdArray,a=new t.StringArray,p=new t.GlobalIdArray,c=new t.IdentifierArray,d=new t.ObjectIdentifierSet;for(const u of o)s&&(l=!isNaN(Number(u)),s=!1),l?y.add_objectid(Number(u)):(a.add_string(u),p.add_globalid(u)),c.add_identifier(u);d.set_oid_array(y),d.set_string_array(a),d.set_globalid_array(p),d.set_identifier_array(c),y.delete(),a.delete(),p.delete(),c.delete(),e.put_identifier_set(n,d),d.delete()}return e}async function Ae(e){const t=await it(e,{responseType:"array-buffer"});return Nn(await t.data)}async function Nn(e){const t=new(await _e()).FeatureCollectionDecoder,i=t.decode(new Uint8Array(e));if(i.error_code!==0)throw new P("knowledge-graph:layer-support-utils",i.error_message);const n=t.get_feature_collection(),r=Tn(n);return t.delete(),r}async function $n(e){const t=await it(e,{responseType:"array-buffer"}),i=await t.data;return Ln(new Uint8Array(i))}async function Ln(e){const t=new(await _e()).MapOfObjectIdentifierSetsDecoder,i=t.decode(new Uint8Array(e)),n=new Map;if(i.error_code!==0)throw new P("knowledge-graph:layer-support-utils",i.error_message);const r=t.get_map_of_identifier_sets(),o=r.keys,l=o.size();for(let s=0;s<l;s++){const y=o.get(s),a=r.query_identifier_set(y),p=[];if(a.id_array_type.value===Z.GLOBALID_ARRAY){const c=a.get_globalid_array(),d=c.count();for(let u=0;u<d;u++)p.push(c.get_globalid_at(u))}else if(a.id_array_type.value===Z.IDENTIFIER_ARRAY){const c=a.get_identifier_array(),d=c.count();for(let u=0;u<d;u++)p.push(c.get_identifier_at(u).toString())}else if(a.id_array_type.value===Z.STRING_ARRAY){const c=a.get_string_array(),d=c.count();for(let u=0;u<d;u++)p.push(c.get_string_at(u))}else{if(a.id_array_type.value!==Z.OID_ARRAY)throw new P("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const c=a.get_oid_array(),d=c.count();for(let u=0;u<d;u++)p.push(c.get_objectid_at(u).toString())}}n.set(y,p)}return t.delete(),n}function Fe(e,t){if(!e?.queryResult?.featureResult)return t;const i=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const n of e.queryResult.featureResult.features){const r=n.attributes[i[X.TYPENAME]],o=G(t.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map})),l=n.attributes[i[X.ELEMENTUID]];if(n.compressedGeometry?.coords?.length>0){let s=n.compressedGeometry.lengths;n.compressedGeometry.geometryType==="esriGeometryPoint"&&(s=[]),o.members.set(l,{id:l,linkChartLocation:new _t(s,n.compressedGeometry.coords)})}else o.members.set(l,{id:l})}return t}function Sn(e,t){for(const[i,n]of e){const r=G(t.namedTypeDefinitions,i,()=>({useAllData:!1,members:new Map}));for(const o of n)r.members.has(o)||r.members.set(o,{id:o})}return t}const Fi={fetchAndConvertSerializedLinkChart:e=>En(e)};let he=class V{constructor(){this._featureLookup=new Map}static getInstance(){return V.instance||(V.instance=new V),V.instance}static resetInstance(){V.instance&&(V.instance=null)}deleteFromStore(t){t.forEach(i=>{this._featureLookup.delete(i)})}readFromStoreByList(t){const i=[];return t.forEach(n=>{const r=this.readFromStoreById(n);r&&i.push(r)}),i}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,i,n){const r=[];return t.forEach(o=>{if(!o?.id)return;o.properties||(o.properties=[]);let l,s=null;if(n&&o.properties[n]&&(s=Lt(o.properties[n])),"originId"in o&&"destinationId"in o&&(o.properties[pe]=o.originId,o.properties[de]=o.destinationId),o.properties[i]=o.id,o.id&&this._featureLookup.has(o.id)&&this._featureLookup.get(o.id).attributes){const y=this._featureLookup.get(o.id),a=JSON.parse(JSON.stringify(Object.assign(y.attributes,o.properties)));n&&o.properties[n]&&(a[n]=ct(o.properties[n])),l=new Me(s?JSON.parse(JSON.stringify(s)):y?.geometry?JSON.parse(JSON.stringify(y.geometry)):null,a,null,o.properties[i])}else l=new Me(s?JSON.parse(JSON.stringify(s)):null,o.properties,null,o.properties[i]);this._featureLookup.set(`${o.typeName?`${o.typeName}__${o.id}`:o.id}`,l),r.push(l)}),r}},me,E=null;function Oi(){return me||(me=St(()=>import("./lclayout-d38TF2sa.js"),__vite__mapDeps([0,1]),import.meta.url).then(e=>e.l).then(({default:e})=>e({locateFile:t=>ut(`esri/libs/linkchartlayout/${t}`)})).then(e=>{Mn(e)}),me)}function Mn(e){E=e}var Oe,U,je,ce;(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot",e[e.IsOld=8]="IsOld"})(Oe||(Oe={})),function(e){e[e.Success=0]="Success",e[e.Error=1]="Error",e[e.Canceled=2]="Canceled"}(U||(U={})),function(e){e[e.Regular=0]="Regular",e[e.Curved=1]="Curved",e[e.Recursive=2]="Recursive"}(je||(je={})),function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom"}(ce||(ce={}));const qe={none:0,"start-only":1,"start-and-end":2};function vn(e){const t={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...e?.toJSON()??{},eventsTicksVisualization:e?.eventsTicksVisualization??"start-and-end"};return{...t,timeDirection:{value:ce[t.timeDirection]??ce.right},eventsTicksVisualization:{value:qe[t.eventsTicksVisualization]??qe["start-and-end"]}}}function H(e,t,i,n,r,o){const l=i.length,s=r.length,y=Float64Array.BYTES_PER_ELEMENT,a=Uint32Array.BYTES_PER_ELEMENT,p=Uint8Array.BYTES_PER_ELEMENT,c=16,d=c+l*(p+2*y)+s*(2*a),u=E._malloc(d);try{const f=u+c-u%c,b=f+l*y,L=b+l*y,$=L+s*a,N=$+s*a,_=()=>[E.HEAPF64.subarray(f>>3,(f>>3)+l),E.HEAPF64.subarray(b>>3,(b>>3)+l),E.HEAPU32.subarray(L>>2,(L>>2)+s),E.HEAPU32.subarray($>>2,($>>2)+s),E.HEAPU8.subarray(N,N+l)],[M,I,g,T,S]=_();M.set(i),I.set(n),g.set(r),T.set(o),S.set(t);const v=e(l,N,f,b,s,L,$);let j=null,q=null;if(v.value===U.Success){const W=E.getLayoutLinksTypes(),ee=E.getLayoutLinksVerticesEndIndices(),ue=E.getLayoutLinksVertices(),$e=E.countLayoutLinksVertices();!s||W&&ee?$e&&!ue?v.value=U.Error:(j={types:new Uint8Array(E.HEAPU8.subarray(W,W+s)),vertexEndIndex:new Uint32Array(E.HEAPU32.subarray(ee>>2,(ee>>2)+s)),vertices:new Float64Array(E.HEAPF64.subarray(ue>>3,(ue>>3)+2*$e))},q=E.getAuxiliaryGraphicElements()):v.value=U.Error}const[C,k,R,z,D]=_();return i.set(C),n.set(k),r.set(R),o.set(z),t.set(D),{status:v.value,links:j,graphics:q}}finally{E._free(u),E.cleanupLayout()}}const Ge=2,Pe=1,Ue=-1;var ze,Be,He,Qe,Ve,We,Je,Ye,Ze;(function(e){function t(){return E.getMinIdealEdgeLength()}function i(n,r,o,l,s,y,a=Ge,p=Pe,c=Ue){return H((d,u,f,b,L,$,N)=>E.applyForceDirectedLayout(n,d,u,f,b,L,$,N,a,p,c),r,o,l,s,y)}e.getMinIdealEdgeLength=t,e.apply=i})(ze||(ze={})),function(e){function t(i,n,r,o,l,s,y=Ge,a=Pe,p=Ue){return H((c,d,u,f,b,L,$)=>E.applyCommunityLayout(i,c,d,u,f,b,L,$,y,a,p),n,r,o,l,s)}e.apply=t}(Be||(Be={})),function(e){function t(i,n,r,o,l,s){return H((y,a,p,c,d,u,f)=>E.applySimpleLayout(i,y,a,p,c,d,u,f),n,r,o,l,s)}e.apply=t}(He||(He={})),function(e){function t(i,n,r,o,l,s){return H((y,a,p,c,d,u,f)=>E.applyHierarchicalLayout(i,y,a,p,c,d,u,f),n,r,o,l,s)}e.apply=t}(Qe||(Qe={})),function(e){function t(i,n,r,o,l,s){return H((y,a,p,c,d,u,f)=>E.applyRadialTreeLayout(i,y,a,p,c,d,u,f),n,r,o,l,s)}e.apply=t}(Ve||(Ve={})),function(e){function t(i,n,r,o,l,s){return H((y,a,p,c,d,u,f)=>E.applySmartTreeLayout(i,y,a,p,c,d,u,f),n,r,o,l,s)}e.apply=t}(We||(We={})),function(e){function t(i,n,r,o,l,s,y,a,p,c,d,u){return H((f,b,L,$,N,_,M)=>{if(l.length!==f)return{value:U.Error};if(s.length!==f)return{value:U.Error};if(p.length!==N)return{value:U.Error};if(c.length!==N)return{value:U.Error};const I=Float64Array.BYTES_PER_ELEMENT,g=16,T=E._malloc(g+f*I),S=E._malloc(g+f*I),v=E._malloc(g+N*I),j=E._malloc(g+N*I),q=T+g-T%g,C=S+g-S%g,k=v+g-v%g,R=j+g-j%g;try{return E.HEAPF64.subarray(q>>3,(q>>3)+f).set(l),E.HEAPF64.subarray(C>>3,(C>>3)+f).set(s),E.HEAPF64.subarray(k>>3,(k>>3)+N).set(p),E.HEAPF64.subarray(R>>3,(R>>3)+N).set(c),E.applyChronologicalLayout(i,f,b,L,$,q,C,N,_,M,k,R,d,vn(u))}finally{E._free(T),E._free(S),E._free(v),E._free(j)}},n,r,o,y,a)}e.apply=t}(Je||(Je={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Ye||(Ye={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Ze||(Ze={}));rt()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"});rt()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Dn=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function Rn(e,t){const i=new Map;if(t.dataModel?.relationshipTypes)for(const n of t.dataModel.relationshipTypes)n.name&&i.set(n.name,[]);for(const n of e)i.has(n.typeName)&&i.get(n.typeName)?.push(n.id);return i}async function ji(e,t,i){const n=[],r=Rn(e,t),o={},l=[];for(const[p,c]of r){if(c.length<1)continue;const d=`${p}_ids`;o[d]=c,l.push(`MATCH (n)-[r:${p}]->(m) WHERE id(r) in $${d} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(l.length===0)return[];const s=l.join(" UNION "),y=new Q({openCypherQuery:s,bindParameters:o}),a=(await J(t,y,i?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:p,value:c}=await a.read();if(p)break;for(const d of c)n.push({id:d[0],typeName:d[1]}),n.push({id:d[2],typeName:d[3]})}return n}const qi=e=>Dn.get(e)??"radial-root-centric";function Cn(e){if(!e.spatialReference.isWGS84)throw new P("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]])}let F=class extends yt{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(i=>{i.name&&(t.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach(n=>{n.geometryType&&n.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:n.name??"",geometryType:n.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(i=>{i.name&&(t.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach(n=>{n.geometryType&&n.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:n.name??"",geometryType:n.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((i,n)=>{if(t.get(n)==="entity")this.entityTypeNames.add(n);else{if(t.get(n)!=="relationship")return ot.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(n);this.relationshipTypeNames.add(n)}const r=new Map;i.members?.forEach(o=>{G(this.memberIdTypeLookup,o.id,()=>new Set).add(n);const l=this.getById(o.id);l&&r.set(o.id,l)}),this.sublayerCaches.set(n,r)})}addToLayer(e){e.forEach(({typeName:t,id:i})=>{if(!this.inclusionModeDefinition)throw new P("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(t);n.members||(n.members=new Map),n.members.set(i,{id:i}),G(this.memberIdTypeLookup,i,()=>new Set).add(t)}}else{const n=new Map;n.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:n}),G(this.memberIdTypeLookup,i,()=>new Set).add(t)}})}getById(e){return he.getInstance().readFromStoreById(e)}async getData(e,t,i){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let n;if(n=e||new Y({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const r=t.parentCompositeLayer,o=this._processingCacheUpdatesLookup.get(t.objectType.name??""),l=n.outFields;l&&l.length===1&&l[0]===O&&n.where==="1=1"||await Promise.all(o??[]);const s=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],y=[];return s.forEach(a=>{if(this.relationshipTypeNames.has(t.objectType.name)){a.geometry=r.relationshipLinkChartDiagramLookup.get(a.attributes[t.objectIdField]);const p=this.memberIdTypeLookup.get(a.attributes[pe]),c=this.memberIdTypeLookup.get(a.attributes[de]),d=this._isEndEntitySpatial(p,a,pe),u=this._isEndEntitySpatial(c,a,de);a.attributes[re]=Number(d&&u)}else{a.geometry=r.entityLinkChartDiagramLookup.get(a.attributes[t.objectIdField]);const p=this.geographicLookup.get(t.objectType.name);p&&a.attributes[p.name]?a.attributes[re]=1:a.attributes[re]=0}a.attributes[Ne]=a.geometry,y.push(a)}),y}return this.retrieveDataFromService(n,t,i)}async getConnectedRecordIds(e,t,i){const n=[];let r="";const o=this._getNamedTypeIdMapFromNodeIds(e);if(t&&t?.length!==0){for(const p of t)r=r+p+"|";r=r.slice(0,-1)}const l={},s=[];for(const[p,c]of o){const d=`${p}_ids`;l[d]=c,t&&t?.length!==0?s.push(`MATCH (n:${p}) WHERE id(n) IN $${d} WITH n MATCH (n)-[r:${r}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):s.push(`MATCH (n:${p}) WHERE id(n) IN $${d} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!s.length)return n;const y=s.join(" UNION "),a=(await J(this.knowledgeGraph,new Q({openCypherQuery:y,bindParameters:l}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:p,value:c}=await a.read();if(p)break;for(let d=0;d<c.length;d++){const u=c[d];n.push({id:u[0],typeName:u[1]}),n.push({id:u[2],typeName:u[3]})}}return n}async getRelationshipsBetweenNodes(e,t,i){const n=this._getNamedTypeIdMapFromNodeIds(e);if(n.size===0)return[];const r={relationshipExclusionIds:t,possibleConnectionEntityIds:e},o=[];for(const[a,p]of n.entries()){const c=`${a}_ids`;r[c]=p,o.push(`MATCH (n:${a}) WHERE id(n) IN $${c} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const l=o.join(" UNION "),s=[],y=(await J(this.knowledgeGraph,new Q({openCypherQuery:l,bindParameters:r}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:a,value:p}=await y.read();if(a)break;for(let c=0;c<p.length;c++){const d=p[c];s.push({id:d[0],typeName:d[1]})}}return s}async getRelationshipsFromNodes(e,t,i,n){const r=this._getNamedTypeIdMapFromNodeIds(e);if(r.size===0||t.length===0)return[];const o={relationshipExclusionIds:i,possibleConnectionEntityIds:t},l=[];for(const[c,d]of r.entries()){const u=`${c}_ids`;o[u]=d,l.push(`MATCH (n:${c}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const s=l.join(" UNION "),y=new Map,a=(await J(this.knowledgeGraph,new Q({openCypherQuery:s,bindParameters:o}),{signal:n?.signal})).resultRowsStream.getReader();for(;;){const{done:c,value:d}=await a.read();if(c)break;for(let u=0;u<d.length;u++){const f=d[u];let b=y.get(f[1]);b||(b=new Set,y.set(f[1],b)),b.add(f[0])}}const p=[];for(const[c,d]of y)for(const u of d)p.push({id:u,typeName:c});return p}async refreshCacheContent(e,t,i,n=!0,r){const o=he.getInstance(),l=[],s=new Map,y=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&y.set(a.name,a)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&y.set(a.name,a)}),e||this.inclusionModeDefinition?e?e.forEach(a=>{if(this.memberIdTypeLookup.has(a))for(const p of this.memberIdTypeLookup.get(a))s.has(p)?s.get(p)?.push(a):s.set(p,[a])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,p)=>{a.useAllData?s.set(p,null):a.members&&a.members.forEach(c=>{s.has(p)&&s.get(p)!==null?s.get(p)?.push(c.id):s.set(p,[c.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&s.set(a.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&s.set(a.name,null)}));for(const[a,p]of s){const c=new Set(p),d=new Promise((u,f)=>{(async()=>{const L=new Set,$=[];let N,_="",M=!1;if(t||y.get(a)?.properties?.forEach(T=>{T.name&&L.add(T.name)}),i&&this.geographicLookup.has(a)){const T=this.geographicLookup.get(a)?.name;T&&L.add(T)}if(this.entityTypeNames.has(a))_=`MATCH (n:${a}) ${p?"WHERE id(n) IN $ids ":""}return ID(n)`,L.forEach(T=>{_+=`, n.${T}`,$.push(T)});else{if(!this.relationshipTypeNames.has(a))throw new P("knowledge-graph:layer-data-manager",`The graph type of ${a} could not be determined. Was this type set in the KG data model and inclusion definition?`);M=!0,_=`MATCH ()-[n:${a}]->() ${p?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,L.forEach(T=>{_+=`, n.${T}`,$.push(T)})}N=new Q(p?{openCypherQuery:_,bindParameters:{ids:p}}:{openCypherQuery:_});const I=(await J(this.knowledgeGraph,N,{signal:r?.signal})).resultRowsStream.getReader();for(;;){const{done:T,value:S}=await I.read();if(T)break;const v=[];for(let C=0;C<S.length;C++){const k=S[C];let R=0,z=0;const D={properties:{}};for(D.id=k[R],R++,z++,M&&(D.originId=k[R],R++,z++,D.destinationId=k[R],R++,z++,G(this.nodeConnectionsLookup,D.originId,()=>new Set).add(D.id),G(this.nodeConnectionsLookup,D.destinationId,()=>new Set).add(D.id),G(this.relationshipConnectionsLookup,D.id,()=>[D.originId,D.destinationId]));R<k.length;R++)D.properties[$[R-z]]=k[R];c.delete(D.id),v.push(D)}const j=o.writeToStore(v,O,this.geographicLookup.get(a)?.name);this.sublayerCaches.has(a)||this.sublayerCaches.set(a,new Map),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(a)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(a,{useAllData:!1,members:new Map}),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(a).members=new Map);const q=this.sublayerCaches.get(a);j.forEach(C=>{q?.set(C.attributes[O],C),n&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.has(C.attributes[O])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.set(C.attributes[O],{id:C.attributes[O]}),G(this.memberIdTypeLookup,C.attributes[O],()=>new Set).add(a))})}const g=this.inclusionModeDefinition?.namedTypeDefinitions.get(a);if(g)for(const T of c)g.members?.delete(T)})().then(()=>{u(null)}).catch(L=>{L.name==="AbortError"?u(null):f(L)})});l.push(d),this._processingCacheUpdatesLookup.get(a)?.push(d)}if(await Promise.all(l),r?.signal?.aborted)throw ht()}removeFromLayer(e){const t=new Set,i=new Set(e.map(n=>n.id));for(const n of e)t.add(n.typeName),this.memberIdTypeLookup.get(n.id)?.size===1?this.memberIdTypeLookup.delete(n.id):this.memberIdTypeLookup.get(n.id)?.delete(n.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((r,o)=>{o===n.typeName&&r.members?.has(n.id)&&r.members.delete(n.id)});t.forEach(n=>{this.sublayerCaches.get(n)?.forEach((r,o)=>{i.has(o)&&this.sublayerCaches.get(n)?.delete(o)})})}async retrieveDataFromService(e,t,i){const n=he.getInstance(),r=new Set,o=[];let l,s="",y=[];const a=t.graphType==="relationship",p=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,c=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let d=!p&&c?Array.from(c).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&e.objectIds!=null&&(d=e.objectIds);else if(e.objectIds!=null&&d&&d.length>0){const f=e.objectIds;e.objectIds=d.filter(b=>f.includes(b))}else if(e.objectIds!=null)d=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=d}if(e.outFields!=null){const f=e.outFields;f.includes("*")?t.fields.forEach(b=>{r.add(b.name)}):f.forEach(b=>{b!==O&&b!==t.geometryFieldName&&r.add(b)})}if(e.geometry!=null){const f=e.geometry;let b;const L=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,$=L?.spatialReference,N=L?.serviceCapabilities?.geometryCapabilities;let _=N?.geometryMaxBoundingRectangleSizeX,M=N?.geometryMaxBoundingRectangleSizeY;if(f.type==="point"){let I=f;I.spatialReference?.isWGS84||(await fe(I.spatialReference,B),I=se(I,B)),b=new le({spatialReference:B,xmin:I.x-1e-4,ymin:I.y-1e-4,xmax:I.x+1e-4,ymax:I.y+1e-4})}else f?.extent?.spatialReference&&!f.spatialReference?.isWGS84?(await fe(f.extent.spatialReference,B),b=se(f.extent,B)):b=f.extent;if(_&&M&&$){if($.wkid!==4326){const I=new le({spatialReference:$,xmax:_,ymax:M}),g=se(I,B);_=g.xmax,M=g.ymax}if(b.xmax-b.xmin>_)throw new P("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${_}° latitude, limit exceeded`);if(b.ymax-b.ymin>M)throw new P("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${M}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const I=await Le(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(g=>{I.fieldNames.includes(g.name)&&r.add(g.name)})}s=a?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(I=>{s+=`, n.${I}`,o.push(I)}),l=new Q({openCypherQuery:s,bindParameters:{param_filter_geom:new at({rings:Cn(b)})}})}else{let f="";if(e.where!=null&&e.where!=="1=1"){const $=await Le(e.where,t.fieldsIndex);t.fields.forEach(g=>{$.fieldNames.includes(g.name)&&r.add(g.name)});const N=new Set(["column-reference","string","number","binary-expression"]),_=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let M=!1;const I=g=>{if(g.type==="column-reference")return`n.${g.column}`;if(g.type==="string")return`'${g.value}'`;if(g.type==="number")return`${g.value}`;if(g.type==="binary-expression"&&N.has(g.left.type)&&N.has(g.right.type)&&_.has(g.operator))return`${I(g.left)} ${g.operator} ${I(g.right)}`;if(g.type==="binary-expression"&&g.operator==="LIKE"){let T="";if(g.left.type==="function"&&g.left.args.value[0].type==="column-reference")T+=`lower(n.${g.left.args.value[0].column})`;else{if(g.left.type!=="column-reference")return M=!0,"";T+=`lower(n.${g.left.column})`}if(T+=" CONTAINS (",g.right.type!=="string")return M=!0,"";{let S=g.right.value;S.charAt(0)==="%"&&(S=S.slice(1)),S.charAt(S.length-1)==="%"&&(S=S.slice(0,-1)),T+=`'${S.toLowerCase()}')`}return T}return M=!0,""};f=I($.parseTree),M&&(f="")}let b="";b=a?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let L=!1;d&&(L=!0,b+=" WHERE ID(n) IN $ids"),f&&(b+=L?" AND":" WHERE",b+=` ${f}`),b+=" return ID(n)",a&&(b+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach($=>{b+=`, n.${$}`,o.push($)}),l=new Q(d?{openCypherQuery:b,bindParameters:{ids:d}}:{openCypherQuery:b})}const u=(await J(t.parentCompositeLayer.dataManager.knowledgeGraph,l,i)).resultRowsStream.getReader();for(;;){const{done:f,value:b}=await u.read();if(f)break;const L=[];for(let $=0;$<b.length;$++){const N=b[$];let _=0,M=0;const I={properties:{}};for(I.id=N[_],_++,M++,a&&(I.originId=N[_],_++,M++,I.destinationId=N[_],_++,M++);_<N.length;_++)I.properties[o[_-M]]=N[_];L.push(I)}y=y.concat(n.writeToStore(L,O,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return y}_isEndEntitySpatial(e,t,i){for(const n of e??[])if(this.entityTypeNames.has(n)){const r=this.geographicLookup.get(n),o=r&&this.sublayerCaches.get(n)?.get(t.attributes[i]);if(r&&o?.attributes[r.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const t=new Map;return e.forEach(i=>{if(this.memberIdTypeLookup.has(i))for(const n of this.memberIdTypeLookup.get(i)){if(!this.entityTypeNames.has(n))return;t.has(n)?t.get(n)?.push(i):t.set(n,[i])}}),t}};h([m()],F.prototype,"knowledgeGraph",void 0),h([m()],F.prototype,"inclusionModeDefinition",void 0),h([m()],F.prototype,"entityTypeNames",void 0),h([m()],F.prototype,"relationshipTypeNames",void 0),h([m()],F.prototype,"geographicLookup",void 0),h([m()],F.prototype,"sublayerCaches",void 0),h([m()],F.prototype,"nodeConnectionsLookup",void 0),h([m()],F.prototype,"relationshipConnectionsLookup",void 0),h([m()],F.prototype,"memberIdTypeLookup",void 0),F=h([Ie("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],F);const Ke=xt(),kn=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return h([m(Ke.fields)],t.prototype,"fields",void 0),h([m(Ke.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=h([Ie("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t},xn={initializeLayersFromClientData:async(e,t,i)=>{if(t||(t=[...e.layers,...e.tables].map(o=>o.graphTypeName)),t?.length===0)return;const n=new Map;for(const o of t)n.set(o,Xe(e,o));const r=await $t(e.dataManager.knowledgeGraph,Array.from(n.values()),{requestOptions:{signal:i?.signal}});for(const o of[...e.layers,...e.tables]){const l=o.objectType.name;if(l==null)continue;const s=r.get(Xe(e,l));if(s){const y=JSON.parse(s);y===null||typeof y!="object"||y.hasOwnProperty("showLabels")||(y.showLabels=!1),o.read(y,{origin:"service"})}}}},Xe=(e,t)=>e.type==="knowledge-graph"?`${t}/Map`:`${t}/LinkChart/LinkChartSubLayer`;async function Gi(e,t,i){return xn.initializeLayersFromClientData(e,t,i)}const et=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],An="#8f8f82";function Fn(e){return e<0||e>=et.length?new Se(An):new Se(et[e])}function On(e){const t=e.toArray();return new mt({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:t},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:t}]}}]}]}}})}function jn(e){let t="ESRI__ID",i=4;for(const n of e)if(n.name){if(n.name.toLowerCase()==="name"){t=n.name;break}n.name.toLowerCase().includes("name")?(t=n.name,i=2):n.fieldType==="esriFieldTypeString"&&i>3&&(t=n.name,i=3)}return t}function qn(e,t,i){const n={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},r=new K({labelExpressionInfo:new oe({expression:i==="ESRI__ID"?`${t}`:`$feature.${i}`}),labelPlacement:"above-center",symbol:new ie(n)}),o=new K({labelExpressionInfo:new oe({expression:`'${t}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new ie({...n,yoffset:"12px"})});return e==="entity"?[r]:[o]}function Gn(e,t,i){const n={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},r=i==="ESRI__ID"?`${e}`:`$feature.${i}`;return t==="point"?[new K({labelExpressionInfo:new oe({expression:r}),labelPlacement:"above-center",symbol:new ie(n)})]:t==="polyline"?[new K({labelExpressionInfo:new oe({expression:r}),labelPlacement:"center-along",repeatLabel:!0,symbol:new ie(n)})]:t==="polygon"?[new K({labelExpressionInfo:new oe({expression:r}),labelPlacement:"always-horizontal",symbol:new ie(n)})]:null}function A(e){if(!e.json)return e;e.json.write=tt(e.json.write);const t=e.json.origins;if(!t)return e;let i;for(i in t){const n=t[i];n&&(n.write=tt(n.write))}return e}function tt(e){return typeof e=="object"&&e?(e.enabled!==!1&&(e.overridePolicy=Pn(e)),e):e===!0?ne():e}function Pn(e){const{target:t,writer:i,overridePolicy:n,...r}=e;return function(o,l){const s=pt.call(this,o,l);return s.enabled?{...r,...s}:s}}function ne(){return{overridePolicy:pt}}function pt(e,t){const i=!!this.geometryType;let n={enabled:i};return i&&(n={...n,...dt.call(this,e,t)}),n}function dt(e,t){return{ignoreOrigin:this.originIdOf(t)>Et.DEFAULTS}}let w=class extends kn(qt(Bt(Ut(Ft(Qt(Yt(Jt(Wt(Mt(Dt)))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=kt(!1,!1),this.charts=null,this.definitionExpression=null,this.displayField="",this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=O,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new vt(t.port1,{channel:t,client:{queryFeatures:(i,n={})=>{const r=Y.fromJSON(i);return this.queryFeaturesJSON(r,n)}}}),[t.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){const e=[];return this.objectType?.properties?.forEach(t=>{const i=t.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":t.fieldType;e.push(ae.fromJSON({name:t.name,type:i,alias:t.alias,defaultValue:t.defaultValue,editable:t.editable,nullable:t.nullable}))}),e.push(ae.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),ae.fromJSON({name:ge,type:"esriFieldTypeInteger",alias:ge,editable:!1}),ae.fromJSON({name:re,type:"esriFieldTypeInteger",alias:re,editable:!1})),e}get geometryType(){if(this.parentCompositeLayer?.type==="link-chart")return this.graphType==="relationship"?"polyline":"point";const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.geometryType;return t&&t!=="esriGeometryNull"?te.fromJSON(t):null}get geometryFieldName(){return this.parentCompositeLayer?.type==="link-chart"?Ne:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphTypeName(){return this.objectType?.name}get hasM(){const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name;return(t?this.objectType?.properties?.[t]:null)?.hasM??!1}get hasZ(){const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name;return(t?this.objectType?.properties?.[t]:null)?.hasZ??!1}set labelingInfo(e){this._set("labelingInfo",e)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");const e=this.objectType.properties?jn(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?qn(this.graphType,this.graphTypeName,e):Gn(this.graphTypeName,this.geometryType,e)}set renderer(e){ft(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const e=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,t=[...e?.entityTypes??[],...e?.relationshipTypes??[]].map(r=>r.name).indexOf(this.graphTypeName),i=Fn(t);if(this.parentCompositeLayer?.type==="link-chart"){if(this.graphType==="relationship")return new on({type:"simple",symbol:On(i)});const r=De(ve(te.toJSON("point")).renderer);return Re(r.symbol,i),r}const n=De(ve(te.toJSON(this.geometryType)).renderer);return Re(n.symbol,i),n}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??nt.WGS84}set timeInfo(e){this._set("timeInfo",e)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(e){this._set("title",e)}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return ln(this,e)}createQuery(){return new Y({where:"1=1",outFields:["*"]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return null}async queryFeatures(e,t){await this.load();const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e),r=sn.fromJSON(await n.executeQuery(i.toJSON(),t?.signal));return r.features.forEach(o=>{o.sourceLayer=this}),r}async queryFeaturesJSON(e,t){await this.load();const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return await n.executeQuery(i.toJSON(),t?.signal)}async queryFeatureCount(e,t){await this.load();const{resolvedQuery:i,queryEngine:n}=await this._setupQueryObjects(e);return n.executeQueryForCount(i.toJSON(),t?.signal)}async queryExtent(e={},t){await this.load();const i={...e,returnGeometry:!0},{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(i),o=await r.executeQueryForExtent(n.toJSON(),t?.signal);let l;return l=o.extent?.xmin!=null&&o.extent?.xmax!=null&&o.extent?.ymin!=null&&o.extent?.ymax!=null?new le(o.extent):new le,{count:o.count,extent:l}}async queryObjectIds(e,t){await this.load();const i=Y.from(e);let n;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const r=await this.parentCompositeLayer.dataManager.getData(i,this,t);n=this.loadQueryEngine(r)}return await n.executeQueryForIds(i.toJSON(),t?.signal)}loadQueryEngine(e){const t=new Rt({geometryType:te.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),i=new Ct({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:te.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:t});return i.featureStore.addMany(e),i}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new Y({where:"1=1",outFields:[O]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>gt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){const i=Y.from(e),n=i.geometry;if(n&&!n.spatialReference?.isWGS84&&(await fe(n.spatialReference,B),i.geometry=se(n instanceof at||n instanceof bt||n instanceof Tt?n:n.extent,B)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:i,queryEngine:this._cachedQueryEngine};const r=await this.parentCompositeLayer.dataManager.getData(i,this,t);return{resolvedQuery:i,queryEngine:this.loadQueryEngine(r)}}};h([m(A(x(Ot)))],w.prototype,"blendMode",void 0),h([m()],w.prototype,"capabilities",void 0),h([m({json:{origins:{"web-scene":{write:!1}},write:ne()}})],w.prototype,"charts",void 0),h([m({readOnly:!0})],w.prototype,"defaultPopupTemplate",null),h([m({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],w.prototype,"definitionExpression",void 0),h([m()],w.prototype,"displayField",void 0),h([m(A(x(Gt)))],w.prototype,"displayFilterEnabled",void 0),h([m(A(x(Pt)))],w.prototype,"displayFilterInfo",void 0),h([m(A(x(jt)))],w.prototype,"effect",void 0),h([m()],w.prototype,"elevationInfo",void 0),h([m(A(x(zt)))],w.prototype,"featureEffect",void 0),h([m(A(x(Ht)))],w.prototype,"featureReduction",null),h([m()],w.prototype,"fields",null),h([m()],w.prototype,"geometryType",null),h([m()],w.prototype,"geometryFieldName",null),h([m({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],w.prototype,"graphType",void 0),h([m({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],w.prototype,"graphTypeName",null),h([m()],w.prototype,"hasM",null),h([m()],w.prototype,"hasZ",null),h([m({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],w.prototype,"id",void 0),h([m({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],w.prototype,"labelsVisible",void 0),h([m({type:[K],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:Un,write:ne()}})],w.prototype,"labelingInfo",null),h([m({readOnly:!0,json:{read:!1,write:{writer(e,t){switch(this.parentCompositeLayer?.type){case"link-chart":t.layerType="LinkChartSubLayer";break;case"knowledge-graph":t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],w.prototype,"layerType",void 0),h([m(A(x(Kt)))],w.prototype,"legendEnabled",void 0),h([m(A(x(Xt)))],w.prototype,"maxScale",void 0),h([m(A(x(en)))],w.prototype,"minScale",void 0),h([m()],w.prototype,"objectIdField",void 0),h([m()],w.prototype,"objectType",void 0),h([m(A(x(tn)))],w.prototype,"opacity",void 0),h([m(A(x(Vt)))],w.prototype,"orderBy",void 0),h([m({clonable:!1})],w.prototype,"parent",void 0),h([m()],w.prototype,"parentCompositeLayer",void 0),h([m(A(x(nn)))],w.prototype,"popupEnabled",void 0),h([m({type:wt,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],w.prototype,"popupTemplate",void 0),h([m({type:Number,json:{write:{overridePolicy:dt}}})],w.prototype,"refreshInterval",void 0),h([m({types:an,json:{name:"layerDefinition.drawingInfo.renderer",write:ne()}})],w.prototype,"renderer",null),h([m()],w.prototype,"source",void 0),h([m()],w.prototype,"spatialReference",null),h([m({type:rn,json:{name:"layerDefinition.timeInfo",write:!0,origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:!0},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:!0}}}})],w.prototype,"timeInfo",null),h([m({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],w.prototype,"title",null),h([It("title")],w.prototype,"writeTitle",null),h([m({json:{read:!1}})],w.prototype,"type",void 0),h([m(A(x(Zt)))],w.prototype,"useViewTime",void 0),h([m({type:Boolean,json:{name:"visibility",write:ne()}})],w.prototype,"visible",void 0),w=h([Ie("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],w);const Pi=w;function Un(e,t,i){const n=[["ESRI__AGGREGATION_COUNT",ge],["ESRI__ORIGIN_ID",pe],["ESRI__DESTINATION_ID",de],["ESRI__LAYOUT_GEOMETRY",Ne]];try{for(const r of e)for(const[o,l]of n)r.labelExpression=r.labelExpression?.replaceAll(o,l),r.labelExpressionInfo?.expression&&(r.labelExpressionInfo.expression=r.labelExpressionInfo.expression.replaceAll(o,l))}catch(r){ot.getLogger(this).warn("Error updating labelingInfo",r)}return At(e,t,i)}export{Be as A,qi as C,Fi as D,F as E,Qe as P,Pi as S,Ve as _,Je as a,He as b,We as c,Oe as d,Oi as e,he as f,ji as g,Ai as h,Gi as i,xi as m,U as o,je as u,ze as v};
