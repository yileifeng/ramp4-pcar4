const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./loader-BV2EUuyx.js","./main-asQ7SttR.js","./preload-helper-ExcqyqRp.js","./main-DmIi68wH.css","./mat4f64-Dk4dwAN8.js","./enums-Dk3osxpS.js","./Version-CCEYPWOm.js","./mat4-BjwS19gr.js","./common-DQOJ18NT.js","./quat-sVWee8SJ.js","./mat3f64-q3fE-ZOt.js","./quatf64-aQ5IuZRd.js","./vec32-BzCy6cr7.js","./vec42-CKs01hkn.js","./BufferView-CVke7kmB.js","./vec2-maR1OrZI.js","./resourceUtils-1clqqMwN.js","./basicInterfaces-CZwQPxTp.js"])))=>i.map(i=>d[i]);
import{_ as xe}from"./preload-helper-ExcqyqRp.js";import{_ as se,a4 as ge,Z as ne,s as ye,du as H,fi as oe,hs as q,n as Te,f9 as K,ck as ae,aK as D}from"./main-asQ7SttR.js";import{a as be}from"./devEnvironmentUtils-8WtPGj6h.js";import{i as Z,j as we,n as ve}from"./mat3-CruJiiUv.js";import{t as V,e as ie}from"./mat3f64-q3fE-ZOt.js";import{h as $e}from"./mat4-BjwS19gr.js";import{e as Re}from"./mat4f64-Dk4dwAN8.js";import{s as Ae}from"./vec2f64-DohEyf3f.js";import{E as Q,c as Me,i as Y,r as Be,A as Se,I as Ee}from"./vec32-BzCy6cr7.js";import{N as ue,f as le,n as j}from"./Geometry-BYkWVgnK.js";import{c as ce,x as Ie,L as Oe,i as me,O as Pe,E as _e}from"./BufferView-CVke7kmB.js";import{r as Ce,n as ke,d as J,l as X}from"./vec3-BljYTnyZ.js";import{o as Fe,d as ee}from"./vec4-CXYpzYPq.js";import{n as Ue,o as Le,a as je}from"./indexUtils-Dyp7cAat.js";import{n as G}from"./resourceUtils-1clqqMwN.js";import{i as qe,f as Ne}from"./vec2f32-BbH2jxlN.js";import{u as De}from"./memoryEstimations-COo-dz1M.js";import{t as Ve}from"./NestedMap-CImDozOA.js";import{r as fe}from"./Version-CCEYPWOm.js";import{o as Ge}from"./Indices-Vgv1m-UC.js";import{t as ze}from"./requestImageUtils-DZzdNdYu.js";import{t as C}from"./orientedBoundingBox-BH0jY8bO.js";import{e as z,i as R,n as We}from"./basicInterfaces-CZwQPxTp.js";import{e as O}from"./VertexAttribute-Cq4MnHjR.js";import{z as N,s as He,t as Ke,n as Ze,o as Qe}from"./DefaultMaterial-IOvhxCYs.js";import{D as te}from"./enums-Dk3osxpS.js";import{a as re}from"./NormalAttribute.glsl-C7KdSkvm.js";function F(t){if(t==null)return null;const e=t.offset!=null?t.offset:qe,n=t.rotation!=null?t.rotation:0,r=t.scale!=null?t.scale:Ne,c=V(1,0,0,0,1,0,e[0],e[1],1),i=V(Math.cos(n),-Math.sin(n),0,Math.sin(n),Math.cos(n),0,0,0,1),o=V(r[0],0,0,0,r[1],0,0,0,1),l=ie();return Z(l,i,o),Z(l,c,l),l}class Ye{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class Je{constructor(e,n,r){this.name=e,this.lodThreshold=n,this.pivotOffset=r,this.stageResources=new Ye,this.numberOfVertices=0}}const M=()=>Te.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class Xe{constructor(e,n,r){this.resource=e,this.textures=n,this.cachedMemory=r}}async function et(t,e){const n=await tt(t,e),r=await at(n.textureDefinitions??{},e);let c=0;for(const i in r)if(r.hasOwnProperty(i)){const o=r[i];c+=o?.image?o.image.width*o.image.height*4:0}return new Xe(n,r,c+De(n))}async function tt(t,e){const n=e?.streamDataRequester;if(n)return rt(t,n,e);const r=await se(ge(t,e));if(r.ok===!0)return r.value.data;ne(r.error),de(r.error)}async function rt(t,e,n){const r=await se(e.request(t,"json",n));if(r.ok===!0)return r.value;ne(r.error),de(r.error.details.url)}function de(t){throw new ye("",`Request for object resource failed: ${t}`)}function st(t){const e=t.params,n=e.topology;let r=!0;switch(e.vertexAttributes||(M().warn("Geometry must specify vertex attributes"),r=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=e.faces;if(i){if(e.vertexAttributes)for(const o in e.vertexAttributes){const l=i[o];l?.values?(l.valueType!=null&&l.valueType!=="UInt32"&&(M().warn(`Unsupported indexed geometry indices type '${l.valueType}', only UInt32 is currently supported`),r=!1),l.valuesPerElement!=null&&l.valuesPerElement!==1&&(M().warn(`Unsupported indexed geometry values per element '${l.valuesPerElement}', only 1 is currently supported`),r=!1)):(M().warn(`Indexed geometry does not specify face indices for '${o}' attribute`),r=!1)}}else M().warn("Indexed geometries must specify faces"),r=!1;break}default:M().warn(`Unsupported topology '${n}'`),r=!1}t.params.material||(M().warn("Geometry requires material"),r=!1);const c=t.params.vertexAttributes;for(const i in c)c[i].values||(M().warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function nt(t,e){const n=new Array,r=new Array,c=new Array,i=new Ve,o=t.resource,l=fe.parse(o.version||"1.0","wosr");ut.validate(l);const s=o.model.name,a=o.model.geometries,u=o.materialDefinitions??{},m=t.textures;let h=0;const x=new Map;for(let d=0;d<a.length;d++){const g=a[d];if(!st(g))continue;const T=it(g),w=g.params.vertexAttributes,p=[],y=f=>{if(g.params.topology==="PerAttributeArray")return null;const v=g.params.faces;for(const b in v)if(b===f)return v[b].values;return null},k=w[O.POSITION],U=k.values.length/k.valuesPerElement;for(const f in w){const v=w[f],b=v.values,$=y(f)??Ge(U);p.push([f,new C(b,$,v.valuesPerElement,!0)])}const B=T.texture,A=m&&m[B];if(A&&!x.has(B)){const{image:f,parameters:v}=A,b=new ue(f,v);r.push(b),x.set(B,b)}const L=x.get(B),P=L?L.id:void 0,E=T.material;let S=i.get(E,B);if(S==null){const f=u[E.slice(E.lastIndexOf("/")+1)].params;f.transparency===1&&(f.transparency=0);const v=A&&A.alphaChannelUsage,b=f.transparency>0||v==="transparency"||v==="maskAndTransparency",$=A?pe(A.alphaChannelUsage):void 0,W={ambient:H(f.diffuse),diffuse:H(f.diffuse),opacity:1-(f.transparency||0),transparent:b,textureAlphaMode:$,textureAlphaCutoff:.33,textureId:P,doubleSided:!0,cullFace:z.None,colorMixMode:f.externalColorMixMode||"tint",textureAlphaPremultiplied:A?.parameters.preMultiplyAlpha??!1};e?.materialParameters&&Object.assign(W,e.materialParameters),S=new N(W,e),i.set(E,B,S)}c.push(S);const I=new le(S,p);h+=p.find(f=>f[0]===O.POSITION)?.[1]?.indices.length??0,n.push(I)}return{engineResources:[{name:s,stageResources:{textures:r,materials:c,geometries:n},pivotOffset:o.model.pivotOffset,numberOfVertices:h,lodThreshold:null}],referenceBoundingBox:ot(n)}}function ot(t){const e=oe();return t.forEach(n=>{const r=n.boundingInfo;r!=null&&(q(e,r.bbMin),q(e,r.bbMax))}),e}async function at(t,e){const n=new Array;for(const i in t){const o=t[i],l=o.images[0].data;if(!l){M().warn("Externally referenced texture data is not yet supported");continue}const s=o.encoding+";base64,"+l,a="/textureDefinitions/"+i,u=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",m={noUnpackFlip:!0,wrap:{s:te.REPEAT,t:te.REPEAT},preMultiplyAlpha:pe(u)!==R.Opaque},h=e?.disableTextures?Promise.resolve(null):ze(s,e);n.push(h.then(x=>({refId:a,image:x,parameters:m,alphaChannelUsage:u})))}const r=await Promise.all(n),c={};for(const i of r)c[i.refId]=i;return c}function pe(t){switch(t){case"mask":return R.Mask;case"maskAndTransparency":return R.MaskBlend;case"none":return R.Opaque;default:return R.Blend}}function it(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const ut=new fe(1,2,"wosr");async function lt(t,e){const n=he(be(t));if(n.fileType==="wosr"){const m=await(e.cache?e.cache.loadWOSR(n.url,e):et(n.url,e)),{engineResources:h,referenceBoundingBox:x}=nt(m,e);return{lods:h,referenceBoundingBox:x,isEsriSymbolResource:!1,isWosr:!0}}let r;if(e.cache)r=await e.cache.loadGLTF(n.url,e,!!e.usePBR);else{const{loadGLTF:m}=await xe(()=>import("./loader-BV2EUuyx.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]),import.meta.url);r=await m(new Ue(e.streamDataRequester),n.url,e,e.usePBR)}const c=r.model.meta?.ESRI_proxyEllipsoid,i=r.meta.isEsriSymbolResource&&c!=null&&r.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!r.customMeta.esriTreeRendering&&(r.customMeta.esriTreeRendering=!0,pt(r,c));const o=!!e.usePBR,l=r.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:i,mrrFactors:He}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:Ke},s={...e.materialParameters,treeRendering:i},{engineResources:a,referenceBoundingBox:u}=ct(r,l,s,e,n.specifiedLodIndex);return{lods:a,referenceBoundingBox:u,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1}}function he(t){const e=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function ct(t,e,n,r,c){const i=t.model,o=new Array,l=new Map,s=new Map,a=i.lods.length,u=oe();return i.lods.forEach((m,h)=>{const x=r.skipHighLods===!0&&(a>1&&h===0||a>3&&h===1)||r.skipHighLods===!1&&c!=null&&h!==c;if(x&&h!==0)return;const d=new Je(m.name,m.lodThreshold,[0,0,0]);m.parts.forEach(g=>{const T=x?new N({},r):mt(i,g,d,e,n,l,s,r),{geometry:w,vertexCount:p}=ft(g,T??new N({},r)),y=w.boundingInfo;y!=null&&h===0&&(q(u,y.bbMin),q(u,y.bbMax)),T!=null&&(d.stageResources.geometries.push(w),d.numberOfVertices+=p)}),x||o.push(d)}),{engineResources:o,referenceBoundingBox:u}}function mt(t,e,n,r,c,i,o,l){const s=t.materials.get(e.material);if(s==null)return null;const{normal:a,color:u,texCoord0:m,tangent:h}=e.attributes,x=e.material+(a?"_normal":"")+(u?"_color":"")+(m?"_texCoord0":"")+(h?"_tangent":""),d=e.attributes.texCoord0!=null,g=e.attributes.normal!=null,T=dt(s.alphaMode);if(!i.has(x)){if(d){const I=(f,v=!1)=>{if(f!=null&&!o.has(f)){const b=t.textures.get(f);if(b){const $=b.data;o.set(f,new ue(G($)?$.data:$,{...b.parameters,preMultiplyAlpha:!G($)&&v,encoding:G($)?$.encoding:void 0}))}}};I(s.colorTexture,T!==R.Opaque),I(s.normalTexture),I(s.occlusionTexture),I(s.emissiveTexture),I(s.metallicRoughnessTexture)}const p=1/ae,y=s.color[0]**p,k=s.color[1]**p,U=s.color[2]**p,B=s.emissiveFactor[0]**p,A=s.emissiveFactor[1]**p,L=s.emissiveFactor[2]**p,P=s.colorTexture!=null&&d?o.get(s.colorTexture):null,E=Ze(s),S=s.normalTextureTransform?.scale!=null?s.normalTextureTransform?.scale:Ae;i.set(x,new N({...r,transparent:T===R.Blend,customDepthTest:We.Lequal,textureAlphaMode:T,textureAlphaCutoff:s.alphaCutoff,diffuse:[y,k,U],ambient:[y,k,U],opacity:s.opacity,doubleSided:s.doubleSided,doubleSidedType:"winding-order",cullFace:s.doubleSided?z.None:z.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:g?re.Attribute:re.ScreenDerivative,castShadows:!0,receiveShadows:s.receiveShadows,receiveAmbientOcclusion:s.receiveAmbientOcclustion,textureId:P?.id,colorMixMode:s.colorMixMode,normalTextureId:s.normalTexture!=null&&d?o.get(s.normalTexture).id:void 0,textureAlphaPremultiplied:P!=null&&!!P.parameters.preMultiplyAlpha,occlusionTextureId:s.occlusionTexture!=null&&d?o.get(s.occlusionTexture).id:void 0,emissiveTextureId:s.emissiveTexture!=null&&d?o.get(s.emissiveTexture).id:void 0,metallicRoughnessTextureId:s.metallicRoughnessTexture!=null&&d?o.get(s.metallicRoughnessTexture).id:void 0,emissiveFactor:[B,A,L],mrrFactors:E?Qe:[s.metallicFactor,s.roughnessFactor,r.mrrFactors[2]],isSchematic:E,colorTextureTransformMatrix:F(s.colorTextureTransform),normalTextureTransformMatrix:F(s.normalTextureTransform),scale:[S[0],S[1]],occlusionTextureTransformMatrix:F(s.occlusionTextureTransform),emissiveTextureTransformMatrix:F(s.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:F(s.metallicRoughnessTextureTransform),...c},l))}const w=i.get(x);if(n.stageResources.materials.push(w),d){const p=y=>{y!=null&&n.stageResources.textures.push(o.get(y))};p(s.colorTexture),p(s.normalTexture),p(s.occlusionTexture),p(s.emissiveTexture),p(s.metallicRoughnessTexture)}return w}function ft(t,e){const n=t.attributes.position.count,r=Le(t.indices||n,t.primitiveType),c=j(3*n),{typedBuffer:i,typedBufferStride:o}=t.attributes.position;Ce(c,i,t.transform,3,o);const l=[[O.POSITION,new C(c,r,3,!0)]];if(t.attributes.normal!=null){const a=j(3*n),{typedBuffer:u,typedBufferStride:m}=t.attributes.normal;we(_,t.transform),ke(a,u,_,3,m),K(_)&&J(a,a),l.push([O.NORMAL,new C(a,r,3,!0)])}if(t.attributes.tangent!=null){const a=j(4*n),{typedBuffer:u,typedBufferStride:m}=t.attributes.tangent;ve(_,t.transform),Fe(a,u,_,4,m),K(_)&&J(a,a,4),l.push([O.TANGENT,new C(a,r,4,!0)])}if(t.attributes.texCoord0!=null){const a=j(2*n),{typedBuffer:u,typedBufferStride:m}=t.attributes.texCoord0;je(a,u,2,m),l.push([O.UV0,new C(a,r,2,!0)])}const s=t.attributes.color;if(s!=null){const a=new Uint8Array(4*n);s.elementCount===4?s instanceof ce?ee(a,s,1,255):(s instanceof Ie||s instanceof Oe)&&ee(a,s,1/255,255):(a.fill(255),s instanceof me?X(a,s.typedBuffer,1,255,4,s.typedBufferStride):(t.attributes.color instanceof Pe||t.attributes.color instanceof _e)&&X(a,s.typedBuffer,1/255,255,4,t.attributes.color.typedBufferStride)),l.push([O.COLOR,new C(a,r,4,!0)])}return{geometry:new le(e,l),vertexCount:n}}const _=ie();function dt(t){switch(t){case"BLEND":return R.Blend;case"MASK":return R.Mask;case"OPAQUE":case null:case void 0:return R.Opaque}}function pt(t,e){for(let n=0;n<t.model.lods.length;++n){const r=t.model.lods[n];for(const c of r.parts){const i=c.attributes.normal;if(i==null)return;const o=c.attributes.position,l=o.count,s=D(),a=D(),u=D(),m=new Float32Array(4*l),h=new Float32Array(3*l),x=$e(Re(),c.transform);let d=0,g=0;for(let T=0;T<l;T++){o.getVec(T,a),i.getVec(T,s),Q(a,a,c.transform),Me(u,a,e.center),Y(u,u,e.radius);const w=u[2],p=Be(u),y=Math.min(.45+.55*p*p,1)**ae;Y(u,u,e.radius),x!==null&&Q(u,u,x),Se(u,u),n+1!==t.model.lods.length&&t.model.lods.length>1&&Ee(u,u,s,w>-1?.2:Math.min(-4*w-3.8,1)),h[d]=u[0],h[d+1]=u[1],h[d+2]=u[2],d+=3,m[g]=y,m[g+1]=y,m[g+2]=y,m[g+3]=1,g+=4}c.attributes.normal=new me(h),c.attributes.color=new ce(m)}}}const Dt=Object.freeze(Object.defineProperty({__proto__:null,fetch:lt,parseUrl:he},Symbol.toStringTag,{value:"Module"}));export{lt as Y,Dt as o,F as s};
