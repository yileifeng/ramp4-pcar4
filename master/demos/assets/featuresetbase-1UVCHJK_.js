import{aH as fe,B as T,D as A,H as Fe,G as Te,aS as $e,N as pe,J as ye,a4 as Re,ii as Me,n as Ue,bs as Oe,c_ as R,aE as Ve,c$ as k,C as Ne,S as ze,ij as Ge,b6 as Je}from"./main-asQ7SttR.js";import{o as v,a1 as He,a0 as oe,w as C,c as M,j as D,aq as We,K as Ee,Z as ve,a4 as De,J as L,am as _,H as X,V as Be,h as B,G as _e,d as q,D as qe,ar as Qe,as as ee,z as ae}from"./arcade-DMdCNKon.js";import{a as p,r as y}from"./unitConversion-Ck-EQaC0.js";import{R as Ke,q as Se,p as Ye,c as se,e as Xe,a as et,b as tt,N as ne,j as nt,F as it,E as rt,L as W,B as ot,d as te,f as Z,k as le}from"./featureSetUtils-5vq5CiRm.js";import{t as at}from"./ImmutableArray-BPVd6ESQ.js";import{l as st}from"./portalUtils-2nkgAAhU.js";import{u as lt,O as xe}from"./SpatialFilter-DTeq9tWH.js";import{x as ke,s as de}from"./shared-CtViELyY.js";import{D as E}from"./WhereClause-Bsz5dHey.js";import Le from"./FeatureLayer-YXIhanP1.js";import{y as P}from"./Field-BLAoQZ_0.js";import{f as dt,s as ct,i as ut}from"./utils-CO4HUuqg.js";import{p as K}from"./NetworkElement-BeRALR28.js";import"./preload-helper-ExcqyqRp.js";import"./number-owTymi_G.js";import"./TimeOnly-BOSrAlqL.js";import"./featureConversionUtils-pNtCHoNi.js";import"./OptimizedFeature-CYyXKDHx.js";import"./memoryEstimations-COo-dz1M.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./FieldsIndex-DW-5YYve.js";import"./timeZoneUtils-CfTu0PZq.js";import"./uuid-Cl5lrJ4c.js";import"./MD5-C9MwAd2G.js";import"./RelationshipQuery-mAwq-K2B.js";import"./Query-D7n22axe.js";import"./TimeExtent-tqAWy-Dv.js";import"./FeatureType-CW4wVo0k.js";import"./FeatureTemplate-CBVgicZE.js";import"./Layer-Bx8UpsMJ.js";import"./PortalItem-Nq3zGykG.js";import"./operatorsWorkerConnection-CS6sEaA2.js";import"./workers-BJlMhhTk.js";import"./Queue-B7j4i-p3.js";import"./intl-D5myeBIL.js";import"./MultiOriginJSONSupport-BgTEONJv.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-B41Kn339.js";import"./HeightModelInfo-B7gpIaa-.js";import"./commonProperties-BAQ0_iGY.js";import"./ElevationInfo-C-a3Y-El.js";import"./lengthUtils-GoFDlaqZ.js";import"./labelingInfo-C6cu4L4_.js";import"./SimpleRenderer-CnXOtoBL.js";import"./commonProperties-BCStlC_N.js";import"./colorRamps-Dk7bz912.js";import"./ColorStop-DwDT8ygX.js";import"./visualVariableUtils-BKDBW5cJ.js";import"./UniqueValueRenderer-CNrg2TdL.js";import"./defaultCIMValues-BZQdnlbk.js";import"./enums-CD-fX3vU.js";import"./RendererLegendOptions-Bo7pHTmv.js";import"./styleUtils-seZ9SQXz.js";import"./NormalizationBinParametersMixin-DMkoT-On.js";import"./labelUtils-D8QsMWGG.js";import"./LayerFloorInfo-zXk-Sqoy.js";import"./Relationship-Dzm_LU3_.js";import"./serviceCapabilitiesUtils-B4Pizcp2.js";import"./infoFor3D-DhzudQro.js";import"./editsZScale-Dmxsqw6m.js";import"./queryZScale-B6rpYzYS.js";import"./projection-G6EI4E6A.js";import"./projectBuffer-Cx7kBt8y.js";import"./FeatureSet-BbkVLp0y.js";import"./APIKeyMixin-B_KGbN0h.js";import"./ArcGISService-BpCkZU1v.js";import"./BlendLayer-DQc1-4op.js";import"./jsonUtils-id0_mGIh.js";import"./parser-Bpna5qKq.js";import"./mat4f32-DcsiF_Rp.js";import"./mat4-BjwS19gr.js";import"./common-DQOJ18NT.js";import"./CustomParametersMixin-B7XIjtWP.js";import"./DisplayFilteredLayer-Can002Zs.js";import"./scaleUtils-C76ebMnv.js";import"./displayFilterUtils-hwEJosKz.js";import"./EditBusLayer-iTsILf6K.js";import"./FeatureEffectLayer-B7oH4PZH.js";import"./FeatureEffect-B6uz554M.js";import"./FeatureFilter-BMGPBFnL.js";import"./fieldType-DNTeE9NS.js";import"./FeatureReductionLayer-DBGKy5I4.js";import"./FeatureReductionSelection-595R3Jim.js";import"./jsonUtils-Bfgh5fRb.js";import"./typeUtils-CM8gcbcJ.js";import"./ClassBreaksRenderer-BsHgq2H0.js";import"./LRUCache-D1fsA-w6.js";import"./MemCache-DE3T9NBz.js";import"./Version-CCEYPWOm.js";import"./utils-Piv4JJl1.js";import"./heatmapUtils-OBh9qWh9.js";import"./vec42-CKs01hkn.js";import"./vec4f64-o2zAXfmz.js";import"./OperationalLayer-DTkZmy-B.js";import"./OrderedLayer-JMonx__F.js";import"./OrderByInfo-UxwmOVA6.js";import"./PortalLayer-D_hkWTMK.js";import"./portalItemUtils-BFogiphi.js";import"./RefreshableLayer-D-fI9Hjo.js";import"./ScaleRangeLayer-59UbR5Hw.js";import"./TemporalLayer-3uOs5aS1.js";import"./TimeInfo-CoJs_xDI.js";import"./TrackableLayer-CDjzANUC.js";import"./fieldProperties-DO9v7LnS.js";import"./TitleCreator-D4Acd7vN.js";import"./versionUtils-BOdur6My.js";import"./styleUtils-oDcXDftb.js";import"./popupUtils-ChjfLide.js";import"./interfaces-CL2NbQte.js";var Ae;(function(i){i[i.RTJunctionJunctionConnectivity=1]="RTJunctionJunctionConnectivity",i[i.RTContainment=2]="RTContainment",i[i.RTAttachment=3]="RTAttachment",i[i.RTJunctionEdgeConnectivity=4]="RTJunctionEdgeConnectivity",i[i.RTEdgeJunctionEdgeConnectivity=5]="RTEdgeJunctionEdgeConnectivity"})(Ae||(Ae={}));new fe({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation"});const U=new fe({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new fe({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let x=class extends ye{constructor(t){super(t),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(t,r){return new K({globalId:r.fromGlobalId,networkSourceId:r.fromNetworkSourceId,terminalId:r.fromTerminalId})}writeFromNetworkElement(t,r){t&&(r.fromGlobalId=t.globalId,r.fromNetworkSourceId=t.networkSourceId,r.fromTerminalId=t.terminalId)}readToNetworkElement(t,r){return new K({globalId:r.toGlobalId,networkSourceId:r.toNetworkSourceId,terminalId:r.toTerminalId})}writeToNetworkElement(t,r){t&&(r.toGlobalId=t.globalId,r.toNetworkSourceId=t.networkSourceId,r.toTerminalId=t.terminalId)}};T([A({type:String,json:{write:!0}})],x.prototype,"globalId",void 0),T([A({type:U.apiValues,json:{type:U.jsonValues,read:U.read,write:U.write}})],x.prototype,"associationType",void 0),T([A({type:K,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId"]}}})],x.prototype,"fromNetworkElement",void 0),T([Fe("fromNetworkElement")],x.prototype,"readFromNetworkElement",null),T([Te("fromNetworkElement")],x.prototype,"writeFromNetworkElement",null),T([A({type:K,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId"]}}})],x.prototype,"toNetworkElement",void 0),T([Fe("toNetworkElement")],x.prototype,"readToNetworkElement",null),T([Te("toNetworkElement")],x.prototype,"writeToNetworkElement",null),T([A({type:$e,json:{write:!0}})],x.prototype,"geometry",void 0),T([A({type:String,json:{write:!0}})],x.prototype,"errorMessage",void 0),T([A({type:Number,json:{write:!0}})],x.prototype,"percentAlong",void 0),T([A({type:Number,json:{write:!0}})],x.prototype,"errorCode",void 0),T([A({type:Boolean,json:{write:!0}})],x.prototype,"isContentVisible",void 0),T([A({type:Number,json:{write:!0}})],x.prototype,"status",void 0),x=T([pe("esri.rest.networks.support.Association")],x);const mt=x;let ie=class extends ye{constructor(t){super(t),this.associations=[]}};T([A({type:[mt],json:{write:!0}})],ie.prototype,"associations",void 0),ie=T([pe("esri.rest.networks.support.QueryAssociationsResult")],ie);const ft=ie;function pt(i){const{returnDeletes:t,elements:r,gdbVersion:w,moment:g}=i.toJSON();return{returnDeletes:t,elements:JSON.stringify(r.map(e=>({globalId:e.globalId,networkSourceId:e.networkSourceId,terminalId:e.terminalId}))),types:JSON.stringify(i.types.map(e=>U.toJSON(e))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:w,moment:g}}async function yt(i,t,r){const w=dt(i),g={...pt(t),f:"json"},e=ct({...w.query,...g}),n=ut(e,{...r,method:"post"}),a=`${w.path}/associations/query`,{data:l}=await Re(a,n),f=ft.fromJSON(l);return t.types.includes("connectivity")&&Me(Ue.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-rest-networks-support-QueryAssociationsParameters.html#types",version:"4.29",warnOnce:!0}),f}var ue;let z=ue=class extends ye{static from(i){return Oe(ue,i)}constructor(i){super(i),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};T([A({type:Boolean,json:{write:!0}})],z.prototype,"returnDeletes",void 0),T([A({type:[K],json:{write:!0}})],z.prototype,"elements",void 0),T([A({type:[U.apiValues],json:{type:U.jsonValues,read:U.read,write:U.write}})],z.prototype,"types",void 0),T([A({type:String,json:{write:!0}})],z.prototype,"gdbVersion",void 0),T([A({type:Date,json:{type:Number,write:{writer:(i,t)=>{t.moment=i?.getTime()}}}})],z.prototype,"moment",void 0),z=ue=T([pe("esri.rest.networks.support.QueryAssociationsParameters")],z);const wt=z;function It(i){if(i.length===1){if(k(i[0]))return ae("distinct",i[0],-1);if(B(i[0]))return ae("distinct",i[0].toArray(),-1)}return ae("distinct",i,-1)}function ce(i,t,r){const w=i.getVariables();if(w.length>0){const g={};for(const e of w)g[e]=t.evaluateIdentifier(r,{name:e});i.parameters=g}return i}function m(i,t,r=null){for(const w in i)if(w.toLowerCase()===t.toLowerCase())return i[w];return r}function Ce(i){if(i===null)return null;const t={type:m(i,"type",""),name:m(i,"name","")};if(t.type==="range")t.range=m(i,"range",[]);else{t.codedValues=[];for(const r of m(i,"codedValues",[]))t.codedValues.push({name:m(r,"name",""),code:m(r,"code",null)})}return t}function me(i){if(i===null)return null;const t={},r=m(i,"wkt");r!==null&&(t.wkt=r);const w=m(i,"wkid");return w!==null&&(t.wkid=w),t}function je(i){if(i===null)return null;const t={hasZ:m(i,"hasz",!1),hasM:m(i,"hasm",!1)},r=m(i,"spatialreference");r!=null&&(t.spatialReference=me(r));const w=m(i,"x",null);if(w!==null)return t.x=w,t.y=m(i,"y",null),t.hasZ&&(t.z=m(i,"z",null)),t.hasM&&(t.m=m(i,"m",null)),t;const g=m(i,"rings",null);if(g!==null)return t.rings=g,t;const e=m(i,"paths",null);if(e!==null)return t.paths=e,t;const n=m(i,"points",null);if(n!==null)return t.points=n,t;for(const a of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const l=m(i,a,null);l!==null&&(t[a]=l)}return t}function gt(i,t){for(const r of t)if(r===i)return!0;return!1}function ht(i){return!!i.layerDefinition&&!!i.featureSet&&gt(i.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&k(i.layerDefinition.fields)!==!1&&k(i.featureSet.features)!==!1}function Q(i){return i?.toLowerCase()==="utc"?"UTC":i?.toLowerCase()==="unknown"?"Unknown":i}async function bt(i,t,r,w,g,e,n){const a=await i.getFeatureSetInfo();if((a?.layerId??null)===null||!g.layerIdLookup.get(a.layerId))return null;const l=i.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),f=[];switch(r){case"connected":f.push("connectivity"),f.push("junction-edge-from-connectivity"),f.push("junction-edge-to-connectivity"),f.push("junction-edge-midspan-connectivity"),f.push("junction-junction-connectivity");break;case"container":case"content":f.push("containment");break;case"structure":case"attached":f.push("attachment");break;case"junctionedge":f.push("junction-edge-from-connectivity"),f.push("junction-edge-to-connectivity");break;case"midspan":f.push("junction-edge-midspan-connectivity");break;default:throw new p(e,y.InvalidParameter,n)}let c=null,s=!1;if(w!==null&&w!==""&&w!==void 0){for(const u of g.terminals)u.terminalName===w&&(c=u.terminalId);c===null&&(s=!0)}const o=[];if(!s){const u=new K({globalId:t.field(i.globalIdField),networkSourceId:g.layerIdLookup.get(a.layerId).sourceId,...c?{terminalId:c}:""}),S=await yt(l,new wt({types:f,elements:[u]}));let N=0;for(const I of S.associations){let F=null,G="",$="";if(I.fromNetworkElement?.globalId===u.globalId?(F=I.toNetworkElement,$="to"):I.toNetworkElement?.globalId===u.globalId&&(F=I.fromNetworkElement,$="from"),!F)continue;switch(r){case"attached":if(I.associationType!=="attachment"||$!=="to")continue;break;case"structure":if(I.associationType!=="attachment"||$!=="from")continue;break;case"container":if(I.associationType!=="containment"||$!=="from")continue;break;case"content":if(I.associationType!=="containment"||$!=="to")continue;break;case"connected":break;case"junctionedge":I.associationType==="junction-edge-to-connectivity"?G="to":I.associationType==="junction-edge-from-connectivity"&&(G="from");break;case"midspan":if(I.associationType!=="junction-edge-midspan-connectivity")continue}const J=g.sourceIdLookup.get(F.networkSourceId)?.className??"";o.push(new Je({geometry:null,attributes:{objectId:N++,globalId:F.globalId,percentAlong:I.percentAlong??0,isContentVisible:I.isContentVisible?0:1,className:J,side:G}}))}}const d=new Le({source:o,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new P({name:"objectId",alias:"objectId",type:"oid"}),new P({name:"globalId",alias:"globalId",type:"global-id"}),new P({name:"percentAlong",alias:"percentAlong",type:"double"}),new P({name:"side",alias:"side",type:"string"}),new P({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new P({name:"className",alias:"className",type:"string"})]});return ne(d)}function vi(i){i.mode==="async"&&(i.functions.timezone=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,1,2,t,r),He(e[0])||oe(e[0]))return"Unknown";if(C(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?Q("unknown"):Q(e[0].dateFieldsTimeZone);if(!(e[1]instanceof M)||e[1].hasField("type")===!1)throw new p(t,y.InvalidParameter,r);const l=e[1].field("type");if(R(l)===!1)throw new p(t,y.InvalidParameter,r);switch(D(l).toLowerCase()){case"preferredtimezone":return Q(e[0].preferredTimeZone);case"editfieldsinfo":return Q(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return Q(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&R(e[1].field("fieldname")))return Q(e[0].fieldTimeZone(D(e[1].field("fieldname"))))}throw new p(t,y.InvalidParameter,r)}const n=We(e[0],Ee(t));if(n===null)return null;const a=n.timeZone;return a==="system"?Ve.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a.toLowerCase()==="unknown"?"Unknown":a})},i.functions.sqltimestamp=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{v(e,1,3,t,r);const n=e[0];if(ve(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(D(e[1])).toSQLWithKeyword();throw new p(t,y.InvalidParameter,r)}if(oe(n))return n.toSQLWithKeyword();if(C(n)){if(e.length!==3)throw new p(t,y.InvalidParameter,r);await n.load();const a=D(e[1]);if(oe(e[2]))return e[2].toSQLWithKeyword();if(ve(e[2])===!1)throw new p(t,y.InvalidParameter,r);const l=n.fieldTimeZone(a);return l==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(l).toSQLWithKeyword()}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"sqltimestamp",min:2,max:4}),i.functions.featuresetbyid=function(t,r){return i.standardFunctionAsync(t,r,(w,g,e)=>{if(v(e,2,4,t,r),De(e[0])){const n=D(e[1]);let a=L(e[2],null);const l=_(L(e[3],!0));if(a===null&&(a=["*"]),k(a)===!1)throw new p(t,y.InvalidParameter,r);return e[0].featureSetById(n,l,a)}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"featuresetbyid",min:2,max:4}),i.functions.getfeatureset=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,1,2,t,r),X(e[0])){let n=L(e[1],"datasource");return n===null&&(n="datasource"),n=D(n).toLowerCase(),Ke(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference??null)}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"getfeatureset",min:1,max:2}),i.functions.featuresetbyportalitem=function(t,r){return i.standardFunctionAsync(t,r,(w,g,e)=>{if(v(e,2,5,t,r),e[0]===null)throw new p(t,y.PortalRequired,r);if(e[0]instanceof Be){const c=D(e[1]),s=D(e[2]);let o=L(e[3],null);const d=_(L(e[4],!0));if(o===null&&(o=["*"]),k(o)===!1)throw new p(t,y.InvalidParameter,r);let u;return u=t.services?.portal?t.services.portal:Ne.getDefault(),u=st(e[0],u),Se(c,s,t.spatialReference??null,o,d,u,t.lrucache,t.interceptor)}if(R(e[0])===!1)throw new p(t,y.PortalRequired,r);const n=D(e[0]),a=D(e[1]);let l=L(e[2],null);const f=_(L(e[3],!0));if(l===null&&(l=["*"]),k(l)===!1)throw new p(t,y.InvalidParameter,r);return Se(n,a,t.spatialReference??null,l,f,t.services?.portal??Ne.getDefault(),t.lrucache,t.interceptor)})},i.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),i.functions.featuresetbyname=function(t,r){return i.standardFunctionAsync(t,r,(w,g,e)=>{if(v(e,2,4,t,r),De(e[0])){const n=D(e[1]);let a=L(e[2],null);const l=_(L(e[3],!0));if(a===null&&(a=["*"]),k(a)===!1)throw new p(t,y.InvalidParameter,r);return e[0].featureSetByName(n,l,a)}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"featuresetbyname",min:2,max:4}),i.functions.featureset=function(t,r){return i.standardFunction(t,r,(w,g,e)=>{v(e,1,1,t,r);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(R(e[0])){const a=JSON.parse(e[0]);a.layerDefinition!==void 0?(n.layerDefinition=a.layerDefinition,n.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(n.featureSet.features=a.features,n.featureSet.geometryType=a.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=a.objectIdFieldName??"",n.layerDefinition.typeIdField=a.typeIdFieldName,n.layerDefinition.globalIdField=a.globalIdFieldName,n.layerDefinition.fields=a.fields,a.spatialReference&&(n.layerDefinition.spatialReference=a.spatialReference))}else{if(!(e[0]instanceof M))throw new p(t,y.InvalidParameter,r);{const a=JSON.parse(e[0].castToText(!0)),l=m(a,"layerdefinition");if(l!==null){n.layerDefinition.geometryType=m(l,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=m(l,"globalidfield",""),n.layerDefinition.objectIdField=m(l,"objectidfield",""),n.layerDefinition.typeIdField=m(l,"typeidfield",""),n.layerDefinition.hasZ=m(l,"hasz",!1)===!0,n.layerDefinition.hasM=m(l,"hasm",!1)===!0;const f=m(l,"spatialreference");f&&(n.layerDefinition.spatialReference=me(f));const c=[];for(const o of m(l,"fields",[])){const d={name:m(o,"name",""),alias:m(o,"alias",""),type:m(o,"type",""),nullable:m(o,"nullable",!0),editable:m(o,"editable",!0),length:m(o,"length",null),domain:Ce(m(o,"domain"))};c.push(d)}n.layerDefinition.fields=c;const s=m(a,"featureset");if(s){const o={};for(const d of c)o[d.name.toLowerCase()]=d.name;for(const d of m(s,"features",[])){const u={},S=m(d,"attributes",{});for(const N in S)u[o[N.toLowerCase()]]=S[N];n.featureSet.features.push({attributes:u,geometry:je(m(d,"geometry"))})}}}else{n.layerDefinition.hasZ=m(a,"hasz",!1)===!0,n.layerDefinition.hasM=m(a,"hasm",!1)===!0,n.layerDefinition.geometryType=m(a,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=m(a,"objectidfieldname",""),n.layerDefinition.typeIdField=m(a,"typeidfieldname","");const f=m(a,"spatialreference");f&&(n.layerDefinition.spatialReference=me(f));const c=[],s=m(a,"fields",null);if(!k(s))throw new p(t,y.InvalidParameter,r);for(const u of s){const S={name:m(u,"name",""),alias:m(u,"alias",""),type:m(u,"type",""),nullable:m(u,"nullable",!0),editable:m(u,"editable",!0),length:m(u,"length",null),domain:Ce(m(u,"domain"))};c.push(S)}n.layerDefinition.fields=c;const o={};for(const u of c)o[u.name.toLowerCase()]=u.name;let d=m(a,"features",null);if(k(d))for(const u of d){const S={},N=m(u,"attributes",{});for(const I in N)S[o[I.toLowerCase()]]=N[I];n.featureSet.features.push({attributes:S,geometry:je(m(u,"geometry",null))})}else d=null,n.featureSet.features=d}}}if(ht(n)===!1)throw new p(t,y.InvalidParameter,r);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),Ye.create(n,t.spatialReference)})},i.signatures.push({name:"featureset",min:1,max:1}),i.functions.filter=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,2,2,t,r),k(e[0])||B(e[0])){const n=[];let a,l=e[0];if(l instanceof at&&(l=l.toArray()),!_e(e[1]))throw new p(t,y.InvalidParameter,r);a=e[1].createFunction(t);for(const f of l){const c=a(f);ze(c)?await c===!0&&n.push(f):c===!0&&n.push(f)}return n}if(C(e[0])){const n=await e[0].load(),a=E.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),l=a.getVariables();if(l.length>0){const f={};for(const c of l)f[c]=i.evaluateIdentifier(t,{name:c});a.parameters=f}return new se({parentfeatureset:e[0],whereclause:a})}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"filter",min:2,max:2}),i.functions.orderby=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,2,2,t,r),C(e[0])){const n=new Xe(e[1]);return new et({parentfeatureset:e[0],orderbyclause:n})}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"orderby",min:2,max:2}),i.functions.top=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,2,2,t,r),C(e[0]))return new tt({parentfeatureset:e[0],topnum:e[1]});if(k(e[0]))return q(e[1])>=e[0].length?e[0].slice():e[0].slice(0,q(e[1]));if(B(e[0]))return q(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,q(e[1]));throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"top",min:2,max:2}),i.functions.first=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,1,1,t,r),C(e[0])){const n=await e[0].first(w.abortSignal);if(n!==null){const a=qe.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return a._underlyingGraphic=n,a}return n}return k(e[0])?e[0].length===0?null:e[0][0]:B(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:1,max:1}),i.functions.attachments=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{v(e,1,2,t,r);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof M){if(e[1].hasField("minsize")&&(n.minsize=q(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=_(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=q(e[1].field("maxsize"))),e[1].hasField("types")){const a=Qe(e[1].field("types"),!1);a.length>0&&(n.types=a)}}else if(e[1]!==null)throw new p(t,y.InvalidParameter,r)}if(X(e[0])){const a=e[0]._layer;let l;if(C(a))l=a;else{if(a==null||!ke(a))return[];l=ne(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await l.load(),l.queryAttachments(e[0].field(l.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata)}if(e[0]===null)return[];throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"attachments",min:1,max:2}),i.functions.featuresetbyrelationshipname=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{v(e,2,4,t,r);const n=e[0],a=D(e[1]);let l=L(e[2],null);const f=_(L(e[3],!0));if(l===null&&(l=["*"]),k(l)===!1)throw new p(t,y.InvalidParameter,r);if(e[0]===null)return null;if(!X(e[0]))throw new p(t,y.InvalidParameter,r);const c=n._layer;let s;if(C(c))s=c;else{if(c==null||!ke(c))return null;s=ne(c,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}s=await s.load();const o=s.relationshipMetaData().filter(I=>I.name===a);if(o.length===0)return null;if(o[0].relationshipTableId!==void 0&&o[0].relationshipTableId!==null&&o[0].relationshipTableId>-1)return nt(s,o[0],n.field(s.objectIdField),s.spatialReference,l,f,t.lrucache,t.interceptor);let d=s.serviceUrl();if(!d)return null;d=d.charAt(d.length-1)==="/"?d+o[0].relatedTableId.toString():d+"/"+o[0].relatedTableId.toString();const u=await it(d,s.spatialReference,l,f,t.lrucache,t.interceptor);await u.load();let S=u.relationshipMetaData();if(S=S.filter(I=>I.id===o[0].id),n.hasField(o[0].keyField)===!1||n.field(o[0].keyField)===null){const I=await s.getFeatureByObjectId(n.field(s.objectIdField),[o[0].keyField]);if(I){const F=E.create(S[0].keyField+"= @id",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});return F.parameters={id:I.attributes[o[0].keyField]},u.filter(F)}return new lt({parentfeatureset:u})}const N=E.create(S[0].keyField+"= @id",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});return N.parameters={id:n.field(o[0].keyField)},u.filter(N)})},i.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),i.functions.featuresetbyassociation=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{v(e,2,3,t,r);const n=e[0],a=D(L(e[1],"")).toLowerCase(),l=R(e[2])?D(e[2]):null;if(e[0]===null)return null;if(!X(e[0]))throw new p(t,y.InvalidParameter,r);let f=n._layer;if(f instanceof Le&&(f=ne(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),f===null||C(f)===!1)return null;await f.load();const c=f.serviceUrl(),s=await rt(c,t.spatialReference,!0);if(s.unVersion>=8)return await bt(f,n,a,l,s,t,r);const o=s.associations;let d=null,u=null,S=!1;if(l!==null&&l!==""&&l!==void 0){for(const b of s.terminals)b.terminalName===l&&(u=b.terminalId);u===null&&(S=!0)}const N=o.getFieldsIndex(),I=N.get("TOGLOBALID").name,F=N.get("FROMGLOBALID").name,G=N.get("TOTERMINALID").name,$=N.get("FROMTERMINALID").name,J=N.get("FROMNETWORKSOURCEID").name,Y=N.get("TONETWORKSOURCEID").name,H=N.get("ASSOCIATIONTYPE").name,Ze=N.get("ISCONTENTVISIBLE").name,Pe=N.get("OBJECTID").name;for(const b of f.fields)if(b.type==="global-id"){d=n.field(b.name);break}let O=null,we=new W(new P({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),Ie=new W(new P({name:"side",alias:"side",type:"string"}),E.create("''",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));const j="globalid",ge="globalId",he={};for(const b in s.lkp)he[b]=s.lkp[b].sourceId;const V=new ot(new P({name:"classname",alias:"classname",type:"string"}),null,he);let h="";switch(a){case"midspan":{h=`((${I}='${d}') OR ( ${F}='${d}')) AND (${H} IN (5))`,V.codefield=E.create(`CASE WHEN (${I}='${d}') THEN ${J} ELSE ${Y} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const b=de(Z.findField(o.fields,F));b.name=j,b.alias=j,O=new W(b,E.create(`CASE WHEN (${F}='${d}') THEN ${I} ELSE ${F} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),we=s.unVersion>=4?new le(Z.findField(o.fields,N.get("PERCENTALONG").name)):new W(new P({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{h=`((${I}='${d}') OR ( ${F}='${d}')) AND (${H} IN (4,6))`,V.codefield=E.create(`CASE WHEN (${I}='${d}') THEN ${J} ELSE ${Y} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const b=de(Z.findField(o.fields,F));b.name=j,b.alias=j,O=new W(b,E.create(`CASE WHEN (${F}='${d}') THEN ${I} ELSE ${F} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),Ie=new W(new P({name:"side",alias:"side",type:"string"}),E.create(`CASE WHEN (${H}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let b=`${I}='@T'`,be=`${F}='@T'`;u!==null&&(b+=` AND ${G}=@A`,be+=` AND ${$}=@A`),h="(("+b+") OR ("+be+"))",h=ee(h,"@T",d??""),b=ee(b,"@T",d??""),u!==null&&(b=ee(b,"@A",u.toString()),h=ee(h,"@A",u.toString())),V.codefield=E.create("CASE WHEN "+b+` THEN ${J} ELSE ${Y} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const re=de(Z.findField(o.fields,F));re.name=j,re.alias=j,O=new W(re,E.create("CASE WHEN "+b+` THEN ${F} ELSE ${I} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"container":h=`${I}='${d}' AND ${H} = 2`,u!==null&&(h+=` AND ${G} = `+u.toString()),V.codefield=J,h="( "+h+" )",O=new te(Z.findField(o.fields,F),j,j);break;case"content":h=`(${F}='${d}' AND ${H} = 2)`,u!==null&&(h+=` AND ${$} = `+u.toString()),V.codefield=Y,h="( "+h+" )",O=new te(Z.findField(o.fields,I),j,j);break;case"structure":h=`(${I}='${d}' AND ${H} = 3)`,u!==null&&(h+=` AND ${G} = `+u.toString()),V.codefield=J,h="( "+h+" )",O=new te(Z.findField(o.fields,F),j,ge);break;case"attached":h=`(${F}='${d}' AND ${H} = 3)`,u!==null&&(h+=` AND ${$} = `+u.toString()),V.codefield=Y,h="( "+h+" )",O=new te(Z.findField(o.fields,I),j,ge);break;default:throw new p(t,y.InvalidParameter,r)}return S&&(h="1 <> 1"),new Z({parentfeatureset:o,adaptedFields:[new le(Z.findField(o.fields,Pe)),new le(Z.findField(o.fields,Ze)),O,Ie,V,we],extraFilter:h?E.create(h,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}):null})})},i.signatures.push({name:"featuresetbyassociation",min:2,max:6}),i.functions.groupby=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,3,3,t,r),!C(e[0]))throw new p(t,y.InvalidParameter,r);const n=await e[0].load(),a=[],l=[];let f=!1,c=[];if(R(e[1]))c.push(e[1]);else if(e[1]instanceof M)c.push(e[1]);else if(k(e[1]))c=e[1];else{if(!B(e[1]))throw new p(t,y.InvalidParameter,r);c=e[1].toArray()}for(const s of c)if(R(s)){const o=E.create(D(s),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),d=xe(o)===!0?D(s):"%%%%FIELDNAME";a.push({name:d,expression:o}),d==="%%%%FIELDNAME"&&(f=!0)}else{if(!(s instanceof M))throw new p(t,y.InvalidParameter,r);{const o=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",d=s.hasField("expression")?s.field("expression"):"";if(o==="%%%%FIELDNAME"&&(f=!0),!o)throw new p(t,y.InvalidParameter,r);a.push({name:o,expression:E.create(d||o,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(c=[],R(e[2]))c.push(e[2]);else if(k(e[2]))c=e[2];else if(B(e[2]))c=e[2].toArray();else{if(!(e[2]instanceof M))throw new p(t,y.InvalidParameter,r);c.push(e[2])}for(const s of c){if(!(s instanceof M))throw new p(t,y.InvalidParameter,r);{const o=s.hasField("name")?s.field("name"):"",d=s.hasField("statistic")?s.field("statistic"):"",u=s.hasField("expression")?s.field("expression"):"";if(!o||!d||!u)throw new p(t,y.InvalidParameter,r);l.push({name:o,statistic:d.toLowerCase(),expression:E.create(u,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(f){const s={};for(const d of n.fields)s[d.name.toLowerCase()]=1;for(const d of a)d.name!=="%%%%FIELDNAME"&&(s[d.name.toLowerCase()]=1);for(const d of l)d.name!=="%%%%FIELDNAME"&&(s[d.name.toLowerCase()]=1);let o=0;for(const d of a)if(d.name==="%%%%FIELDNAME"){for(;s["field_"+o.toString()]===1;)o++;s["field_"+o.toString()]=1,d.name="FIELD_"+o.toString()}}for(const s of a)ce(s.expression,i,t);for(const s of l)ce(s.expression,i,t);return e[0].groupby(a,l)})},i.signatures.push({name:"groupby",min:3,max:3}),i.functions.distinct=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(C(e[0])){v(e,2,2,t,r);const n=await e[0].load(),a=[];let l=[];if(R(e[1]))l.push(e[1]);else if(e[1]instanceof M)l.push(e[1]);else if(k(e[1]))l=e[1];else{if(!B(e[1]))throw new p(t,y.InvalidParameter,r);l=e[1].toArray()}let f=!1;for(const c of l)if(R(c)){const s=E.create(D(c),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),o=xe(s)===!0?D(c):"%%%%FIELDNAME";a.push({name:o,expression:s}),o==="%%%%FIELDNAME"&&(f=!0)}else{if(!(c instanceof M))throw new p(t,y.InvalidParameter,r);{const s=c.hasField("name")?c.field("name"):"%%%%FIELDNAME",o=c.hasField("expression")?c.field("expression"):"";if(s==="%%%%FIELDNAME"&&(f=!0),!s)throw new p(t,y.InvalidParameter,r);a.push({name:s,expression:E.create(o||s,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(f){const c={};for(const o of n.fields)c[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(c[o.name.toLowerCase()]=1);let s=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;c["field_"+s.toString()]===1;)s++;c["field_"+s.toString()]=1,o.name="FIELD_"+s.toString()}}for(const c of a)ce(c.expression,i,t);return e[0].groupby(a,[])}return It(e)})},i.functions.getfeaturesetinfo=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,1,1,t,r),!C(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?M.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},Ee(t),!1,!1):null})},i.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),i.functions.filterbysubtypecode=function(t,r){return i.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,2,2,t,r),C(e[0])){const n=await e[0].load(),a=e[1];if(!Ge(a))throw new p(t,y.InvalidParameter,r);if(n.subtypeField){const f=E.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new se({parentfeatureset:e[0],whereclause:f})}if(n.typeIdField===null||n.typeIdField==="")throw new p(t,y.FeatureSetDoesNotHaveSubtypes,r);const l=E.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new se({parentfeatureset:e[0],whereclause:l})}throw new p(t,y.InvalidParameter,r)})},i.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{vi as registerFunctions};
