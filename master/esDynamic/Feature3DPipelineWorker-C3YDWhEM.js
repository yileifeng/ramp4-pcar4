import{x as p,z as g,K as E,aL as oe,gu as ke,hR as Ue,u as de,b$ as Ne,aY as Z,U as ze,b_ as le,ho as He,s as Qe,aI as A,d_ as We,T as j,a7 as qe,fP as Ve,eZ as ce,jR as $e,bZ as Ze,dz as Je,dr as ue,dy as Ye,jS as Xe,gm as he,cT as F,c1 as Ke,dx as et,bj as tt,fc as me,M as fe,bz as rt,aM as nt,df as st}from"./main-BC8gbEPx.js";import{Q as it,O as at}from"./projection-CS2SYuKw.js";import{L as ot}from"./QueryEngine-D_nQ9Z3n.js";import{b as pe}from"./Query-BDnleJ4k.js";import{s as _e}from"./ReactiveMap-BESY4FLW.js";import{r as dt}from"./signal-UgirE0-u.js";import{s as O,n as ge,a as lt,i as ct}from"./memoryEstimations-Cij6FoJa.js";import{s as ut,E as ye}from"./PooledRBush-C5GnT75D.js";import{n as ht,e as J}from"./OptimizedFeature-DuSNmhSJ.js";import{d as mt}from"./query-DJPSoDkm.js";import{a as ft}from"./pbf-D0PvmNRs.js";import{u as pt}from"./quantizationUtils-BjEbvvIf.js";import{Z as _t}from"./FieldsIndex-Dj6cAdqw.js";import{b as gt,h as yt}from"./pbfQueryUtils-BLXiwLKW.js";import{l as I}from"./ViewingMode-CyR_b1T8.js";import{o as wt,t as bt}from"./Indices-Docepraz.js";import{N as xt}from"./vec4f64-CjUMzAyX.js";import{t as It,k as vt,s as Ct,a as Rt}from"./HUDMaterial.glsl-DyCeM3gP.js";import{t as St}from"./glUtil-n1JOrdV3.js";import{n as k}from"./ShaderOutput-C_OqLoo1.js";import{u as At,c as Tt,a as Mt,b as Pt,s as Et}from"./HUDMaterial-JZfd5xsg.js";import{O as we,a5 as Ft,a6 as Ot}from"./Geometry-6d2Fi3Pn.js";import{a as Bt,z as be,o as Gt}from"./DefaultMaterial-CdaA8o3c.js";import{e as _}from"./VertexAttribute-DFC3a3eR.js";import{m as Lt,l as Dt,f as jt,h as kt}from"./LodResources-Dwkndq20.js";import{e as xe}from"./basicInterfaces-Dsf65ICa.js";import{n as Ie,h as Ut,s as Nt,o as zt,f as Ht,r as Qt}from"./mat4-BDUaQr32.js";import{e as B}from"./mat4f64-BaJwL7tQ.js";import{o as Wt}from"./projectBuffer-CI8y-xLT.js";import{n as Y}from"./projectVectorToVector-B5ubG6d0.js";import{m as qt}from"./computeTranslationToOriginAndRotation-DDIxtr-s.js";import{c as Vt,D as $t,a as ve}from"./dehydratedFeatureUtils-DGoW5D8R.js";import{t as v}from"./orientedBoundingBox-Cx1yARP6.js";import{o as Zt,s as Ce}from"./vec32-CKLwdlap.js";import{a as Jt}from"./spatialReferenceEllipsoidUtils-Bi9a0mZ2.js";import{c as Yt}from"./projectPointToVector-7_vCrpDC.js";import{J as Xt,k as Kt}from"./boundedPlane-BSNdaYKJ.js";import{V as er,f as tr}from"./sphere-BQalhKXp.js";import{c as C,u as rr,x as nr}from"./plane-DnaQmUZU.js";let y=class extends oe{constructor(e){super(e),this._updatingCount=0,this._tileHandles=new _e,this._wanted=new _e}destroy(){for(const e of this._tileHandles.values())e.abort();this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updatingCount>0}get _boundingRect(){const{extent:e}=this;return e==null?null:ke(e)}get _missingTiles(){const e=new Array,t=this._wanted;for(const r of this._tileHandles.values())t.has(r.id)&&!G(r)&&e.push(r);return e}async onTileTreeChange(e){++this._updatingCount;try{const{added:t,removed:r}=e,n=this._tileHandles,{_boundingRect:s}=this,i=s!=null?t.filter(o=>Ue(s,o.extent)):t,a=this._wanted,d=new Array;for(const o of r){const{id:l}=o;if(a.delete(l),t.some(h=>b(h,o)||b(o,h)))continue;const c=n.get(l);c!=null&&d.push(this._removeTile(c))}for(const o of i)a.set(o.id,o),d.push(this._addTile(o));await Promise.allSettled(d)}finally{--this._updatingCount}}async _removeTile(e){this._tileHandles.delete(e.id),e.abort(),this._validate();const{tile:t}=e,r=new L(e.untilSettled(),t!=null?this.createRemoveTileCommand(t):null);e.nextEvent=null;const{command:n}=await r.getCommand();n?.execute()}async _addTile(e){const{_tileHandles:t}=this,r=t.get(e.id);if(r!=null)return!G(r)||r.tile.isComplete||(r.tile=r.tile.reset(),r.nextEvent=this._onTileLoad(r)),void await r.untilSettled();const n=new sr(e);this._tileHandles.set(n.id,n);const s=this.loadTile(e,n.signal);n.nextEvent=s;const i=await s;if(n.aborted)throw de();n.tile=i,ir(n),n.nextEvent=this._onTileLoad(n),await n.untilSettled()}async _onTileLoad(e){const{_wanted:t,_tileHandles:r,_missingTiles:n}=this,s=e.descriptor,i=new Array,a=new Array,d=new Set;for(const l of r.values()){if(l===e)continue;const{descriptor:c,id:h}=l;if(t.has(h)||n.some(({descriptor:m})=>b(m,c)||b(c,m))){if(G(l)){if(b(s,c)){const m=l.tile;for(const u of m.objectIds())d.add(u)}if(b(c,s)){const m=e.tile,u=new Set(m.objectIds()),f=l.tile,x=f.exclude(u);l.tile=x;const R=AbortSignal.any([l.signal,e.signal]),S=l.untilSettled();i.push(new L(S,this.createRemoveTileCommand(f))),i.push(new L(S,this.createAddTileCommand(x,R),R)),a.push(l),this._validateRemoval(x,u)}}}else{l.abort(),r.delete(h);const{tile:m}=l;m!=null&&i.push(new L(l.untilSettled(),this.createRemoveTileCommand(m))),l.nextEvent=null}}d.size>0&&(e.tile=e.tile.exclude(d),this._validateRemoval(e.tile,d)),i.push(new L(e.untilSettled(),this.createAddTileCommand(e.tile,e.signal),e.signal)),a.push(e),this._validate();const o=this._joinCommands(i);for(const l of a)l.nextEvent=o;await o}async _joinCommands(e){const t=(await Promise.allSettled(e.map(async r=>r.getCommand()))).map(r=>r.status!=="fulfilled"||r.value.signal?.aborted?null:r.value.command).filter(Ne);t.length!==0&&t.reduce((r,n)=>(r.append(n),r)).execute()}_validate(){if(!Z("feature-pipeline-3d-test-validation"))return;const e=new Array;for(const t of this._tileHandles.values()){if(!G(t))continue;const{tile:r}=t,n=r.featureCount,s=new Uint32Array(n);r.readObjectIds(s),e.push({tile:r,objectIds:new Set(s)})}for(let t=0;t<e.length;++t){const{tile:r,objectIds:n}=e[t];for(let s=t+1;s<e.length;++s){const{tile:i,objectIds:a}=e[s];for(const d of a)if(n.has(d)){const o=b(i.descriptor,r.descriptor),l=b(r.descriptor,i.descriptor);throw new Error(`${r.descriptor.id} and ${i.descriptor.id} both contain ${d}. aInB: ${o}; bInA: ${l}`)}}}}_validateRemoval(e,t){if(Z("feature-pipeline-3d-test-validation")){for(const r of e.objectIds())if(t.has(r))throw new Error(`Failed to remove ${r} from ${e.descriptor.id}!`)}}};function b({lij:[e,t,r]},{lij:[n,s,i]}){const a=n-e;return a>=0&&t===s>>a&&r===i>>a}p([g()],y.prototype,"updating",null),p([g({constructOnly:!0})],y.prototype,"loadTile",void 0),p([g({constructOnly:!0})],y.prototype,"createAddTileCommand",void 0),p([g({constructOnly:!0})],y.prototype,"createRemoveTileCommand",void 0),p([g()],y.prototype,"_updatingCount",void 0),p([g()],y.prototype,"extent",void 0),p([g()],y.prototype,"_boundingRect",null),p([g()],y.prototype,"_missingTiles",null),y=p([E("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],y);let sr=class{constructor(e){this.descriptor=e,this._controller=new AbortController,this._tile=dt(null),this.nextEvent=null}get id(){return this.descriptor.id}get tile(){return this._tile.value}set tile(e){this._tile.value=e}get signal(){return this._controller.signal}abort(){this._controller.abort()}get aborted(){return this._controller.signal.aborted}async untilSettled(){try{await this.nextEvent}catch(e){ze(e)||console.error(e)}}};function G(e){return e.tile!=null}function ir(e){if(!G(e))throw new Error}let L=class{constructor(e,t,r){this.previousEventSettled=e,this.commandPromise=t,this.signal=r}async getCommand(){const{previousEventSettled:e,commandPromise:t,signal:r}=this,[n]=await Promise.all([t,e]);if(r?.aborted)throw de();return{command:n,signal:r}}},ar=class ie{constructor(t,r){this.tile=t,this._tileIndices=r}get id(){return this.tile.id}get featureCount(){return this._tileIndices?.length??this.tile.featureCount}get usedMemory(){return O+(this._tileIndices?.byteLength??0)}get extent(){return this.tile.descriptor.extent}readObjectIds(t,r){const{_tileIndices:n,tile:s}=this;return s.readObjectIds(t,n,r)}readCoordinates(t,r){const{_tileIndices:n,tile:s}=this;return s.readCoordinates(t,n,r)}subset(t){const{_tileIndices:r,tile:n}=this;if(r==null)return new ie(n,t);const s=new Uint32Array(t.length);for(let i=0;i<s.length;++i)s[i]=r[t[i]];return new ie(n,s)}},or=class{constructor(){this._tileToFeatureData=new Map}add(e){this._tileToFeatureData.set(e.tile,e)}remove(e){this._tileToFeatureData.delete(e)}get(e){return this._tileToFeatureData.get(e)}},X=class{constructor(e,t){this._index=e,this._view=t}get usedMemory(){return O+ge}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new dr(this._index,this._view,e)}},dr=class extends X{constructor(e,t,r){super(e,t),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return ht(new J,this._geometryOverride,e.hasZ,e.hasM)}},lr=class{constructor(){this._tileBounds=new Map,this.events=new le,this.featureAdapter=K.shared}get usedMemory(){return O+O*this._tileBounds.size}addTile(e){const{featureCount:t}=e;if(t===0)return;const r=new ut(9,s=>e.getBounds(s)),n=new Array;for(let s=0;s<t;++s)n[s]=s;r.load(n),this._tileBounds.set(e,r),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(const[t,r]of this._tileBounds)r.all(n=>e(new X(n,t)))}forEachInBounds(e,t){D.minX=e[0],D.minY=e[1],D.maxX=e[2],D.maxY=e[3];for(const[r,n]of this._tileBounds)n.search(D,s=>t(new X(s,r)))}forEachBounds(e,t){for(const r of e)t(r.getBoundingBox())}getFullExtent(e){let t=1/0,r=1/0,n=-1/0,s=-1/0;for(const i of this._tileBounds.values()){const{minX:a,minY:d,maxX:o,maxY:l}=i.toJSON();t=Math.min(t,a),r=Math.min(r,d),n=Math.min(n,o),s=Math.min(s,l)}return{xmin:t,ymin:r,xmax:n,ymax:s,spatialReference:e}}},K=class{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}};K.shared=new K;const D=new ye;let cr=class ae{constructor(t,r,n=ur(r)){this.descriptor=t,this._pages=r,this._addressTable=n;const s=lt+r.reduce((d,{usedMemory:o})=>d+o,0),i=3*ge,a=ct(n);this.usedMemory=O+s+i+a,this.featureCount=Math.floor(this._addressTable.length/2),this.isComplete=this.featureCount===r.reduce((d,o)=>d+o.featureCount,0)}get id(){return this.descriptor.id}getObjectId(t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(t);return this._pages[r].getObjectId(n)}getAttribute(t,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(t);return this._pages[n].getAttribute(s,r)}getAttributeAsTimestamp(t,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(t);return this._pages[n].getAttributeAsTimestamp(s,r)}getAttributes(t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(t);return this._pages[r].getAttributes(n)}getCoordinates(t,r,n){const{pageIndex:s,featurePageIndex:i}=this._translateIndex(t);this._pages[s].getCoordinates(i,r,n)}getOptimizedGeometry(t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(t);return this._pages[r].getOptimizedGeometry(n)}getCentroid(t,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(t);return this._pages[n].getCentroid(s,r)}getBounds(t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(t);return this._pages[r].getBounds(n)}getBoundingBox(t){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(t);return this._pages[r].getBoundingBox(n)}readObjectIds(t,r=this._allFeatureIndices(),n=0){let s=n;for(const{page:i,indices:a}of this._batchPageIndices(r))s=i.readObjectIds(t,a,s);return s}readCoordinates(t,r=this._allFeatureIndices(),n=0){let s=n;for(const{page:i,indices:a}of this._batchPageIndices(r))s=i.readCoordinates(t,a,s);return s}*objectIds(t=this._allFeatureIndices()){for(const{page:r,indices:n}of this._batchPageIndices(t))for(const s of r.objectIds(n))yield s}exclude(t){if(t.size===0)return this;const{_addressTable:r,featureCount:n}=this,s=new Array;for(let i=0;i<n;++i){const a=this.getObjectId(i);t.has(a)||(s.push(r[2*i]),s.push(r[2*i+1]))}return new ae(this.descriptor,this._pages,s)}reset(){const{isComplete:t,_pages:r}=this;return t?this:new ae(this.descriptor,r)}*_allFeatureIndices(){const{featureCount:t}=this;for(let r=0;r<t;++r)yield r}_translateIndex(t){const{_addressTable:r}=this;return{pageIndex:r[2*t],featurePageIndex:r[2*t+1]}}*_batchPageIndices(t){const r=new Array;{let s=0,i=new Array;for(const a of t){const{pageIndex:d,featurePageIndex:o}=this._translateIndex(a);s!==d&&(i.length!==0&&r.push({pageIndex:s,indices:i}),s=d,i=[]),i.push(o)}i.length!==0&&r.push({pageIndex:s,indices:i})}const{_pages:n}=this;for(const{pageIndex:s,indices:i}of r)yield{page:n[s],indices:i}}};function ur(e){const t=e.reduce((s,{featureCount:i})=>s+i,0),r=new Array;if(t===0)return r;const n=e[0].featureCount;for(let s=0;s<t;++s)r[2*s]=Math.floor(s/n),r[2*s+1]=s%n;return r}let hr=class{constructor(e){this._reader=new ft(new Uint8Array(e),new DataView(e)),this._index=mr(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){const{_index:{fieldsIndex:r,attributeIndices:n}}=this,s=r.get(t)?.index;if(s==null)return;const i=n[e*r.fields.length+s],a=this._reader;return a.move(i),N(a)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return typeof r=="string"?new Date(r).getTime():typeof r=="number"||r==null?r:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:r}}=this,n=e*t.fields.length,s=this._reader,i={};for(const a of t.fields){const d=r[n+a.index];s.move(d),i[a.name]=N(s)}return i}getCoordinates(e,t,r=0){const n=this._reader,{transform:s,featureIndices:i}=this._index,{scale:a,translate:d}=s;n.move(i[e]),this._readCoordinates(a,d,t,r)}getOptimizedGeometry(e){const t=A();return this.getCoordinates(e,t),new J([],t)}getCentroid(e,{hasZ:t,hasM:r}){this.getCoordinates(e,T);const[n,s,i]=T,a=[n,s];return t&&(a[3]=i),r&&(a[t?4:3]=0),new J([],a)}getBounds(e){this.getCoordinates(e,T);const[t,r]=T,n=new ye;return n.minX=t,n.minY=r,n.maxX=t,n.maxY=r,n}getBoundingBox(e){this.getCoordinates(e,T);const[t,r,n]=T;return He(t,r,n,t,r,n)}readObjectIds(e,t=this._allFeatureIndices(),r=0){const n=this._reader,{objectIdFieldName:s,attributeIndices:i,fieldsIndex:a}=this._index,d=a.get(s).index,o=a.fields.length;for(const l of t){const c=i[l*o+d];n.move(c),e[r++]=N(n)}return r}readCoordinates(e,t=this._allFeatureIndices(),r=0){const n=this._reader,{transform:s,featureIndices:i}=this._index,{scale:a,translate:d}=s;for(const o of t){const l=i[o];n.move(l),r=this._readCoordinates(a,d,e,r)}return r}*objectIds(e=this._allFeatureIndices()){const t=this._reader,{objectIdFieldName:r,attributeIndices:n,fieldsIndex:s}=this._index,i=s.get(r).index,a=s.fields.length;for(const d of e){const o=n[d*a+i];t.move(o),yield N(t)}}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_readCoordinates([e,t,r],[n,s,i],a,d){const o=this._reader,l=o.getLength(),c=o.pos()+l;for(;o.pos()<c&&o.next();)switch(o.tag()){case 2:{const h=o.getLength(),m=o.pos()+h;for(;o.pos()<m&&o.next();)o.tag()===3?(o.getUInt32(),a[d++]=n+e*o.getSInt64(),a[d++]=s+t*o.getSInt64(),a[d++]=i+r*o.getSInt64()):o.skip();break}default:o.skip()}return d}};function mr(e){for(;e.next();){if(e.tag()===2)return fr(e.getMessage());e.skip()}U()}function fr(e){for(;e.next();){if(e.tag()===1)return pr(e.getMessage());e.skip()}U()}function pr(e){let t,r,n=!1,s=!1,i=0;const a=new Array,d=new Array,o=new Array;for(;e.next();)switch(e.tag()){case 1:r=e.getString();break;case 7:e.getEnum()!==0&&U();break;case 9:n=e.getBool()??!1;break;case 12:t=pt(e.processMessage(yt));break;case 13:{const c=e.processMessage(gt);c.index=i++,a.push(c);break}case 15:{d.push(e.pos());const c=e.getUInt32(),h=e.pos()+c;for(;e.pos()<h&&e.next();)e.tag()===1&&o.push(e.pos()),e.skip();break}case 10:s=e.getBool()??!1;break;default:e.skip()}const l=new _t(a);return t!=null&&s&&r!=null&&l.has(r)||U(),{transform:t,exceededTransferLimit:n,fieldsIndex:l,objectIdFieldName:r,featureIndices:d,attributeIndices:o}}function U(){const e=new Qe("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(e),e}function N(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}const T=A(),Re=8e3,_r=4,gr=4;let yr=class{constructor(e,t,r,n,s){this.spatialReference=e,this.url=r,this.objectIdField=n,this.capabilities=s;const{supportsMaxRecordCountFactor:i,maxRecordCount:a}=this.capabilities.query,d=i?_r:1,o=(a??Re)*d;this._pageSize=Math.min(Re,o);const l=t.clone();l.cacheHint=!0,l.resultType="tile",l.outSpatialReference=e,l.returnGeometry=!0,l.returnZ=!0,l.maxRecordCountFactor=d,l.num=this._pageSize,l.outFields=[n],this._baseQuery=l}async fetch(e,t){const{spatialReference:r}=this,n=We(e.extent,r),s=this._baseQuery.clone();s.geometry=n;const i=new Array;let a=0,d=!1,o=1;for(;!d;){const l=[];for(let h=0;h<o;++h)l.push(this._fetchPage(s,a++,t));const c=await Promise.all(l);j(t);for(const h of c){const m=h.featureCount!==0;d||=!h.exceededTransferLimit||!m,m&&i.push(h)}o=Math.min(o+1,gr)}return new cr(e,i)}async _fetchPage(e,t,r){const n=e.clone();n.start=t*this._pageSize;const s=(await mt(this.url,n,{signal:r})).data;return j(r),new hr(s)}},wr=class extends Bt{constructor(e=A()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}},z=class extends At{constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new wr,this._bufferWriter=null}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach(t=>e+=t.numElements/6),e}get usedMemory(){let e=0;return this._renderGeometries.forEach(t=>{e+=t.vao.usedMemory}),e}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((e,t)=>{this._produces.set(t,r=>r!==k.Highlight&&r!==k.ShadowHighlight&&e(r))})}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const t of e)this.removeRenderGeometry(t)}acquireTechniques(e){const t=this.material;if(!t.shouldRender(e))return null;const{output:r,bind:n}=e;return!t.produces.get(n.slot)?.(r)||r===k.Highlight||r===k.ShadowHighlight?null:this._glMaterials.load(e.rctx,n.slot,r)?.beginSlot(n)}render(e,t){const r=this._renderGeometries;if(r.size===0)return;const{bind:n}=e,s=n.slot===we.OCCLUDER_MATERIAL||n.slot===we.TRANSPARENT_OCCLUDER_MATERIAL?n.slot:null,i=e.rctx;i.runAppleAmdDriverHelper(),i.bindTechnique(t,n,this.material.parameters);const a=t.program;for(const[d,o]of r)this._drawParameters.origin=o.localOrigin,a.bindDraw(n,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(o.vao),i.bindVAO(o.vao),i.setPipelineState(t.getPipeline(!1,s)),i.drawArrays(t.primitiveType,0,o.numElements)}initializeRenderContext(e,t){this._glMaterials=new It(this.material,e.materials),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,St(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometry(e,t,r){this.removeRenderGeometry(e);const n=this._vaoCache.newVao(t.data.byteLength);n.vertexBuffers.get("geometry").setSubData(new Uint8Array(t.data),0,0,t.data.byteLength);const s={localOrigin:r,vao:n,numElements:t.elementCount};return this._renderGeometries.set(e,s),s}removeRenderGeometry(e){const t=this._renderGeometries.get(e);t!=null&&(this._vaoCache.deleteVao(t.vao),this._renderGeometries.delete(e))}hasHighlightOptions(e){return!1}};p([g({constructOnly:!0})],z.prototype,"material",void 0),z=p([E("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],z);let ee=class{constructor(e){this._optionalFields=new Array,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=e.layerUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._featureIdToInstanceIndex.size}get usedMemory(){return(this._lodRendererResources?.lodRenderer?.symbol?.computeUsedMemory()??0)+16*this._featureIdToInstanceIndex.size}destroy(){this._disposeResourceHandles.forEach(e=>e())}async doLoad(e,t,r){Z("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(_.OBJECTANDLAYERIDCOLOR);const n=br(o=>t(o),e),s=this.view._stage,i=n.getMaterials();s.addMany(i),this._addDisposeResource(()=>s.removeMany(i));const a=n.getTextures();s.addMany(a),this._addDisposeResource(()=>{a.forEach(o=>o.unload()),s.removeMany(a)}),await Promise.all(a.map(o=>this.view._stage.schedule(()=>o.load(s.renderView.renderingContext),r))),j(r);const d=await this._createLodRenderer(n,r);this._lodRendererResources={lodRenderer:d,materials:i,textures:a}}addInstances(e){const t=this._lodRendererResources;if(t==null)return;const{featureIds:r,localTransforms:n,globalTransforms:s}=e,i=t.lodRenderer;if(i==null)return;const a=i.instanceData,d=r.length;for(let o=0;o<d;++o){const l=r[o],c=a.addInstance(),h=a.view,m=16*o;h.localTransform.copyFromTypedBuffer(c,n,m),h.globalTransform.copyFromTypedBuffer(c,s,m),a.updateModelTransform(c),a.setVisible(c,!0),this._featureIdToInstanceIndex.set(l,c)}}removeInstances(e){const t=this._lodRendererResources;if(t==null)return;const r=t.lodRenderer.instanceData,n=this._featureIdToInstanceIndex,s=e.length;for(let i=0;i<s;++i){const a=e[i],d=n.get(a);d!=null&&(r.removeInstance(d),n.delete(a))}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,t){const r=this.view._stage,n={layerUid:this.layerUid,graphicUid:i=>1,notifyGraphicGeometryChanged:i=>1,notifyGraphicVisibilityChanged:i=>1},s=new vt({symbol:e,optionalFields:this._optionalFields,metadata:n,shaderTransformation:null},this.scheduler);return s.slicePlaneEnabled=!1,this._addDisposeResource(()=>{r.removeRenderPlugin(s),s.destroy()}),await r.addRenderPlugin(s,t),s}};function br(e,t){const r=t.levels.map(n=>{const s=n.components.map(i=>{const a=e(i.materialId);if(!xr(a))throw new Error("LodRenderer only supports DefaultMaterial");const d=new Lt(a,i.renderGeometryBuffer.data,i.renderGeometryBuffer.elementCount,i.boundingInfo);return new Dt(d)});return new jt(s,n.minScreenSpaceRadius)});return new kt(r)}function xr(e){return e!=null&&"materialType"in e&&e.materialType==="default"}ee=p([E("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],ee);let te=class extends oe{constructor(e){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=e.view,this.layerUid=e.layerUid}initialize(){}destroy(){this.removeAllHandles(),this._lodRenderers.forEach(e=>e.destroy())}async executeRenderCommands(e){for(const t of e)switch(t.id){case"create-material":await this._createMaterial(t);break;case"create-direct-renderer":await this._createDirectRenderer(t);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(t),this._updateFeatureCount();break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(t),this._updateFeatureCount();break;case"create-lod-renderer":await this._createLodRenderer(t);break;case"add-lod-instances":await this._addLodInstances(t),this._updateFeatureCount();break;case"remove-lod-instances":await this._removeLodInstances(t),this._updateFeatureCount()}}_updateFeatureCount(){let e=0;for(const t of this._directRenderers.values())e+=t.numFeatures;for(const t of this._lodRenderers.values())e+=t.numFeatures;this._set("totalFeatures",e)}get usedMemory(){let e=0;for(const t of this._directRenderers.values())e+=t.usedMemory;for(const t of this._lodRenderers.values())e+=t.usedMemory;return e}async _createMaterial(e){const{view:t}=this,{sharedSymbolResources:r}=t;if(r==null)throw new Error("No shared symbol resources found!");const{textures:n}=r,s=t.state.viewingMode===I.Global;let i=null;switch(e.type){case"default":i=Ir(r,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:t._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},s);break;case"hud":{const[a,d]=Se(n,s);this.addHandles([qe(()=>Ve(d))]),i=a}break;default:throw new Error(`unable to create unknown material type ${e.type}`)}this._materials.set(e.materialId,i)}_getMaterial(e){return this._materials.get(e)}async _createDirectRenderer(e){const t=e.materialId,r=this._getMaterial(t);if(r==null)throw new Error(`material not found ${t}`);const{view:n}=this,s=new z({material:r});this._directRenderers.set(t,s),n._stage.addRenderPlugin(s),n._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(e){const t=e.renderGeometryId,r=e.materialId;await this._removeDirectRendererGeometry({renderGeometryId:t});const n=this._directRenderers.get(r);if(n==null)return void console.error("no renderer assigned to provided material");const s=n.addRenderGeometry(t,e.renderGeometryBuffer,e.localOrigin);this._renderGeometries.set(t,{renderGeometry:s,materialId:r}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(e){const t=e.renderGeometryId,r=this._renderGeometries.get(t);if(r==null)return;const n=r.materialId,s=this._directRenderers.get(n);s!=null?s.removeRenderGeometry(e.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(e){const t=new ee({view:this.view,layerUid:this.layerUid}),r=new AbortController,n=s=>this._getMaterial(s);await t.doLoad(e.lodRenderGeometry,n,r.signal),this._lodRenderers.set(e.lodRendererId,t)}async _addLodInstances(e){const t=this._lodRenderers.get(e.lodRendererId);if(t==null)throw new Error("no lod renderer assigned to provided lod renderer Id");t.addInstances(e.data)}async _removeLodInstances(e){const t=this._lodRenderers.get(e.lodRendererId);if(t==null)throw new Error("no lod renderer assigned to provided lod renderer Id");t.removeInstances(e.featureIds)}};function Se(e,t){const r={anchorPosition:Ct.center,occlusionTest:!0,hasSlicePlane:!1,color:[1,0,0,1],outlineColor:[0,0,0,1],outlineSize:1,distanceFieldBoundingBox:Tt},n=null;if(e!=null){const s=e.fromData("circle-icon",()=>Mt("circle"));r.textureId=s.texture.id,r.textureIsSignedDistanceField=!0,r.sampleSignedDistanceFieldTexelCenter=Et("circle")}return[new Pt(r,t),n]}function Ir(e,t,r){const n={usePBR:t.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:Gt,ambient:ce,diffuse:ce,hasSlicePlane:t.slicePlaneEnabled,castShadows:t.castShadows,offsetTransparentBackfaces:!t.isPrimitive};return vr(n),n.screenSizePerspective=e.screenSizePerspectiveSettings,n.externalColor=xt,n.isInstanced=!0,new be(n,{spherical:r,doublePrecisionRequiresObfuscation:!0})}function vr(e){const t=e.opacity??1,r=t<1;return e.transparent=r,e.opacity=t,e.cullFace=r?xe.None:xe.Back,e}p([g({readOnly:!0})],te.prototype,"totalFeatures",void 0),te=p([E("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],te);let Ae=class{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){const r=this._bufferWriter;let n=null;if(e.transformation&&t)Ie(M,e.transformation),M[12]-=t[0],M[13]-=t[1],M[14]-=t[2],n=M;else{if(t)throw new Error("not implemented");e.transformation&&(n=e.transformation)}let s=null;n&&(Ut(H,M),Nt(H,H),s=H);const i=e.attributes,a=r.elementCount(i),d=r.vertexBufferLayout.stride/4;a>Math.floor(Cr/d)&&console.warn("geometry with very large number of elements encountered");const o=r.vertexBufferLayout.createBuffer(a);return r.write(n,s,i,e.objectAndLayerIdColor,o,0),{data:o.buffer,elementCount:a}}};const M=B(),H=B(),Cr=16777216/4;let Rr=class{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){const t=this._context,r=t.generateId("material");switch(e){case"default":{const n=new be({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),s=new Ae(n);t.registerRenderGeometryBufferWriter(r,s)}break;case"hud":{const n=Se(null,this._context.globalViewingMode)[0],s=new Ae(n);t.registerRenderGeometryBufferWriter(r,s)}}return this._commands.push({id:"create-material",type:e,materialId:r}),r}createDirectRenderer(e){const t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,r){const n=t.materialId,s=this._context.getRenderGeometryBufferWriter(n);if(s==null)throw new Error(`no bufferwriter found for material ${n}`);const i=s.createBuffer(t,r);this._transferables.add(i.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:n,renderGeometryBuffer:i,localOrigin:r})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){const t=this._context.generateId("lod-renderer"),r={levels:e.levels.map(n=>({components:n.components.map(s=>{const i=s.attributes.get(_.POSITION);if(!i||i.indices.length===0)throw new Error("positions attribute expected");const a=3,d=wt(i.indices.length/a),o=new Ft(d,a,i),l=this._context.getRenderGeometryBufferWriter(s.materialId);if(l==null)throw new Error("writer not found");const c=l.createBuffer(s,null);return this._transferables.add(c.data),{materialId:s.materialId,renderGeometryBuffer:c,boundingInfo:{bbMax:o.bbMax,bbMin:o.bbMin}}}),minScreenSpaceRadius:n.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:r}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}append(e){if(e._context!==this._context)throw new Error("Cannot append encoders from different contexts");const{_commands:t,_transferables:r}=this;for(const n of e._commands)t.push(n);for(const n of e._transferables)r.add(n)}async dispatch(){const e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),await this._context.dispatchRenderCommands(e,t)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}};class Sr{constructor(t){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=t.viewingMode===I.Global,this._dispatchRenderCommandsCallback=t.dispatchRenderCommandsCallback}generateId(t=""){return`${t}${this._idCounter++}`}createEncoder(){return new Rr(this)}async dispatchRenderCommands(t,r){t.length!==0&&await this._dispatchRenderCommandsCallback(t,r)}registerRenderGeometryBufferWriter(t,r){this._bufferWriters.set(t,r)}getRenderGeometryBufferWriter(t){return this._bufferWriters.get(t)}}let re=class{constructor(e,t){this._renderCommands=e,this._pipelineStateCommands=t}append(e){this.appendRenderCommands(e._renderCommands),this.appendPipelineStateCommands(e._pipelineStateCommands)}appendRenderCommands(e){this._renderCommands.append(e)}appendPipelineStateCommand(e){this._pipelineStateCommands.push(e)}appendPipelineStateCommands(e){const{_pipelineStateCommands:t}=this;for(const r of e)t.push(r)}execute(){for(const e of this._pipelineStateCommands)e();this._renderCommands.dispatch()}};function ne(e,t){const{featureCount:r}=e;if(r===0)return new Uint32Array;const n=new Uint32Array(r);return e.readObjectIds(n),n}function Te(e,t){const{featureCount:r}=e;if(r===0)return new Float64Array;const n=new Float64Array(3*r);return e.readCoordinates(n),n}function Ar(e,t){const{featureCount:r}=e;if(r===0)return new Float64Array;const n=Te(e),s=t.viewSpatialReference,i=t.renderSpatialReference,a=new Float64Array(3*r);if(!Wt(n,s,0,a,i,0,r))throw new Error("Failed to project coordinates");return a}function Tr(e,t){const r=t.viewSpatialReference,n=t.renderSpatialReference,{extent:s}=e,i=$e(s),a=A();return Y([i[0],i[1],0],r,a,n),a}function Me(e){const t=new Map;for(const[r,n]of e)t.set(r,{...n,indices:bt(n.indices)});return t}function Mr(e,t){const r=(n,s,i=!1)=>({levels:n.map(a=>{const d=Me(s(a.tesselation));return i&&Pr(d),{components:[{attributes:d,objectAndLayerIdColor:void 0,transformation:null,materialId:t}],minScreenSpaceRadius:a.minScreenSpaceRadius}})});switch(e){case"cone":return r(Er,n=>Vt(1,.5,n,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function Pr(e){const t=e,r=t.get(_.POSITION).data,n=t.get(_.NORMAL).data;if(n){const s=Pe(e,_.NORMAL).data;for(let i=0;i<n.length;i+=3){const a=n[i+1];s[i+1]=-n[i+2],s[i+2]=a}}if(r){const s=Pe(e,_.POSITION).data;for(let i=0;i<r.length;i+=3){const a=r[i+1];s[i+1]=-r[i+2],s[i+2]=a}}}function Pe(e,t){let r=e.get(t);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:Ot(r.data)},e.set(t,r)),r}const Er=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class Fr{constructor(t){this._context=t,this.lodRendererId=null,this._loaded=!1,this._loadingPromise=null,this._primitive="cone"}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const t=this._context.renderCommandContext.createEncoder(),r=t.createMaterial("default"),n=Mr(this._primitive,r);this.lodRendererId=t.createLodRenderer(n),await t.dispatch(),this._loaded=!0}async createAddCommand(t){const r=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");const{featureCount:n}=t;if(n===0)return r;const s=!0,i=Ze(Je(this._primitive)),a=ue(Ye(i)),d=ue(Xe(a,{isPrimitive:s,width:100,depth:null,height:null})),o=new Float64Array(16*n),l=new Float64Array(16*n),c=Te(t,this._context);for(let u=0;u<n;++u){const f=u,x=c[3*u+0],R=c[3*u+1],S=c[3*u+2],V=this._computeGlobalTransform(x,R,S,this._context.viewSpatialReference,Br),$=this._computeLocalTransform(d,a,Or);this._writeMatrixToTypedBuffer(o,f,$),this._writeMatrixToTypedBuffer(l,f,V)}const h=ne(t,this._context),m={featureIds:new Uint32Array(h),localTransforms:o,globalTransforms:l};return r.addLodInstances(this.lodRendererId,m),r}async createRemoveCommand(t){const r=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)return r;const n=ne(t,this._context);return r.removeLodInstances(this.lodRendererId,n),r}_writeMatrixToTypedBuffer(t,r,n){let s=16*r;for(let i=0;i<16;i++)t[s++]=n[i]}_computeGlobalTransform(t,r,n,s,i){return Q[0]=t,Q[1]=r,Q[2]=n,qt(s,Q,i,this._context.renderSpatialReference),i}_computeLocalTransform(t,r,n){return zt(n),this._applyObjectScale(t,r,n),n}_applyObjectScale(t,r,n){const s=$t(t,t,r,this._context.renderCoordsHelper.unitInMeters);s[0]===1&&s[1]===1&&s[2]===1||Ht(n,n,s)}}const Q=A(),Or=B(),Br=B();class Gr{constructor(t){this._context=t,this.materialId=null,this._loaded=!1,this._loadingPromise=null}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const t=this._context.renderCommandContext.createEncoder();this.materialId=t.createMaterial("hud"),t.createDirectRenderer(this.materialId),await t.dispatch(),this._loaded=!0}async createAddCommand(t){const r=this._context.renderCommandContext.createEncoder();if(this.materialId==null)throw new Error("expected material not to be null");const{featureCount:n,id:s}=t;if(n===0)return r;const i=Ar(t,this._context),a=Tr(t,this._context),d=new Float64Array([0,0,1]),o=new Float64Array([255,255,255,255]),l=new Float64Array([24,24]),c=new Float64Array([0,0,0,1]),h=new Float64Array([0,0]),m=new Float64Array([0]),u=new Uint32Array(n);for(let w=0;w<n;++w)u[w]=w;const f=new Uint32Array(n);for(let w=0;w<n;++w)f[w]=0;const x=new v(i,u,3,!0),R=new v(d,f,3,!0),S=new v(h,f,2,!0),V=new v(o,f,4,!0),$=new v(m,f,1,!0),Ge=new v(l,f,2,!0),Le=new v(c,f,4,!0),De=[[_.POSITION,x],[_.NORMAL,R],[_.UV0,S],[_.COLOR,V],[_.ROTATION,$],[_.SIZE,Ge],[_.CENTEROFFSETANDDISTANCE,Le]],je={attributes:Me(De),objectAndLayerIdColor:void 0,transformation:B(),materialId:this.materialId};return r.addDirectRendererGeometry(s,je,a),r}async createRemoveCommand(t){const r=this._context.renderCommandContext.createEncoder();return r.removeDirectRendererGeometry(t.id),r}}class Lr{constructor(t){this._symbols=new Array,this._featureDataPartitioning=new Map,this._context=t}async load(){this._symbols[0]=new Gr(this._context),this._symbols[1]=new Fr(this._context)}async createAddCommand(t){const r=this._partition(t),n=await Promise.all(r.map(async({index:i,features:a})=>await(await this._provisionSymbol(i))?.createAddCommand(a))),s=this._context.renderCommandContext.createEncoder();for(const i of n)i!=null&&s.append(i);return new re(s,[()=>{this._featureDataPartitioning.set(t,r)}])}async createRemoveCommand(t){const{_featureDataPartitioning:r}=this,n=r.get(t),s=this._context.renderCommandContext.createEncoder();if(n==null)return new re(this._context.renderCommandContext.createEncoder(),[]);const i=await Promise.all(n.map(async({index:a,features:d})=>await this._getLoadedSymbol(a)?.createRemoveCommand(d)));for(const a of i)a!=null&&s.append(a);return new re(s,[()=>{r.delete(t)}])}async _provisionSymbol(t){if(t==null)return null;const r=this._symbols[t];return r?(r.loaded||await r.load(),r):null}_getLoadedSymbol(t){if(t==null)return null;const r=this._symbols[t];return r!=null&&r.loaded?r:null}_partition(t){const r=ne(t,this._context);if(r==null)throw new Error("unable to fetch objectIds");const{featureCount:n}=t,s=[[],[]];for(let i=0;i<n;++i)s[r[i]%2].push(i);return s.map((i,a)=>new Dr(a,t.subset(new Uint32Array(i)))).filter(i=>i.features.featureCount>0)}}class Dr{constructor(t,r){this.index=t,this.features=r}}function jr(e){const{value:t,operations:r}=e;return{operations:r,value:r.create(t)}}function kr(e,t,r){return e.operations.setExtent(e.value,t,r.value),r}function Ur(e,t){return e.operations.getExtent(e.value,t),t}function Nr(e){return{operations:e,value:e.create()}}function Ee(e,t,r=Nr(e)){return r.operations=e,e.copy(t,r.value),r}function zr(e){return Ee(tr,er(0,0,0,he(e).radius))}const Fe=2**50;function Hr(){return Ee(Kt,Xt([0,0,0],[Fe,0,0],[0,Fe,0]))}function Qr(e,t,r){return e.operations.axisAt(e.value,t,F.Z,r)}function Wr(e,t,r,n){return e.operations.axisAt(e.value,t,r,n)}function qr(e,t,r){return e.operations.intersectRay(e.value,t,r)}function Vr(e,t,r){return e.operations.intersectRayClosestSilhouette(e.value,t,r)}function $r(e,t){return e.operations.altitudeAt(e.value,t)}function Oe(e,t,r,n){return e.operations.setAltitudeAt(e.value,t,r,n)}function Zr(e,t,r,n){return t!==n&&Ie(n,t),Zt(P,n[12],n[13],n[14]),Oe(e,P,r,P),n[12]=P[0],n[13]=P[1],n[14]=P[2],n}function se(e,t,r){return e.operations.elevate(e.value,t,r.value)}const P=A();class q{constructor(t,r,n,s){this.viewingMode=t,this.spatialReference=r,this.unitInMeters=n,this._coordinateSystem=s,this._tmpCoordinateSystem=jr(s),this.referenceEllipsoid=he(r),this.sphericalPCPF=Jt(r)}set extent(t){t&&kr(this._coordinateSystem,t,this._coordinateSystem)}get extent(){return Ur(this._coordinateSystem,Ke())}getAltitude(t){return $r(this._coordinateSystem,t)}setAltitude(t,r,n=t){return Oe(this._coordinateSystem,n,r,t)}setAltitudeOfTransformation(t,r){Zr(this._coordinateSystem,r,t,r)}worldUpAtPosition(t,r){return Qr(this._coordinateSystem,t,r)}worldBasisAtPosition(t,r,n){return Wr(this._coordinateSystem,t,r,n)}basisMatrixAtPosition(t,r){const n=this.worldBasisAtPosition(t,F.X,C.get()),s=this.worldBasisAtPosition(t,F.Y,C.get()),i=this.worldBasisAtPosition(t,F.Z,C.get());return Qt(r,n[0],n[1],n[2],0,s[0],s[1],s[2],0,i[0],i[1],i[2],0,0,0,0,1),r}headingAtPosition(t,r){const n=this.worldUpAtPosition(t,C.get()),s=this.worldBasisAtPosition(t,F.Y,C.get()),i=rr(r,s,n);return et(i)}intersectManifoldClosestSilhouette(t,r,n){return se(this._coordinateSystem,r,this._tmpCoordinateSystem),Vr(this._tmpCoordinateSystem,t,n),n}intersectManifold(t,r,n){se(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=C.get();return qr(this._tmpCoordinateSystem,t,s)?Ce(n,s):null}intersectInfiniteManifold(t,r,n){if(this.viewingMode===I.Global)return this.intersectManifold(t,r,n);se(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=this._tmpCoordinateSystem.value,i=C.get();return nr(s.plane,t,i)?Ce(n,i):null}toRenderCoords(t,r,n){return ve(t)?Yt(t,r,this.spatialReference):Y(t,r,n,this.spatialReference)}fromRenderCoords(t,r,n=null){return ve(r)?(n!=null&&(r.spatialReference=n),Rt(t,this.spatialReference,r)?r:null):Y(t,this.spatialReference,r,n)?r:null}static create(t,r){switch(t){case I.Local:return new q(I.Local,r,tt(r),Hr());case I.Global:return new q(I.Global,r,1,zr(r))}}static renderUnitScaleFactor(t,r){return me(t)/me(r)}}let W=class extends le.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureDataStore=new or,this._featureStore=new lr,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager?.destroy()}async setup({viewSpatialReference:e,renderSpatialReference:t,viewingMode:r,baseQuery:n,url:s,objectIdField:i,capabilities:a,fieldsIndex:d,timeInfo:o,fullExtent:l}){const c=fe.fromJSON(e),h=fe.fromJSON(t);this._fetcher=new yr(c,pe.fromJSON(n),s,i,a),this._queryEngine=new ot({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:i,fieldsIndex:d,availableFields:[i],spatialReference:e,featureStore:this._featureStore,timeInfo:o}),this._renderer=new Lr({viewSpatialReference:c,renderSpatialReference:h,renderCoordsHelper:q.create(r,h),renderCommandContext:new Sr({viewingMode:r,dispatchRenderCommandsCallback:(u,f)=>this.remoteClient.invoke("dispatchRenderCommands",u,{transferList:f})})}),this._defaultQueryJSON=new pe({outSpatialReference:c}).toJSON();let m=null;if(l!=null){const u=rt.fromJSON(l);await it(u.spatialReference,c),m=at(u,c)}return this._tileManager=new y({loadTile:(u,f)=>this._fetcher.fetch(u,f),createAddTileCommand:(u,f)=>this._createAddTileCommand(u,f),createRemoveTileCommand:u=>this._createRemoveTileCommand(u),extent:m}),this.addHandles(nt(()=>this.updating,u=>{this.emit("notify-updating",{updating:u})}),st),await this._renderer.load(),Be}async executeQuery(e,t){return{result:await this._queryEngine.executeQuery(this._ensureQuery(e),t)}}async executeQueryForIds(e,t){const r=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(e),t);return{result:Array.from(r)}}async executeQueryForCount(e,t){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(e),t)}}async executeQueryForExtent(e,t){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t)}}async executeQueryForLatestObservations(e,t){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),t)}}async onTileTreeChange(e){return await this._tileManager.onTileTreeChange(e),Be}async _createAddTileCommand(e,t){const r=new ar(e),n=await this._renderer.createAddCommand(r);return j(t),n.appendPipelineStateCommand(()=>{this._featureDataStore.add(r),this._featureStore.addTile(e)}),n}async _createRemoveTileCommand(e){const t=this._featureStore,r=this._featureDataStore,n=this._renderer,s=r.get(e);if(s==null)return null;const i=await n.createRemoveCommand(s);return i.appendPipelineStateCommand(()=>{r.remove(e),t.removeTile(e)}),i}_ensureQuery(e){return e??this._defaultQueryJSON}};p([g()],W.prototype,"updating",null),W=p([E("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],W);const Jr=W,Be={result:void 0};export{Jr as default};
