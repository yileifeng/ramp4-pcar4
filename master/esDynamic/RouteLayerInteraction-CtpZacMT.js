import{x as h,z as c,K as I,aL as W,V as N,n as be,dq as tt,cI as it,aI as z,fx as ot,fL as at,b_ as re,aM as H,dm as Q,a_ as st,aH as rt,T as ne,g5 as nt,eU as pt,dJ as Ee,dK as lt,dH as ht,jN as ct,jO as dt,aO as we,Q as F,aN as ut,gr as pe,u as Se,bh as yt,jP as gt,gm as vt,jQ as P,e8 as Te,s as mt,fG as Oe,bB as ft,hc as Y,eP as Ge,df as _t,e5 as bt}from"./main-BC8gbEPx.js";import{h as Me}from"./UpdatingHandles-MKkd7IEO.js";import Pe from"./GraphicsLayer-l3ld2Cmz.js";import{a as Et,j as wt,T as St,w as Tt}from"./Stop-Bb-Wd5iU.js";import{O as le,Q as Ot,L as Gt,k as Mt,K as Pt}from"./projection-CS2SYuKw.js";import{v as Ce,l as Ct,f as Rt,x as kt,j as he}from"./elevationInfoUtils-CPumv29T.js";import{_ as w,n as Re}from"./MapView-CCgzpEAk.js";import{p as X,i as C,z as At,A as R,B as k,L as Dt,g as It,C as Ht,R as ke,n as Ae,D as xt,F as De,G as Ut,s as Ie,H as $,b as ce,K as He,E as Lt,u as Nt,l as xe,O as Ft,v as Vt,m as b,P as jt,Q as Yt,S as qt}from"./hitTestSelectUtils-B7FrClWM.js";import{c as Bt,u as Kt,H as J,I as Zt,s as Wt}from"./vec32-CKLwdlap.js";import{m as zt}from"./vec2-BnynUbeJ.js";import{e as Qt}from"./projectVectorToVector-B5ubG6d0.js";function Ue(e){switch(e){case f.SUPPORTED:break;case f.GRAPHICS_LAYER_MISSING:return"not owned by a graphics layer";case f.GEOMETRY_MISSING:return"no geometry";case f.GEOMETRY_TYPE_UNSUPPORTED:return"the geometry type is not supported";case f.ELEVATION_MODE_UNSUPPORTED:return"the elevation mode is not supported";case f.SYMBOL_TYPE_UNSUPPORTED:return"the symbol type is not supported"}return""}var f;(function(e){e[e.SUPPORTED=0]="SUPPORTED",e[e.GRAPHICS_LAYER_MISSING=1]="GRAPHICS_LAYER_MISSING",e[e.GEOMETRY_MISSING=2]="GEOMETRY_MISSING",e[e.GEOMETRY_TYPE_UNSUPPORTED=3]="GEOMETRY_TYPE_UNSUPPORTED",e[e.ELEVATION_MODE_UNSUPPORTED=4]="ELEVATION_MODE_UNSUPPORTED",e[e.SYMBOL_TYPE_UNSUPPORTED=5]="SYMBOL_TYPE_UNSUPPORTED"})(f||(f={}));function Le(e){if(e.graphic&&e.graphic.layer?.type!=="graphics")return f.GRAPHICS_LAYER_MISSING;const t=e.operations?.data.type;if(!t)return f.GEOMETRY_TYPE_UNSUPPORTED;switch(t){case"polygon":case"point":case"polyline":case"mesh":break;default:return f.GEOMETRY_TYPE_UNSUPPORTED}const i=e.elevationInfo;return Ce(i)?f.ELEVATION_MODE_UNSUPPORTED:f.SUPPORTED}function Xt(e){return $t(e).result}function $t(e){if(e.graphic&&e.graphic.layer?.type!=="graphics")return{result:f.GRAPHICS_LAYER_MISSING};if(!e.operations)return{result:f.GEOMETRY_MISSING};if(Ce(e.elevationInfo))return{result:f.ELEVATION_MODE_UNSUPPORTED};const t=e.operations.data.type,i=e.operations.data.geometry;return t==="point"||t==="mesh"||t==="polyline"||t==="polygon"?{result:f.SUPPORTED,geometry:i}:{result:f.GEOMETRY_TYPE_UNSUPPORTED}}function Jt(e){if(e.layer?.type!=="graphics")return f.GRAPHICS_LAYER_MISSING;if(e.geometry==null)return f.GEOMETRY_MISSING;switch(e.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return f.SUPPORTED;default:return f.GEOMETRY_TYPE_UNSUPPORTED}const t=e.symbol!=null&&e.symbol.type==="point-3d"&&e.symbol.symbolLayers;return!t||!t.some(i=>i.type==="object")?f.SYMBOL_TYPE_UNSUPPORTED:Ct(e)!=="on-the-ground"&&Rt(e)?f.ELEVATION_MODE_UNSUPPORTED:f.SUPPORTED}function de(e,t,i){if(!t||!e?.map)return;const{map:o}=e,a=o.layers.find(s=>s===t);a||o.add(t,i),a&&i!=null&&o.layers.reorder(a,i)}function ei(e,t){const i=t?.type==="subtype-sublayer"?t.parent:t;return e.allLayerViews.find(o=>{const a=o.layer;return a===i||"sublayers"in a&&a.sublayers!=null&&a.sublayers.includes(i)})}let x=class extends W{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1,this.sublayerSources=new N}};h([c({constructOnly:!0})],x.prototype,"layer",void 0),h([c()],x.prototype,"enabled",void 0),h([c()],x.prototype,"updating",void 0),h([c()],x.prototype,"availability",void 0),h([c()],x.prototype,"sublayerSources",void 0),x=h([I("esri.views.interactive.snapping.FeatureSnappingLayerSource")],x);const Ne=x;let S=class extends W{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.forceDisabled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.gridEnabled=!1,this.attributeRulesEnabled=!1,this.featureSources=new N,this.distance=X.distance,this.touchSensitivityMultiplier=X.touchSensitivityMultiplier}get effectiveEnabled(){return!this.forceDisabled&&(this.enabledToggled?!this.enabled:this.enabled)}get effectiveGridEnabled(){return this.effectiveEnabled&&this.gridEnabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}get _effectiveFeatureSources(){const e=this.featureSources;e.some(Fe)&&be.getLogger(this).warnOnce("Do not configure SubtypeGroupLayer sources in SnappingOptions.featureSources directly. Create a FeatureSnappingLayerSource for each SubtypeSublayer.");const t=e.filter(ii),i=this._get("_effectiveFeatureSources")?.filter(Fe)??new N;for(const r of t){const l=i.find(n=>n.layer===r.layer.parent);if(l)l.sublayerSources.includes(r)||l.sublayerSources.add(r);else if(r.layer.parent){const n=new Ne({layer:r.layer.parent});n.sublayerSources.add(r),i.add(n)}}for(const r of i){const l=r.sublayerSources.filter(n=>!t.includes(n));r.sublayerSources.removeMany(l)}i.removeMany(i.filter(r=>r.sublayerSources.length===0));const o=e.filter(ti),a=this._get("_effectiveFeatureSources")??new N,{added:s,removed:p}=tt(a.toArray(),[...o,...i]);return a.removeMany(p),a.addMany(s),a}};h([c()],S.prototype,"enabled",void 0),h([c()],S.prototype,"enabledToggled",void 0),h([c()],S.prototype,"forceDisabled",void 0),h([c()],S.prototype,"selfEnabled",void 0),h([c()],S.prototype,"featureEnabled",void 0),h([c()],S.prototype,"gridEnabled",void 0),h([c()],S.prototype,"attributeRulesEnabled",void 0),h([c({type:N.ofType(Ne)})],S.prototype,"featureSources",void 0),h([c()],S.prototype,"distance",void 0),h([c()],S.prototype,"touchSensitivityMultiplier",void 0),h([c({readOnly:!0})],S.prototype,"effectiveEnabled",null),h([c({readOnly:!0})],S.prototype,"effectiveGridEnabled",null),h([c({readOnly:!0})],S.prototype,"effectiveSelfEnabled",null),h([c({readOnly:!0})],S.prototype,"effectiveFeatureEnabled",null),h([c({readOnly:!0})],S.prototype,"_effectiveFeatureSources",null),S=h([I("esri.views.interactive.snapping.SnappingOptions")],S);const ue=S;function Fe(e){return e.layer.type==="subtype-group"}function ti(e){return e.layer.type!=="subtype-group"}function ii(e){return e.layer.type==="subtype-sublayer"}class V{constructor(t,i,o,a){this.targetPoint=t,this.constraint=i,this.isDraped=o,this.domain=a}}let ye=class extends V{constructor({targetPoint:e,objectId:t,constraint:i,isDraped:o}){super(e,i,o,C.FEATURE),this.objectId=t}},Ve=class extends ye{constructor(e){super({...e,isDraped:!0,constraint:new At(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new R(k.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},je=class extends ye{constructor(e){super({...e,constraint:new Dt(e.edgeStart,e.edgeEnd)})}get hints(){return[new R(k.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},q=class extends V{constructor(e,t,i,o){super(e,new It(e),o,C.ALL),this.first=t,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Ht(this.targetPoint,this.isDraped,this.domain)]}};class Ye extends V{constructor({lineStart:t,lineEnd:i,targetPoint:o,isDraped:a}){super(o,new ke(t,i),a,C.SELF),this._referenceLineHint=new R(k.REFERENCE_EXTENSION,t,i,a,this.domain)}get hints(){return[this._referenceLineHint,new R(k.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}}let qe=class extends V{constructor({referenceLine:e,lineStart:t,targetPoint:i,isDraped:o}){const a=it(t),{left:s,right:p}=e;Bt(a,Kt(a,a,p),s),super(i,new ke(t,Ae(a)),o,C.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new R(k.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new xt(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new R(k.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{J(e.right,i.edge.left)&&(i.fadeLeft=!1,t.fadeRight=!1),J(e.right,i.edge.right)&&(i.fadeRight=!1,t.fadeRight=!1),J(e.left,i.edge.right)&&(i.fadeRight=!1,t.fadeLeft=!1),J(e.left,i.edge.left)&&(i.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}},Be=class extends V{constructor({targetPoint:e,constraint:t,previousVertex:i,otherVertex:o,otherVertexType:a,isDraped:s,selfSnappingType:p,objectId:r,domain:l}){super(e,t,s,l??C.SELF),this.previousVertex=i,this.otherVertex=o,this.otherVertexType=a,this.selfSnappingType=p??K.None,this.objectId=r??null}get hints(){const e=this.previousVertex,t=this.otherVertexType===B.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===B.CENTER?this.targetPoint:this.otherVertex;return[new R(k.TARGET,t,i,this.isDraped,this.domain),new R(k.REFERENCE,e,t,this.isDraped,this.domain),new De(this.previousVertex,t,i,this.isDraped,this.domain)]}};var B,K;(function(e){e[e.NEXT=0]="NEXT",e[e.CENTER=1]="CENTER"})(B||(B={})),function(e){e[e.None=0]="None",e[e.LastVertex=1]="LastVertex",e[e.FirstVertex=2]="FirstVertex",e[e.ExistingEdge=3]="ExistingEdge"}(K||(K={}));let Ke=class extends V{constructor({targetPoint:e,point1:t,point2:i,isDraped:o}){super(e,new Ut(Ae(Zt(z(),t,i,.5)),.5*zt(Ie(t),Ie(i))),o,C.SELF),this._p1=t,this._p2=i}get hints(){return[new R(k.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new R(k.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new De(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}};function Ze(e,t,i,o,a=z()){const s=Wt(oi,e);return s[2]=kt(o,s,t,i)||0,o.renderCoordsHelper.toRenderCoords(s,t,a),a}const oi=z();function We(e,t,i,o){return o.type==="2d"?(ee.x=e[0],ee.y=e[1],ee.spatialReference=t,o.toScreen(ee)):(Ze(e,t,i,o,ze),o.state.camera.projectToScreen(ze,ge),ot(ge[0],ge[1]))}const ee=Qt(0,0,0,null),ze=z(),ge=at();let M=class extends re.EventedMixin(W){constructor(e){super(e),this.options=new ue,this._engineCache=new Map,this._loadTask=null,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=A.MAIN}initialize(){this.addHandles([H(()=>{const{distance:e,touchSensitivityMultiplier:t,effectiveSelfEnabled:i,effectiveFeatureEnabled:o,effectiveGridEnabled:a}=this.options;return{selfEnabled:i,featureEnabled:o,gridEnabled:this.view.type==="2d"&&a,viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,distance:e,touchSensitivityMultiplier:t}},(e,t)=>{t&&(this.doneSnapping(),this.emit("changed")),this._loadTask?.abort(),this._loadTask=st(i=>this._updateEngines(e,t,i))},Q),H(()=>this.options,e=>{for(const t of this._engines)t.options=e},rt)])}destroy(){this._loadTask?.abort(),this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)||!this._loadTask?.finished}_destroyEngines(){this._engineCache.forEach(e=>e.destroy()),this._engineCache.clear(),this._engines=[]}async _updateEngines(e,t,i){if(!e.viewReady)return void this._destroyEngines();t?.viewSpatialReference!==e.viewSpatialReference&&this._destroyEngines();const o=this._engineCache,a=await Promise.allSettled([e.featureEnabled&&!o.has("feature")?this._createFeatureSnappingEngine(i):void 0,e.selfEnabled&&!o.has("self")?this._createSelfSnappingEngine(i):void 0,e.gridEnabled&&!o.has("grid")?this._createGridSnappingEngine(i):void 0]);if(i.aborted)for(const s of a)s.status==="fulfilled"&&s.value?.engine.destroy();else{for(const s of a)s.status==="fulfilled"&&s.value&&o.set(s.value.type,s.value.engine);this._engines=Array.from(o.values())}}async _createSelfSnappingEngine(e){const{SelfSnappingEngine:t}=await import("./SelfSnappingEngine-Bz-g4w-d.js");return ne(e),{type:"self",engine:new t({view:this.view,options:this.options})}}async _createGridSnappingEngine(e){const{view:t}=this;if(t.type!=="2d")return;const{GridSnappingEngine:i}=await import("./GridSnappingEngine-DRwVXONn.js");return ne(e),{type:"grid",engine:new i({view:t,options:this.options})}}async _createFeatureSnappingEngine(e){const{FeatureSnappingEngine:t}=await import("./FeatureSnappingEngine-DsdGrCAB.js");ne(e);const{view:i,options:o}=this,{spatialReference:a}=i;return{type:"feature",engine:new t({view:i,options:o,spatialReference:a})}}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}snap(e){return ri(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){const{point:t,context:i}=e;this._removeVisualization();const o=this._currentMainCandidate;if(o==null)return t;const a=this._selectUpdateInput(e);if(a==null)return t;const{spatialReference:s}=i,p=le(a,s);if(p==null)return t;const{view:r}=this,{elevationInfo:l,visualizer:n}=i,u=[],g=$(p,r,l),m=o.constraint.closestTo(g);if(!this._arePointsWithinScreenThreshold(g,m,i)||!me(o,i.drawConstraints))return this._resetSnappingState(),t;o.targetPoint=ce(m),u.push(...o.hints);for(const y of this._currentOtherActiveCandidates)me(y,i.drawConstraints)&&(y.targetPoint=ce(m),u.push(...y.hints));return n!=null&&this.addHandles(n.draw(u,{spatialReference:s,elevationInfo:ni(i),view:r,selfSnappingZ:i.selfSnappingZ}),ve),He(m,r,t,i)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case A.MAIN:return e;case A.SCENE:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=A.MAIN}_removeVisualization(){this.removeHandles(ve)}async _snapSinglePoint({point:e,context:t,signal:i}){const{view:o}=this,{elevationInfo:a}=t,s=$(e,o,a),p=await this._fetchCandidates(s,C.ALL,t,i);return this._createSnapResult(s,A.MAIN,p,o,e,t,i)}async _snapMultiPoint({point:e,scenePoint:t,context:i,signal:o}){const{view:a}=this,{coordinateHelper:s,elevationInfo:p,spatialReference:r}=i;await Ot(t.spatialReference,r);const l=le(t,r),n=$(l,a,p),u=await this._fetchCandidates(n,C.FEATURE,i,o);if(u.length>0){const y=await this._fetchCandidates(n,C.SELF,i,o);return this._createSnapResult(n,A.SCENE,[...u,...y],a,l,i,o)}const g=$(e,a,p),m=await this._fetchCandidates(g,C.SELF,i,o);return this._createSnapResult(g,A.MAIN,m,a,{z:s.hasZ()&&e.hasZ?e.z??0:void 0,m:s.hasM()&&e.hasM?e.m??0:void 0},i,o)}async _fetchCandidates(e,t,i,o){return(await Promise.all(this._engines.map(a=>a.fetchCandidates(e,t,i,o)))).flat()}_createSnapResult(e,t,i,o,a,s,p){return{get valid(){return!nt(p)},apply:()=>{const{spatialReference:r}=s,{snappedPoint:l,hints:n}=this._processCandidates(e,t,i,s);return this._removeVisualization(),s.visualizer!=null&&this.addHandles(s.visualizer.draw(n,{spatialReference:r,elevationInfo:he,view:o,selfSnappingZ:s.selfSnappingZ}),ve),He(l,o,a,s)}}}_processCandidates(e,t,i,o){if(i.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),Lt(e,i);const a=this._currentMainCandidate;if(a!=null){const s=si(a,i);if(s>=0){if(!(i[s]instanceof q))return this._intersectWithOtherCandidates(s,i,e,t,o);if(this._arePointsWithinScreenThreshold(e,a.targetPoint,o))return this._updateSnappingCandidate(a,t,i,o)}}return this._intersectWithOtherCandidates(0,i,e,t,o)}_intersectWithOtherCandidates(e,t,i,o,a){const{coordinateHelper:s}=a,p=t[e],r=[];for(let l=0;l<t.length;++l){if(l===e)continue;const n=t[l],u=p.constraint.intersect(n.constraint);if(u)for(const g of u.closestPoints(p.targetPoint))r.push([new q(ce(g),p,n,n.isDraped),this._squaredScreenDistance(i,g,s)])}return r.length>0&&(r.sort((l,n)=>l[1]-n[1]),r[0][1]<this._squaredPointProximityThreshold(a.pointer))?this._updateSnappingCandidate(r[0][0],o,t,a):me(p,a.drawConstraints)?this._updateSnappingCandidate(p,o,t,a):{snappedPoint:i,hints:[]}}_updateSnappingCandidate(e,t,i,o){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;const a=this._currentMainCandidate.targetPoint,s=[];s.push(...e.hints);for(const p of i){if(e instanceof q){if(p.constraint.equals(e.first.constraint)||p.constraint.equals(e.second.constraint))continue}else if(p.constraint.equals(e.constraint))continue;const r=p.constraint.closestTo(a);this._squaredScreenDistance(r,a,o.coordinateHelper)<ai()&&(p.targetPoint=a,this._currentOtherActiveCandidates.push(p),s.push(...p.hints))}return{snappedPoint:a,hints:s}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(e,t,i){return this._squaredScreenDistance(e,t,i.coordinateHelper)<this._squaredPointProximityThreshold(i.pointer)}_squaredScreenDistance(e,t,i){return Nt(this._toScreen(e,i),this._toScreen(t,i))}_toScreen(e,t){return We(e,t.spatialReference,he,this.view)}get test(){}};var A;h([c({constructOnly:!0})],M.prototype,"view",void 0),h([c()],M.prototype,"options",void 0),h([c({readOnly:!0})],M.prototype,"updating",null),h([c()],M.prototype,"_loadTask",void 0),h([c()],M.prototype,"_engines",void 0),h([c()],M.prototype,"_squaredMouseProximityThreshold",null),h([c()],M.prototype,"_squaredTouchProximityThreshold",null),M=h([I("esri.views.interactive.snapping.SnappingManager")],M),function(e){e[e.MAIN=0]="MAIN",e[e.SCENE=1]="SCENE"}(A||(A={}));const ve="visualization-handle";function ai(){return X.satisfiesConstraintScreenThreshold*X.satisfiesConstraintScreenThreshold}function me(e,t){return!t||t.direction==null&&t.distance==null||!(e instanceof Ve||e instanceof je||e instanceof Ye||e instanceof qe||e instanceof Ke)&&(!(e instanceof Be)||t.direction==null&&e.selfSnappingType===K.LastVertex)}function si(e,t){return e instanceof q?fe(t,e.first)>=0&&fe(t,e.second)>=0?0:-1:fe(t,e)}function fe(e,t){let i=-1;for(let o=0;o<e.length;++o)if(t.constraint.equals(e[o].constraint)){i=o;break}return i}function ri(e){return e.scenePoint!=null}function ni({coordinateHelper:e,elevationInfo:t}){return e.hasZ()?he:t}let T=class extends re.EventedAccessor{constructor(e){super(e),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw-2d":case"draw-3d":return this.activeComponent.geometryType;default:pt(this.activeComponent)}return null}addToHistory(e){this.history.redo=[],this.history.undo.push(e)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this._reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}_reset(){this.activeComponent?.reset()}refreshComponent(){const e=this.activeComponent;e&&(e.type!=="box"&&e.type!=="reshape"&&e.type!=="graphic-mover"||e.refresh())}set undo(e){this._set("undo",()=>{this.canUndo()&&e()})}set redo(e){this._set("redo",()=>{this.canRedo()&&e()})}};h([c()],T.prototype,"activeComponent",void 0),h([c()],T.prototype,"cancelled",void 0),h([c()],T.prototype,"history",void 0),h([c()],T.prototype,"tool",null),h([c()],T.prototype,"type",void 0),h([c()],T.prototype,"canUndo",null),h([c()],T.prototype,"canRedo",null),h([c()],T.prototype,"onEnd",void 0),h([c()],T.prototype,"undo",null),h([c()],T.prototype,"redo",null),h([c()],T.prototype,"toggleTool",void 0),h([c()],T.prototype,"addToSelection",void 0),h([c()],T.prototype,"removeFromSelection",void 0),T=h([I("esri.widgets.Sketch.support.OperationHandle")],T);let te=class extends T{};h([c()],te.prototype,"activeComponent",void 0),te=h([I("esri.widgets.Sketch.support.OperationHandle.CreateOperationHandle")],te);let D=class extends T{};h([c()],D.prototype,"activeComponent",void 0),D=h([I("esri.widgets.Sketch.support.OperationHandle.UpdateOperationHandle")],D);function pi(e,t){return t==="freehandPolygon"||t==="freehandPolyline"?"freehand":e??(t==="rectangle"||t==="circle"?"hybrid":"click")}function li(e){switch(e){case"freehandPolygon":return"polygon";case"freehandPolyline":return"polyline";default:return e}}var Qe;(function(e){e[e.ForceCollapse=-1]="ForceCollapse",e[e.Low=0]="Low",e[e.Medium=10]="Medium",e[e.High=100]="High",e[e.Max=1e3]="Max"})(Qe||(Qe={}));const Xe={defaultZ:0},Z={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,highlightOptions:{enabled:!0},tool:"transform"};let v=class extends re.EventedAccessor{constructor(e){super(e),this._defaultSnappingManager=null,this._updatingHandles=new Me,this._internalGraphicsLayer=new Pe({listMode:"hide",internal:!0,title:"SVM Internal"}),this._operationHandle=null,this._viewHandlesKey="viewHandles",this.activeFillSymbol=null,this.activeLineSymbol=null,this.activeVertexSymbol=null,this.allowDeleteKey=!0,this.layer=null,this.pointSymbol=new Ee({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new lt({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new ht({color:[130,130,130,1],width:2}),this.meshSymbol=new ct({symbolLayers:new N([new dt])}),this.updateGraphics=new N,this.updateOnGraphicClick=!0,this.creationMode="single",this.vertexSymbol=new Ee({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.sketchOptions=new xe,this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._sketchContinuationFlag=!1,this._originalPopupEnabled=null,this.defaultCreateOptions=Xe,this.defaultUpdateOptions=Z,this.snappingOptions=e?.snappingManager?.options??e?.snappingOptions??new ue}initialize(){this.addHandles([we(()=>this.view?.map?.layers,"change",e=>{e.removed.includes(this.layer)&&this.cancel()}),we(()=>this.layer?.graphics,"change",e=>{if(this._operationHandle!=null)for(const t of e.removed)this.updateGraphics.includes(t)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(t):this._operationHandle.cancel())}),H(()=>this.layer?.elevationInfo??null,e=>{e!==this._internalGraphicsLayer.elevationInfo&&(this.cancel(),this._internalGraphicsLayer.elevationInfo=e)},Q),H(()=>this.view,e=>{this._defaultSnappingManager=F(this._defaultSnappingManager),e&&(this.snappingManager||(this._defaultSnappingManager=new M({view:e,options:this.snappingOptions})),e.type==="2d"?import("./editingTools-DGVAWT99.js"):e.type==="3d"&&(import("./ImageMaterial.glsl-CkjjitKN.js").then(t=>t.e),import("./LineCallout.glsl-ugKtffm2.js").then(t=>t.G)))},Q),H(()=>this.view?.spatialReference,(e,t)=>{e&&t&&!e.equals(t)&&this.cancel()})]),Ft(this)}destroy(){this.cancel(),this._removeDefaultLayer(),this._defaultSnappingManager=F(this._defaultSnappingManager),this._set("snappingManager",null),this._set("view",null),this._updatingHandles.destroy(),this.emit("destroy")}get updating(){return this._updatingHandles.updating||this.snappingManager!=null&&this.snappingManager.updating}get activeTool(){return this._operationHandle?.tool??null}get activeCreateToolDrawMode(){return this._operationHandle?.type==="create"&&this._operationHandle.activeComponent&&"mode"in this._operationHandle.activeComponent?this._operationHandle.activeComponent.mode:null}get activeTooltip(){const{activeComponent:e,destroyed:t}=this,i=!t&&e&&"tooltip"in e?e.tooltip:null;return i?.visible?i:null}get activeComponent(){return this._operationHandle?.activeComponent??null}get createGraphic(){return this.activeComponent==null||this.activeComponent.type!=="draw-3d"&&this.activeComponent.type!=="draw-2d"?this._get("createGraphic"):this.activeComponent.graphic}get defaultCreateOptions(){return this._get("defaultCreateOptions")}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...Xe,...e})}get defaultUpdateOptions(){return this._get("defaultUpdateOptions")}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...Z,...e,reshapeOptions:{...Z.reshapeOptions,...e?.reshapeOptions},highlightOptions:{...Z.highlightOptions,...e?.highlightOptions}})}get labelOptions(){return this.sketchOptions.labels}set labelOptions(e){this.sketchOptions.labels=e}get snappingOptions(){return this.snappingManager?.options??this._get("snappingOptions")}set snappingOptions(e){this._defaultSnappingManager!=null&&(this._defaultSnappingManager.options=e),this._set("snappingOptions",e)}get snappingManager(){return this._isOverridden("snappingManager")&&this._get("snappingManager"),this._defaultSnappingManager}set snappingManager(e){if(e)this._isOverridden("snappingManager")||(this._defaultSnappingManager=F(this._defaultSnappingManager)),this._override("snappingManager",e);else{const{view:t}=this;!this._defaultSnappingManager&&t&&(this._defaultSnappingManager=new M({options:this.snappingOptions,view:t})),this._clearOverride("snappingManager")}}get state(){const e=!(!this.view?.ready||!this.layer),t=this._operationHandle;return e&&t?"active":e?"ready":"disabled"}get tooltipOptions(){return this.sketchOptions.tooltips}set tooltipOptions(e){this.sketchOptions.tooltips=e}get valueOptions(){return this.sketchOptions.values}set valueOptions(e){this.sketchOptions.values=e}get view(){return this._get("view")}set view(e){const t=this._get("view");if(t){const{container:o,map:a}=t;o&&(t.cursor=null),a?.remove(this._internalGraphicsLayer),this.removeHandles(this._viewHandlesKey),this.cancel()}const i="view-ready";this.removeHandles(i),e&&this.addHandles(ut(()=>e.ready,o=>{this.removeHandles(this._viewHandlesKey),o&&this.addHandles(this._generateViewHandles(e),this._viewHandlesKey)},Q),i),this._set("view",e)}cancel(){this._moduleLoaderAbortController=pe(this._moduleLoaderAbortController),this._viewReadyAbortController=pe(this._viewReadyAbortController),this._sketchContinuationFlag=!0,this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:t}=this;if(e==="active"&&t.length){const{activeTool:i,layer:o}=this,a=t.toArray();o.removeMany(a),this.cancel(),this._emitDeleteEvent({graphics:a,tool:i})}}duplicate(){if(this.state==="active"&&this.updateGraphics.length){const e=this.updateGraphics.map(t=>t.clone()).toArray();return this.layer.addMany(e),this.emit("duplicate",{graphics:e,type:"duplicate"}),e}return[]}async create(e,t){this.cancel(),await this._waitViewReady();const{view:i,layer:o}=this;if(!i||this.state==="disabled")throw o||this._logMissingLayer(),Se();if(i.activeTool!=null&&(i.activeTool=null),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");de(i,this._internalGraphicsLayer);const a=await this._updatingHandles.addPromise(this._setupCreateOperation(e,t));if(a==null||this.destroyed)return void i.map.remove(this._internalGraphicsLayer);const s=()=>{if(a===this._operationHandle){const p=this.createGraphic,r=this._operationHandle.cancelled;if(this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view?.map&&this.view.map.remove(this._internalGraphicsLayer),a.cancelled||p==null||o.add(p),this._sketchContinuationFlag=!1,this.emit("create",{graphic:p,state:r?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"}),r||this._sketchContinuationFlag)return;const{creationMode:l}=this;if(l==="continuous"){if(t?.geometryToPlace)return;this._updatingHandles.addPromise(Ge(this.create(e,t)))}else l==="update"&&p&&this._updatingHandles.addPromise(Ge(this.update([p])))}};a.on("complete",s),this._operationHandle=a,i.ready&&i.focus()}async place(e,t){return this.create("mesh",{mode:"click",hasZ:e.hasZ,geometryToPlace:e,...t})}async update(e,t){this.cancel(),await this._waitViewReady();const{layer:i,view:o,state:a}=this;if(!o||a==="disabled")throw i||this._logMissingLayer(),Se();o.activeTool!=null&&(o.activeTool=null);const s=Array.isArray(e)?e:[e];if(e==null||!s?.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(s.some(r=>r.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):r.geometry==null&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0)))return;const p=await this._updatingHandles.addPromise(this._setupUpdateOperation(s,t));this.destroyed||p==null||E(p)||(de(o,this._internalGraphicsLayer),this._setUpdateOperationHandle(p,t),this.emit("update",{graphics:s,state:"start",aborted:!1,tool:p.tool,toolEventInfo:null,type:"update"}))}async _updateSpatialReference(e){const t=this.view;if(t){e=Array.isArray(e)?e:[e];for(const i of e)i.geometry==null||i.geometry.type==="mesh"||yt(i.geometry.spatialReference,t.spatialReference)||(Gt(i.geometry.spatialReference,t.spatialReference)||Mt()||await Pt(),i.geometry=le(i.geometry,t.spatialReference))}else this._logMissingView()}undo(){this.canUndo()&&this._operationHandle?.undo()}redo(){this.canRedo()&&this._operationHandle?.redo()}canUndo(){return!!this._operationHandle?.canUndo()}canRedo(){return!!this._operationHandle?.canRedo()}toggleUpdateTool(){this._operationHandle?.toggleTool()}async _getFirstHit(e){const t=this.view;if(!t)return this._logMissingView(),null;if(t.type==="2d"){const a=[];t.map.allLayers.forEach(p=>{p.type!=="vector-tile"&&p.type!=="imagery"||a.push(p)});const s=await t.hitTest(e,{exclude:a});return Vt(s.results)}const i=[t.map.ground];t.map.allLayers.forEach(a=>{gt(a.type)&&i.push(a)});const o=await t.hitTest(e,{exclude:i});if(o.results.length>0){const a=o.results[0];if(a!=null&&a.type==="graphic"&&a.graphic&&(!o.ground.mapPoint||t.map.ground.opacity<1||o.ground.distance-(a.distance??0)>-Math.min(3*o.ground.distance,t.viewingMode==="global"?vt(t.renderCoordsHelper.spatialReference).radius/t.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY)))return a}return null}_generateViewHandles(e){return[e.on("immediate-click",async t=>{const i=this.state==="active"&&this._operationHandle?.type==="create";this.state!=="disabled"&&!i&&this.updateOnGraphicClick&&await this._updatingHandles.addPromise(this._handleImmediateClick(t))},w.WIDGET)]}async _handleImmediateClick(e){const t=await e.async(()=>this._getFirstHit(Re(e)));let i=null;if(t!=null){const o=t.graphic;this.updateGraphics.includes(o)||o.layer===this.layer?(e.stopPropagation(),i=o):this.view?.type!=="2d"||this._isComponentGraphic(o)||this.state!=="active"||this.cancel()}else this.state==="active"&&this.cancel();i==null||this.updateGraphics.includes(i)||await this.update([i],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}})}async _setupCreateOperation(e,t){const i=this.view;if(!i)return this._logMissingView(),null;const o={hasZ:i.type==="3d",...this.defaultCreateOptions,...t},a=await this._setupDrawGraphicTool(e,i,o);return a==null?null:(i.tools.add(a),i.activeTool=a,this._setupCreateOperationHandle(a))}async _setupDrawGraphicTool(e,t,i){if(e==="multipoint"&&t.type==="3d")return this._logError("sketch:create","Multipoint geometries are not supported in SceneView."),null;if(!t)return this._logMissingView(),null;const{cursor:o,defaultZ:a,hasZ:s,geometryToPlace:p,graphicProperties:r,mode:l,preserveAspectRatio:n}=i,u=pi(l,e),g=li(e),m=i?.optionsPerTool?.has(e)?i.optionsPerTool.get(e):{},y=m?.preserveAspectRatio??n??e!=="rectangle",d={centered:e!=="rectangle"&&!(e==="circle"&&!y),cursor:o,defaultZ:a,forceUniformSize:y,graphicProperties:{...r,attributes:{...r?.attributes}},geometryToPlace:p,geometryType:g,mode:u,graphicSymbol:this._getGraphicSymbolFromTool(e),hasZ:s,snappingManager:this.snappingManager,snapToScene:!1,view:t,...m};return t.type==="2d"?this._makeDrawGraphicTool2D(d):this._makeDrawGraphicTool3D(d)}async _makeDrawGraphicTool2D(e){const t=await this._requireModule(import("./editingTools-DGVAWT99.js"));return E(t)||this.destroyed?null:new t.module.DrawGraphicTool2D({...e,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:ci(e.geometryType)?this.activeFillSymbol:null,sketchOptions:this.sketchOptions})}async _makeDrawGraphicTool3D(e){const t=await this._requireModule(import("./ImageMaterial.glsl-CkjjitKN.js").then(o=>o.e));if(E(t)||this.destroyed)return null;const{elevationInfo:i}=this.layer;return new t.module.DrawGraphicTool3D({...e,elevationInfo:i,snapToScene:!0,sketchOptions:this.sketchOptions})}_setupCreateOperationHandle(e){const t=this.view;if(!t)return this._logMissingView(),null;let i=null;const o=e.forceUniformSize,a=e.centered,s=[t.on("key-down",r=>{if(r.key===b.pan)r.stopPropagation(),r.repeat||(e.enabled=!1);else if(r.key===b.complete)r.stopPropagation(),e.completeCreateOperation();else if(r.key!==b.vertexAdd||r.repeat)r.key===b.undo?(r.stopPropagation(),p.undo()):r.key===b.redo?(r.stopPropagation(),p.redo()):r.key!==b.constraint||e.geometryType!=="rectangle"&&e.geometryType!=="circle"||r.repeat?r.key===b.center&&(r.repeat||(e.centered=!a,r.stopPropagation())):(e.forceUniformSize=!o,r.stopPropagation());else{const l=e.drawOperation.geometryType;l!=="polyline"&&l!=="polygon"&&l!=="multipoint"||(r.stopPropagation(),e.drawOperation.commitStagedVertex())}},w.WIDGET),t.on("key-up",r=>{r.key===b.pan?e.enabled=!0:r.key!==b.constraint||e.geometryType!=="rectangle"&&e.geometryType!=="circle"?r.key===b.center&&(e.centered=a,r.stopPropagation()):(e.forceUniformSize=o,r.stopPropagation())},w.WIDGET),e.on("vertex-add",r=>{switch(i=i==null?"start":"active",r.operation){case"apply":this.emit("create",{graphic:e.graphic,state:i,tool:this.activeTool,toolEventInfo:r,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[e.graphic],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[e.graphic],tool:e.geometryType})}}),e.on("cursor-update",r=>{e.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:e.graphic,state:"active",tool:this.activeTool,toolEventInfo:{coordinates:r.vertices[0].coordinates,type:"cursor-update"},type:"create"})}),e.on("vertex-remove",r=>{switch(r.operation){case"apply":this.emit("create",{graphic:e.graphic,state:"active",tool:this.activeTool,toolEventInfo:r,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[e.graphic],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[e.graphic],tool:e.geometryType})}}),e.on("complete",r=>{this._set("createGraphic",r.graphic),i="complete",r.aborted?p&&p.cancel():p&&p.complete()}),H(()=>this._getGraphicSymbolFromTool(e.geometryType),r=>{e.graphicSymbol=r})],p=new te({activeComponent:e,tool:e.geometryType,type:"create",onEnd:()=>{P(s),t.tools?.remove(e)},undo:()=>{e.canUndo&&e.undo()},redo:()=>{e.canRedo&&e.redo()},canUndo:()=>e.canUndo,canRedo:()=>e.canRedo});return p}_getGraphicSymbolFromTool(e){switch(e){case"point":case"multipoint":return this.pointSymbol;case"polyline":case"freehandPolyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":case"freehandPolygon":return this.polygonSymbol;case"mesh":return this.meshSymbol}}async _setupUpdateOperation(e,t){const{layer:i,view:o}=this;if(!o)return this._logMissingView(),null;const a={...this.defaultUpdateOptions,...t,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...t?.reshapeOptions},highlightOptions:{...this.defaultUpdateOptions.highlightOptions,...t?.highlightOptions}};let s=a.tool??Z.tool;for(const p of e)i.remove(p),i.add(p);if(o.type==="3d"){if(e.length===0)return null;switch(s){case"move":return this._setupMove3DOperation(e,a,o,s);case"reshape":return e.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupReshape3DOperation(e[0],a,o);case"transform":return this._setupGraphicTransform3DOperation(e,a,o)}}switch(s){case"move":return this._setupMove2DOperation(e,a,o);case"reshape":return e.length>1?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null):this._setupTransformOrReshape2DOperation(e,s,a,o);case"transform":if(e.length===1){const p=e[0].geometry?.type;p!=="point"&&p!=="multipoint"||(s="reshape")}return this._setupTransformOrReshape2DOperation(e,s,a,o)}}async _setupMove3DOperation(e,t,i,o,a=!1){const s=await this._requireModule(import("./ImageMaterial.glsl-CkjjitKN.js").then(y=>y.e));if(E(s))return s;const{ManipulatedObject3DGraphic:p,MoveTool3D:r}=s.module,l=new Map,n=()=>{l.forEach(y=>y.destroy()),l.clear()};for(const y of e){const d=new p({view:i,graphic:y}),O=Le(d);if(O!==f.SUPPORTED)return n(),this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${Ue(O)}).`),null;l.set(y,d)}const u=new r({view:i,enableZ:t.enableZ,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions});i.tools.add(u),u.objects.addMany(Array.from(l.values())),a||this.updateGraphics.addMany(e);const g=[],m=new D({activeComponent:u,tool:o,type:"update",onEnd:()=>{P(g),ae(i,u),n()},undo:()=>{et(this.view,u),ie(m,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{oe(m,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:y=>{this.updateGraphics.push(y);const d=new p({view:i,graphic:y});l.set(y,d),u.objects.push(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[y],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:y=>{const d=this.updateGraphics.indexOf(y);if(m.history.undo.forEach(G=>G.updates.splice(d,1)),m.history.redo.forEach(G=>G.updates.splice(d,1)),this.updateGraphics.remove(y),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[y],type:"selection-change"},type:"update"}),this.updateGraphics.length===0)return void m.complete();const O=l.get(y);O&&(u.objects.remove(O),O.destroy(),l.delete(y))},toggleTool:async()=>{if(this.updateGraphics.length!==1||t.toggleToolOnClick===!1||o!=="transform")return;const y=this.updateGraphics.at(0),d=await this._setupReshape3DOperation(y,t,i,!0);d&&!E(d)&&(m.onEnd(),m.destroy(),this._setUpdateOperationHandle(d,t))}});return g.push(...this._getHandlesForComponent(m,t),i.on("immediate-click",y=>this._getCommonUpdateOperationClickHandlers(m,y,t),w.WIDGET),i.on("key-down",y=>{this._getCommonUpdateOperationKeyDownHandlers(m,y)},w.WIDGET)),m}_setupGraphicTransform3DOperation(e,t,i,o=!1){if(e.length===1&&Jt(e[0])===f.SUPPORTED){const a=e[0],s=a.geometry;if(s!=null&&(s.type==="point"||s.type==="mesh"))return this._setupPointTransform3DOperation(a,t,i);if(s!=null&&(s.type==="polygon"||s.type==="polyline"))return this._setupPolyTransform3DOperation(a,t,i,o)}return this._setupMove3DOperation(e,t,i,"transform",o)}async _setupPointTransform3DOperation(e,t,i){const o="transform",{enableRotation:a,enableScaling:s,enableZ:p}=t,r=await this._requireModule(import("./ImageMaterial.glsl-CkjjitKN.js").then(d=>d.e));if(E(r))return r;const{TransformTool3D:l,ManipulatedObject3DGraphic:n}=r.module,u=new n({graphic:e,view:i}),g=new l({object:u,view:i,enableRotation:a,enableScaling:s,enableZ:p,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions});i.tools.add(g),this.updateGraphics.add(e);const m=[],y=new D({activeComponent:g,tool:o,type:"update",onEnd:()=>{P(m),ae(i,g),u.destroy()},undo:()=>{et(this.view,g),ie(y,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o})},redo:()=>{oe(y,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o})},addToSelection:async d=>{this.updateGraphics.add(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[d],removed:[],type:"selection-change"},type:"update"}),y.onEnd(),y.destroy();const O=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);E(O)||this._setUpdateOperationHandle(O,t)},removeFromSelection:d=>{this.updateGraphics.remove(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[d],type:"selection-change"},type:"update"}),y.complete()},toggleTool:()=>{}});return m.push(...this._getHandlesForComponent(y,t),i.on("immediate-click",d=>this._getCommonUpdateOperationClickHandlers(y,d,t),w.WIDGET),i.on("key-down",d=>{this._getCommonUpdateOperationKeyDownHandlers(y,d)},w.WIDGET)),y}async _setupPolyTransform3DOperation(e,t,i,o=!1){const a="transform",{enableRotation:s,enableScaling:p,enableZ:r,preserveAspectRatio:l}=t,n=await this._requireModule(import("./ImageMaterial.glsl-CkjjitKN.js").then(_=>_.e));if(E(n))return n;const{ManipulatedObject3DGraphic:u,ExtentTransformTool:g}=n.module,m=this.view?.inputManager?.isModifierKeyDown(b.constraint),y=new u({view:i,graphic:e}),d=new g({object:y,view:i,enableRotation:s,enableScaling:p,enableZ:r,preserveAspectRatio:!!l!=!!m,sketchOptions:this.sketchOptions});i.tools.add(d),o||this.updateGraphics.add(e);const O=[],G=new D({activeComponent:d,tool:a,type:"update",onEnd:()=>{P(O),ae(i,d),y.destroy()},canUndo:()=>!d.destroyed&&d.canUndo,undo:()=>{d.destroyed||(d.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},canRedo:()=>!d.destroyed&&d.canRedo,redo:()=>{d.destroyed||(d.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},addToSelection:async _=>{this.updateGraphics.add(_),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[_],removed:[],type:"selection-change"},type:"update"}),G.onEnd(),G.destroy();const _e=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);E(_e)||this._setUpdateOperationHandle(_e,t)},removeFromSelection:_=>{this.updateGraphics.remove(_),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[_],type:"selection-change"},type:"update"}),G.complete()},toggleTool:async()=>{if(this.updateGraphics.length!==1||t.toggleToolOnClick===!1)return;const _=await this._setupReshape3DOperation(e,t,i,!0);_&&!E(_)&&(G.onEnd(),G.destroy(),this._setUpdateOperationHandle(_,t))}});return O.push(...this._getHandlesForComponent(G,t),i.on("immediate-click",_=>this._getCommonUpdateOperationClickHandlers(G,_,t),w.WIDGET),i.on("key-down",_=>this._getCommonUpdateOperationKeyDownHandlers(G,_),w.WIDGET),i.on("key-down",_=>{_.key!==b.constraint||_.repeat||(d.preserveAspectRatio=!d.preserveAspectRatio,_.stopPropagation())},w.WIDGET),i.on("key-up",_=>{_.key===b.constraint&&(d.preserveAspectRatio=!d.preserveAspectRatio,_.stopPropagation())},w.WIDGET)),G}async _setupMove2DOperation(e,t,i){const o="move";this.updateGraphics.addMany(e),await this._updatingHandles.addPromise(this._updateSpatialReference(e));const a=await this._getGraphicMover(e,t,i);if(E(a))return a;const s=new D({activeComponent:a,tool:o,type:"update",onEnd:()=>{this._displayDefaultCursor(),P(l),P(r),a.destroy(),this._internalGraphicsLayer?.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const n=this.updateGraphics.toArray();ie(s,n),s.refreshComponent(),this._emitUndoEvent({graphics:n,tool:o})},redo:()=>{const n=this.updateGraphics.toArray();oe(s,n),s.refreshComponent(),this._emitRedoEvent({graphics:n,tool:o})},addToSelection:async n=>{await this._updatingHandles.addPromise(this._updateSpatialReference(n)),this.updateGraphics.push(n),a.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[n],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:n=>{const u=this.updateGraphics.indexOf(n);s.history.undo.forEach(m=>m.updates.splice(u,1)),s.history.redo.forEach(m=>m.updates.splice(u,1)),this.updateGraphics.remove(n);const g=this.updateGraphics.toArray();this.emit("update",{graphics:g,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[n],type:"selection-change"},type:"update"}),this.updateGraphics.length!==0?a.graphics=g:s.complete()}});let p=!1;const r=[i.on("immediate-click",n=>this._getCommonUpdateOperationClickHandlers(s,n,t),w.WIDGET),i.on("key-down",n=>{this._getCommonUpdateOperationKeyDownHandlers(s,n),n.key!==b.constraint||n.repeat||(p=!0,a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},w.WIDGET),i.on("key-up",n=>{n.key===b.constraint&&p&&(p=!1,a.enableMoveAllGraphics=!a.enableMoveAllGraphics)},w.WIDGET)],l=this._getHandlesForComponent(s,t);return s}async _setupReshape3DOperation(e,t,i,o=!1){const a="reshape",s=await this._requireModule(import("./ImageMaterial.glsl-CkjjitKN.js").then(d=>d.e));if(E(s))return s;const{ManipulatedObject3DGraphic:p,ReshapeTool3D:r}=s.module,l=new p({view:i,graphic:e}),n=Xt(l);if(n!==f.SUPPORTED)return l.destroy(),this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${Ue(n)}).`),null;const u=t.reshapeOptions,g=new r({view:i,object:l,enableZVertex:t.enableZ&&u?.vertexOperation==="move",enableZShape:t.enableZ&&u?.shapeOperation==="move",enableMoveObject:u?.shapeOperation==="move"||u?.shapeOperation==="move-xy",enableMidpoints:u?.edgeOperation==="split",enableEdgeOffset:u?.edgeOperation==="offset",snappingManager:this.snappingManager,sketchOptions:this.sketchOptions});i.tools.add(g),o||this.updateGraphics.add(l.graphic);const m=[],y=new D({activeComponent:g,tool:a,type:"update",onEnd:()=>{P(m),ae(i,g),l.destroy()},canUndo:()=>!g.destroyed&&g.canUndo,undo:()=>{g.destroyed||(g.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},canRedo:()=>!g.destroyed&&g.canRedo,redo:()=>{g.destroyed||(g.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:a}))},addToSelection:async d=>{this.updateGraphics.add(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[d],removed:[],type:"selection-change"},type:"update"}),y.onEnd(),y.destroy();const O=await this._setupMove3DOperation(this.updateGraphics.toArray(),t,i,"transform",!0);E(O)||this._setUpdateOperationHandle(O,t)},removeFromSelection:d=>{this.updateGraphics.remove(d),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[d],type:"selection-change"},type:"update"}),y.complete()},toggleTool:async()=>{if(t.toggleToolOnClick===!1)return;y.onEnd(),y.destroy();const d=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),t,i,!0);E(d)||this._setUpdateOperationHandle(d,t)}});return m.push(...this._getHandlesForComponent(y,t),i.on("immediate-click",d=>this._getCommonUpdateOperationClickHandlers(y,d,t),w.WIDGET),i.on("key-down",d=>{this._getCommonUpdateOperationKeyDownHandlers(y,d)},w.WIDGET)),y}async _setupTransformOrReshape2DOperation(e,t,i,o){this.updateGraphics.addMany(e),await this._updatingHandles.addPromise(this._updateSpatialReference(e));const a=t==="transform"?await this._getBox(e,i,o):await this._getReshape(e,i,o);if(E(a))return a;const s=new D({activeComponent:a,type:"update",onEnd:()=>{P(r),P(p),s.activeComponent&&!s.activeComponent.destroyed&&s.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{ie(s,this.updateGraphics.toArray()),s.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s.tool})},redo:()=>{oe(s,this.updateGraphics.toArray()),s.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s.tool})},addToSelection:async l=>{let n=s.activeComponent;if(n?.type==="reshape"){const u=[...this.updateGraphics,l];this.updateGraphics.removeAll(),s.onEnd(),s.destroy();const g=await this._setupTransformOrReshape2DOperation(u,"transform",i,o);if(E(g))return;this._setUpdateOperationHandle(g,i)}else this.updateGraphics.add(l),n.graphics=this.updateGraphics.toArray(),n.refresh(),s.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[l],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async l=>{const n=this.updateGraphics.indexOf(l);s.history.undo.forEach(g=>g.updates.splice(n,1)),s.history.redo.forEach(g=>g.updates.splice(n,1)),this.updateGraphics.remove(l);const u=this.updateGraphics.toArray();if(u.length===0)s.complete();else{const g=u[0].geometry;u.length!==1||g==null||g.type!=="point"&&g.type!=="multipoint"?s.activeComponent.graphics=u:s.toggleTool()}this.emit("update",{graphics:u,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[l],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const l=this.updateGraphics.at(0),n=l.geometry;if(n!=null&&(s.tool==="reshape"&&(n.type==="point"||n.type==="multipoint")||s.tool==="transform"&&n.type==="extent"))return;let u=null;s.tool==="transform"?u=await this._getReshape([l],i,o):s.tool==="reshape"&&(u=await this._getBox([l],i,o)),E(u)||(s.activeComponent?.destroy(),s.activeComponent=u,s.activeComponent&&(P(r),r=this._getHandlesForComponent(s,i)))}}),p=[o.on("immediate-click",l=>this._getCommonUpdateOperationClickHandlers(s,l,i),w.WIDGET),o.on("key-down",l=>{if(this._getCommonUpdateOperationKeyDownHandlers(s,l),l.key===b.constraint&&!l.repeat&&s){const n=s.activeComponent;n&&n.type==="box"&&(n.preserveAspectRatio=!n.preserveAspectRatio)}},w.WIDGET),o.on("key-up",l=>{if(l.key===b.constraint&&s){const n=s.activeComponent;n&&n.type==="box"&&(n.preserveAspectRatio=!n.preserveAspectRatio)}},w.WIDGET)];let r=this._getHandlesForComponent(s,i);return s}async _getGraphicMover(e,t,i){const{enableMoveAllGraphics:o,highlightOptions:a}=t,s=await this._requireModule(import("./GraphicMover-CPrxAuZi.js").then(p=>p.G));return E(s)?s:new s.module.default({enableMoveAllGraphics:o,highlightsEnabled:!!a?.enabled,indicatorsEnabled:!1,graphics:e,view:i,callbacks:{onGraphicMoveStart:({dx:p,dy:r,graphic:l})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:p,dy:r,mover:l,type:"move-start"},type:"update"})},onGraphicMove:({dx:p,dy:r,graphic:l})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:p,dy:r,mover:l,type:"move"},type:"update"}),onGraphicMoveStop:({dx:p,dy:r,graphic:l})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:p,dy:r,mover:l,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,t,i){const{enableRotation:o,enableScaling:a,highlightOptions:s,preserveAspectRatio:p}=t,r=await this._requireModule(import("./Box-D9m4qZFM.js"));if(E(r))return r;const l=this.view?.inputManager?.isModifierKeyDown(b.constraint);return new r.module.default({graphics:e,enableRotation:o,enableScaling:a,highlightsEnabled:!!s?.enabled,preserveAspectRatio:!!p!=!!l,layer:this._internalGraphicsLayer,view:i,sketchOptions:this.sketchOptions,callbacks:{onMoveStart:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"}),onMove:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"}),onMoveStop:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"}),onScaleStart:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"}),onScale:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"}),onScaleStop:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"}),onRotateStart:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"}),onRotate:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"}),onRotateStop:n=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...n},type:"update"})}})}async _getReshape(e,t,i){const o=t.reshapeOptions?.edgeOperation==="split",a=t.reshapeOptions?.shapeOperation==="move",s=!!t.highlightOptions?.enabled,p=await this._requireModule(import("./Reshape-D3Rl0Jic.js"));return E(p)?p:new p.module.default({enableMidpoints:o,enableMovement:a,graphic:e[0],highlightsEnabled:s,layer:this._internalGraphicsLayer,snappingManager:this.snappingManager,sketchOptions:this.sketchOptions,view:i,callbacks:{onReshapeStart:r=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...r},type:"update"}),onReshape:r=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...r},type:"update"}),onReshapeStop:({mover:r,type:l})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:r,type:l},type:"update"}),onMoveStart:({dx:r,dy:l,mover:n,type:u})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:r,dy:l,mover:n,type:u},type:"update"}),onMove:({dx:r,dy:l,mover:n,type:u})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:r,dy:l,mover:n,type:u},type:"update"}),onMoveStop:({dx:r,dy:l,mover:n,type:u})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:r,dy:l,mover:n,type:u},type:"update"}),onVertexAdd:({added:r,type:l,vertices:n})=>{const u=r.map(g=>Te(g.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:u,vertices:n,type:l},type:"update"})},onVertexRemove:({removed:r,type:l,vertices:n})=>{const u=r.map(g=>Te(g.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:u,vertices:n,type:l},type:"update"})}}})}_getHandlesForComponent(e,t){const i=e.activeComponent;if(!i)return[];switch(i.type){case"graphic-mover":return[i.on("graphic-click",({graphic:o,viewEvent:a})=>{a.native?.shiftKey&&(a.stopPropagation(),e.removeFromSelection(o))}),i.on("graphic-move-start",o=>e.addToHistory(U(o.allGraphics)))];case"box":return[i.on("graphic-click",o=>this._onTransformOrReshape2DGraphicClick(e,t,o)),i.on("move-start",o=>e.addToHistory(U(o.graphics))),i.on("rotate-start",o=>e.addToHistory(U(o.graphics))),i.on("scale-start",o=>e.addToHistory(U(o.graphics)))];case"reshape":return[i.on("graphic-click",o=>this._onTransformOrReshape2DGraphicClick(e,t,o)),i.on("move-start",o=>e.addToHistory(U([o.mover]))),i.on("reshape-start",o=>e.addToHistory(U([o.graphic]))),i.on("vertex-add",o=>e.addToHistory(U([o.oldGraphic]))),i.on("vertex-remove",o=>e.addToHistory(U([o.oldGraphic])))];case"move-3d":return[i.events.on("record-undo",({updates:o})=>{e.addToHistory({updates:o})}),i.events.on("move-start",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:o.objects.length>0?o.objects[0].graphic:null,type:"move-start"},type:"update"})}),i.events.on("move",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:o.dx,dy:o.dy,mover:o.objects.length>0?o.objects[0].graphic:null,type:"move"},type:"update"})}),i.events.on("move-stop",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:o.objects.length>0?o.objects[0].graphic:null,type:"move-stop"},type:"update"})}),i.events.on("immediate-click",o=>{o.shiftKey?this._toggleSelection([o.object.graphic],e,t):e.toggleTool()})];case"transform-3d":return[i.events.on("record-undo",({updates:o})=>{e.addToHistory({updates:o})}),i.events.on("translate-start",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,dx:o.dxScreen,dy:o.dyScreen,type:"move-start"},type:"update"})}),i.events.on("translate-stop",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,dx:o.dxScreen,dy:o.dyScreen,type:"move-stop"},type:"update"})}),i.events.on("rotate-start",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,angle:o.angle,type:"rotate-start"},type:"update"})}),i.events.on("rotate-stop",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,angle:o.angle,type:"rotate-stop"},type:"update"})}),i.events.on("scale-start",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,xScale:o.xScale,yScale:o.yScale,type:"scale-start"},type:"update"})}),i.events.on("scale-stop",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,xScale:o.xScale,yScale:o.yScale,type:"scale-stop"},type:"update"})}),i.events.on("translate",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,dx:o.dxScreen,dy:o.dyScreen,type:"move"},type:"update"})}),i.events.on("rotate",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,angle:o.angle,type:"rotate"},type:"update"})}),i.events.on("scale",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:o.object.graphic,xScale:o.xScale,yScale:o.yScale,type:"scale"},type:"update"})}),i.events.on("immediate-click",o=>{o.shiftKey?this._toggleSelection([o.object.graphic],e,t):e.toggleTool()})];case"reshape-3d":return[i.events.on("reshape",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...o,mover:o.object.graphic},type:"update"})}),i.events.on("move",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...o,mover:o.object.graphic},type:"update"})}),i.events.on("vertex-add",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:o,type:"update"})}),i.events.on("vertex-remove",o=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:o,type:"update"})}),i.events.on("immediate-click",o=>{o.shiftKey?this._toggleSelection([o.object.graphic],e,t):e.toggleTool()})]}}_onTransformOrReshape2DGraphicClick(e,t,i){const{graphic:o,viewEvent:a}=i;return a.native?.shiftKey&&o.layer===this.layer?(a.stopPropagation(),e.removeFromSelection(o)):t.toggleToolOnClick?(a.stopPropagation(),e.toggleTool()):void 0}_setUpdateOperationHandle(e,t){this._operationHandle=e;const i=this.view?.map;this._disablePopup(t);const o=()=>{if(e===this._operationHandle){const a=this.updateGraphics.toArray(),s=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(t),this.emit("update",{graphics:a,state:"complete",aborted:e.cancelled,tool:s,toolEventInfo:null,type:"update"})}};e.on("complete",o)}async _getCommonUpdateOperationClickHandlers(e,t,i){const o=Re(t),a=await t.async(()=>this._getFirstHit(o));if(a==null)return void e.complete();if(t.native.shiftKey&&this._toggleSelection([a.graphic],e,i))return void t.stopPropagation();this.updateGraphics.includes(a.graphic)?t.stopPropagation():e.complete()}_toggleSelection(e,t,i){const o=!!i.multipleSelectionEnabled;return e.some(a=>a!=null&&!(!o||a.layer!==this.layer)&&(this.updateGraphics.includes(a)?t.removeFromSelection(a):t.addToSelection(a),!0))}_getCommonUpdateOperationKeyDownHandlers(e,t){if(!e)return;const i=t.key;i===b.undo&&e.canUndo()?(t.stopPropagation(),e.undo()):i===b.redo&&e.canRedo()?(t.stopPropagation(),e.redo()):i===b.cancel?(t.stopPropagation(),e.cancel()):this.allowDeleteKey&&b.delete.includes(i)&&this._onDeleteKey(t)}_onDeleteKey(e){if(!this._operationHandle||this._operationHandle.type!=="update")return;const t=this.activeComponent,i=this.updateGraphics.toArray();t!=null&&(t.type!=="reshape"||i.length===1&&i[0].geometry?.type==="point")&&(e.stopPropagation(),this.delete())}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view?.map?.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=F(this._internalGraphicsLayer))}_isComponentGraphic(e){const{activeComponent:t}=this;return!(!e||t==null)&&(e.attributes?.esriSketchTool||t.type==="draw-2d"&&t.graphic===e||(t.type==="box"||t.type==="reshape")&&t.isUIGraphic(e))}_displayPointerCursor(){this.view?.container&&this.view.cursor!=="pointer"&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view?.container&&this.view.cursor!=="grabbing"&&(this.view.cursor="grabbing")}_displayDefaultCursor(){this.view?.container&&this.view.cursor!==null&&(this.view.cursor=null)}_logError(e,t,i){be.getLogger(this).error(new mt(e,t,i))}async _requireModule(e){const t=new AbortController;this._moduleLoaderAbortController=t;const i=await e;return this._moduleLoaderAbortController!==t||t.signal.aborted?{requireError:"aborted"}:{module:i}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}get test(){}wait(){return Oe(()=>!this.updating)}_disablePopupEnabled(e){return this.view?.type!=="3d"||this.updateOnGraphicClick||(e?.toggleToolOnClick??!1)}_disablePopup(e){this._disablePopupEnabled(e)&&this.view&&this._originalPopupEnabled==null&&(this._originalPopupEnabled=this.view.popupEnabled,this.view.popupEnabled=!1)}_restorePopup(e){this._disablePopupEnabled(e)&&this.view&&this._originalPopupEnabled!=null&&(this.view.popupEnabled=this._originalPopupEnabled,this._originalPopupEnabled=null)}async _waitViewReady(){const e=this.view;e?(pe(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,await ft(Oe(()=>e?.ready),this._viewReadyAbortController.signal)):this._logMissingView()}_logMissingView(){this._logError("sketch:missing-property",$e("view"))}_logMissingLayer(){this._logError(hi,$e("layer"))}};h([c()],v.prototype,"_defaultSnappingManager",void 0),h([c()],v.prototype,"updating",null),h([c({readOnly:!0})],v.prototype,"_updatingHandles",void 0),h([c()],v.prototype,"_operationHandle",void 0),h([c({readOnly:!0})],v.prototype,"activeTool",null),h([c({readOnly:!0})],v.prototype,"activeCreateToolDrawMode",null),h([c()],v.prototype,"activeTooltip",null),h([c({types:Y})],v.prototype,"activeFillSymbol",void 0),h([c()],v.prototype,"activeLineSymbol",void 0),h([c()],v.prototype,"activeVertexSymbol",void 0),h([c()],v.prototype,"allowDeleteKey",void 0),h([c({readOnly:!0})],v.prototype,"createGraphic",null),h([c()],v.prototype,"defaultCreateOptions",null),h([c()],v.prototype,"defaultUpdateOptions",null),h([c({type:jt,nonNullable:!0})],v.prototype,"labelOptions",null),h([c()],v.prototype,"layer",void 0),h([c({types:Y})],v.prototype,"pointSymbol",void 0),h([c({types:Y})],v.prototype,"polygonSymbol",void 0),h([c({types:Y})],v.prototype,"polylineSymbol",void 0),h([c()],v.prototype,"meshSymbol",void 0),h([c({type:ue,nonNullable:!0})],v.prototype,"snappingOptions",null),h([c()],v.prototype,"snappingManager",null),h([c({readOnly:!0})],v.prototype,"state",null),h([c({type:Yt,nonNullable:!0})],v.prototype,"tooltipOptions",null),h([c({readOnly:!0})],v.prototype,"updateGraphics",void 0),h([c()],v.prototype,"updateOnGraphicClick",void 0),h([c()],v.prototype,"creationMode",void 0),h([c({type:qt,nonNullable:!0})],v.prototype,"valueOptions",null),h([c({types:Y})],v.prototype,"vertexSymbol",void 0),h([c({value:null})],v.prototype,"view",null),h([c({constructOnly:!0,type:xe})],v.prototype,"sketchOptions",void 0),v=h([I("esri.widgets.Sketch.SketchViewModel")],v);const hi="sketch:missing-property",$e=e=>`Property '${e}' is missing on SketchViewModel.`;function ci(e){return e==="polygon"||e==="rectangle"||e==="circle"}function ie(e,t){Je("undo",e.history.undo,e.history.redo,t)}function oe(e,t){Je("redo",e.history.redo,e.history.undo,t)}function Je(e,t,i,o){const a=t.pop();if(!a)return;const s=a.updates,p=[];o.forEach((r,l)=>{const n=s[l];n!=null&&("geometry"in n&&n.geometry!=null&&(p.push({geometry:r.geometry}),r.geometry=n.geometry),"symbol"in n&&n.symbol!=null&&(p.push({symbol:r.symbol}),r.symbol=n.symbol),"undo"in n&&(p.push(n),n[e](r)))}),i.push({updates:p})}function et(e,t){e!=null&&t.hasGrabbedManipulators&&(e.activeTool=null)}function U(e){return{updates:e.map(({geometry:t})=>t?.type==="mesh"?{geometry:t.cloneShallow()}:{geometry:t})}}function ae(e,t){e.tools?.remove(t),t.destroyed||t.destroy()}function E(e){return"requireError"in e&&e.requireError==="aborted"}const di=v;function se(e,t){e.networkFeature=t}function ui(e){const t=j(e.graphic);return{...e,networkFeature:t}}function yi(e){const t=e.graphics.map(i=>j(i));return{...e,networkFeatures:t}}function j(e){return e.networkFeature}function gi(e){return e?.type==="point"||e?.type==="polyline"||e?.type==="polygon"}let L=class extends W{constructor(e){super(e),this._createMode=null,this._graphicsLayer=new Pe({internal:!0,listMode:"hide",title:"Banana"}),this._updatingHandles=new Me,this.enabled=!0,this._handleSketchViewModelEvents=async t=>{switch(t.type){case"update":switch(t.state){case"active":case"complete":for(const i of t.graphics)j(i).geometry=gi(i.geometry)?i.geometry.clone():null}break;case"undo":case"redo":break;case"delete":for(const i of t.graphics){const o=j(i);this._removeNetworkFeature(o)}break;case"create":if(t.graphic&&t.state==="complete"&&this._createMode){const i=t.graphic.geometry?.clone(),o=t.graphic.symbol?.clone();if(!i)break;switch(this._createMode){case"stop":{if(i.type!=="point")break;const{stops:a}=this.layer;if(a.length>0&&a.every(({geometry:p})=>!p)){a.at(0).geometry=i;break}if(a.length>1&&a.filter((p,r)=>r!==0).every(({geometry:p})=>!p)){a.at(1).geometry=i;break}const s=new Tt({geometry:i});a.add(s),se(t.graphic,s);break}case"point-barrier":{if(i.type!=="point")break;const a=new St({geometry:i,symbol:o});this.layer.pointBarriers.add(a),se(t.graphic,a);break}case"polyline-barrier":{if(i.type!=="polyline")break;const a=new wt({geometry:i,symbol:o});this.layer.polylineBarriers.add(a),se(t.graphic,a);break}case"polygon-barrier":{if(i.type!=="polygon")break;const a=new Et({geometry:i,symbol:o});this.layer.polygonBarriers.add(a),se(t.graphic,a);break}}}}(await this.view.whenLayerView(this.layer)).emit(t.type,t.type==="create"?ui(t):yi(t))}}initialize(){this._sketchViewModel=new di({layer:this._graphicsLayer,view:this.view}),this.addHandles([H(()=>this.enabled,e=>{e?this._activate():this._deactivate()},_t),H(()=>{const{stops:e,pointBarriers:t,polylineBarriers:i,polygonBarriers:o}=this.layer;return{stops:e,pointBarriers:t,polylineBarriers:i,polygonBarriers:o}},()=>{this.enabled&&this._loadClonedGraphics()}),this._sketchViewModel.on(["create","delete","redo","undo","update"],this._handleSketchViewModelEvents),bt(this._updatingHandles)])}destroy(){this.view.map.remove(this._graphicsLayer),this._graphicsLayer.removeAll(),this._graphicsLayer=F(this._graphicsLayer),this._sketchViewModel=F(this._sketchViewModel)}get selectedNetworkFeatures(){return this._sketchViewModel.updateGraphics.map(e=>j(e))}get updating(){return this._updatingHandles.updating}create(e){switch(this._createMode=e,e){case"stop":this.layer.defaultSymbols.stops?.unlocated&&(this._sketchViewModel.pointSymbol=this.layer.defaultSymbols.stops.unlocated.clone());break;case"point-barrier":this.layer.defaultSymbols.pointBarriers&&(this._sketchViewModel.pointSymbol=this.layer.defaultSymbols.pointBarriers.clone());break;case"polyline-barrier":this.layer.defaultSymbols.polylineBarriers&&(this._sketchViewModel.polylineSymbol=this.layer.defaultSymbols.polylineBarriers.clone());break;case"polygon-barrier":this.layer.defaultSymbols.polygonBarriers&&(this._sketchViewModel.polygonSymbol=this.layer.defaultSymbols.polygonBarriers.clone())}switch(e){case"stop":case"point-barrier":return this._sketchViewModel.create("point");case"polyline-barrier":return this._sketchViewModel.create("polyline");case"polygon-barrier":return this._sketchViewModel.create("polygon")}}remove(e){const t=this._graphicsLayer.graphics.find(i=>j(i)===e);t&&this._graphicsLayer.remove(t),this._removeNetworkFeature(e)}_activate(){this._loadClonedGraphics(),this.view.map.add(this._graphicsLayer)}_deactivate(){this._sketchViewModel.cancel(),this.view.map?.remove(this._graphicsLayer),this._graphicsLayer.removeAll()}_loadClonedGraphics(){const e=[this.layer.stops,this.layer.pointBarriers,this.layer.polylineBarriers,this.layer.polygonBarriers].flatMap(t=>t.toArray().map(i=>{const o=i.toGraphic();return o.networkFeature=i,o}));this._graphicsLayer.removeAll().addMany(e)}_removeNetworkFeature(e){switch(e.type){case"stop":this.layer.stops.remove(e);break;case"point-barrier":this.layer.pointBarriers.remove(e);break;case"polyline-barrier":this.layer.polylineBarriers.remove(e);break;case"polygon-barrier":this.layer.polygonBarriers.remove(e)}}};h([c()],L.prototype,"enabled",void 0),h([c({constructOnly:!0})],L.prototype,"layer",void 0),h([c({readOnly:!0})],L.prototype,"selectedNetworkFeatures",null),h([c()],L.prototype,"updating",null),h([c({constructOnly:!0})],L.prototype,"view",void 0),L=h([I("esri.views.2d.layers.support.RouteLayerInteraction")],L);const vi=Object.freeze(Object.defineProperty({__proto__:null,get RouteLayerInteraction(){return L}},Symbol.toStringTag,{value:"Module"}));export{f as P,vi as R,q as a,Ve as b,je as c,Be as d,de as e,ei as f,qe as g,Ke as h,Ze as i,Le as j,ye as n,B as o,K as p,Ye as r,We as s};
