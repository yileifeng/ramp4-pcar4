import{x as W,z as q,bG as Rt,K as Lt,G as Et,s as Gt,o as Ot,n as Y,aF as Wt,aY as et,T as jt,i8 as Mt,bR as qt,bz as $t,d1 as zt}from"./main-BC8gbEPx.js";const Xt=9999999e31,Ht=2e-7,Jt={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34028234663852886e22,34028234663852886e22],f64:[-Number.MAX_VALUE,Number.MAX_VALUE],unknown:void 0,c64:void 0,c128:void 0};function nt(t){return Jt[t]??[-34028234663852886e22,34028234663852886e22]}function Kt(t,e){return t==null||e==null?"s32":t<0?t>=-128&&e<128?"s8":t>=-32768&&e<32768?"s16":"s32":e<256?"u8":e<65536?"u16":"u32"}function At(t){return(t?.startsWith("s")||t?.startsWith("u"))??!1}function Yt(t,e,n,o){let[r,s]=nt(n);const i=At(n);return i&&(r-=1e-5,s+=1e-5),i?n.startsWith("u")?Zt(t,e,o,[r,s]):te(t,e,o,[r,s]):ee(t,e,o,[r,s])}function Qt(t,e){for(let n=0;n<e.length;n++)e[n]&&isNaN(t[n])&&(e[n]=0,t[n]=0)}function Zt(t,e,n,o){const[r,s]=o;for(let i=0;i<e.length;i++)if(e[i]){const c=t[i];c<r||c>s?e[i]=0:n[i]=c+.5|0}}function te(t,e,n,o){const[r,s]=o;for(let i=0;i<e.length;i++)if(e[i]){const c=t[i];c<r||c>s?e[i]=0:n[i]=c+(c>0?.5:-.5)|0}}function ee(t,e,n,o){const[r,s]=o;for(let i=0;i<e.length;i++)if(e[i]){const c=t[i];c<r||c>s?e[i]=0:n[i]=c}}function ne(t,e,n){if(t.depthCount&&t.depthCount>1)return;const{pixels:o,statistics:r,pixelType:s}=t,i=o[0].length,c=t.bandMasks??[],a=t.mask??new Uint8Array(i).fill(255),h=s==="f32"||s==="f64",l=nt(s);let u=!1;for(let f=0;f<o.length;f++){const m=typeof e=="number"?e:e[f];if(m==null)continue;const d=r?.[f]?.minValue??l[0],x=r?.[f]?.maxValue??l[1];if(d>m+Number.EPSILON||x<m-Number.EPSILON)continue;const y=c[f]||a.slice(),k=o[f],M=n?.customFloatTolerance;if(h&&M!==0){let w=M;w||(w=Math.abs(m)>=Xt?Ht*Math.abs(m):s==="f32"?2**-23:Number.EPSILON);for(let g=0;g<k.length;g++)y[g]&&Math.abs(k[g]-m)<w&&(k[g]=0,y[g]=0,a[g]=0,u=!0)}else for(let w=0;w<k.length;w++)y[w]&&k[w]===m&&(k[w]=0,y[w]=0,a[w]=0,u=!0);c[f]=y}if(u){const f=t.bandMasks||t.pixels.length>1?c:null;n?.matchAllNoData?t.mask=f&&f.length>1?p(f):a:(t.bandMasks=f,t.mask=a)}function p(f){if(f.length<2)return f[0];const m=f[0].length,d=new Uint8Array(m).fill(0);for(let x=0;x<f.length;x++){const y=f[x];for(let k=0;k<m;k++)y[k]&&(d[k]=255)}return d}u&&"updateStatistics"in t&&t.updateStatistics()}let ct=class{constructor(t=null,e=null,n=null){this.minValue=t,this.maxValue=e,this.noDataValue=n}};var J;let O=J=class extends Et{static createEmptyBand(t,e){return new(J.getPixelArrayConstructor(t))(e)}static combineBandMasks(t){if(t.length<2)return t[0];const e=t[0].length,n=new Uint8Array(e).fill(255);for(let o=0;o<t.length;o++){const r=t[o];for(let s=0;s<e;s++)r[s]||(n[s]=0)}return n}static getPixelArrayConstructor(t){let e;switch(t){case"u1":case"u2":case"u4":case"u8":e=Uint8Array;break;case"u16":e=Uint16Array;break;case"u32":e=Uint32Array;break;case"s8":e=Int8Array;break;case"s16":e=Int16Array;break;case"s32":e=Int32Array;break;case"f32":case"c64":case"c128":case"unknown":e=Float32Array;break;case"f64":e=Float64Array}return e}constructor(t){super(t),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(t){if(!t)return"f32";let e=t.toLowerCase();return["u1","u2","u4"].includes(e)?e="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(e)||(e="f32"),e}getPlaneCount(){return this.pixels?.length}addData(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new Gt("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(t.pixels),this.statistics.push(t.statistics??new ct)}getAsRGBA(){const t=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(t);break;default:this._fillFrom8Bit(t)}return new Uint8ClampedArray(t)}getAsRGBAFloat(){const t=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(t),t}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map(n=>ie(n,this.mask));const t=this.mask;let e=0;if(t!=null)for(let n=0;n<t.length;n++)t[n]&&e++;else e=this.width*this.height;this.validPixelCount=e}clamp(t){if(!t||t==="f64"||t==="f32"||!this.pixels)return;const[e,n]=nt(t),o=this.pixels,r=this.width*this.height,s=o.length;let i,c,a;const h=[];for(let l=0;l<s;l++){a=J.createEmptyBand(t,r),i=o[l];for(let u=0;u<r;u++)c=i[u],a[u]=c>n?n:c<e?e:c;h.push(a)}this.pixels=h,this.pixelType=t}extractBands(t){const{pixels:e,statistics:n}=this;if(t==null||t.length===0||!e||e.length===0)return this;const o=e.length,r=t.some(u=>u>=e.length),s=o===t.length&&!t.some((u,p)=>u!==p);if(r||s)return this;const i=this.bandMasks?.length===o?t.map(u=>this.bandMasks[u]):void 0;let{mask:c,validPixelCount:a}=this;const{width:h,height:l}=this;return i?.length&&(c=J.combineBandMasks(i),a=c.filter(u=>!!u).length),new J({pixelType:this.pixelType,width:h,height:l,mask:c,bandMasks:i,validPixelCount:a,maskIsAlpha:this.maskIsAlpha,pixels:t.map(u=>e[u]),statistics:n&&t.map(u=>n[u])})}clone(){const t=new J({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});let e;this.mask!=null&&(t.mask=new Uint8Array(this.mask)),this.bandMasks&&(t.bandMasks=this.bandMasks.map(o=>new Uint8Array(o)));const n=J.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){t.pixels=[];const o=!!this.pixels[0].slice;for(e=0;e<this.pixels.length;e++)t.pixels[e]=o?this.pixels[e].slice():new n(this.pixels[e])}if(this.statistics)for(t.statistics=[],e=0;e<this.statistics.length;e++)t.statistics[e]=Ot(this.statistics[e]);return t.premultiplyAlpha=this.premultiplyAlpha,t}_fillFrom8Bit(t){const{mask:e,maskIsAlpha:n,premultiplyAlpha:o,pixels:r}=this;if(!t||!r?.length)return void Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let s,i,c,a;s=i=c=r[0],r.length>=3?(i=r[1],c=r[2]):r.length===2&&(i=r[1]);const h=new Uint32Array(t),l=this.width*this.height;if(s.length===l)if(e!=null&&e.length===l)if(n)for(a=0;a<l;a++){const u=e[a];if(u){const p=u/255;h[a]=o?u<<24|c[a]*p<<16|i[a]*p<<8|s[a]*p:u<<24|c[a]<<16|i[a]<<8|s[a]}}else for(a=0;a<l;a++)e[a]&&(h[a]=255<<24|c[a]<<16|i[a]<<8|s[a]);else for(a=0;a<l;a++)h[a]=255<<24|c[a]<<16|i[a]<<8|s[a];else Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(t){const{pixels:e,mask:n,statistics:o}=this;if(!t||!e?.length)return void Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const r=this.pixelType;let s=1,i=0,c=1;if(o&&o.length>0){for(const d of o)if(d.minValue!=null&&(i=Math.min(i,d.minValue)),d.maxValue!=null&&d.minValue!=null){const x=d.maxValue-d.minValue;c=Math.max(c,x)}s=255/c}else{let d=255;r==="s8"?(i=-128,d=127):r==="u16"?d=65535:r==="s16"?(i=-32768,d=32767):r==="u32"?d=4294967295:r==="s32"?(i=-2147483648,d=2147483647):r==="f32"?(i=-34e38,d=34e38):r==="f64"&&(i=-Number.MAX_VALUE,d=Number.MAX_VALUE),s=255/(d-i)}const a=new Uint32Array(t),h=this.width*this.height;let l,u,p,f,m;if(l=u=p=e[0],l.length!==h)return Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(e.length>=2)if(u=e[1],e.length>=3&&(p=e[2]),n!=null&&n.length===h)for(f=0;f<h;f++)n[f]&&(a[f]=255<<24|(p[f]-i)*s<<16|(u[f]-i)*s<<8|(l[f]-i)*s);else for(f=0;f<h;f++)a[f]=255<<24|(p[f]-i)*s<<16|(u[f]-i)*s<<8|(l[f]-i)*s;else if(n!=null&&n.length===h)for(f=0;f<h;f++)m=(l[f]-i)*s,n[f]&&(a[f]=255<<24|m<<16|m<<8|m);else for(f=0;f<h;f++)m=(l[f]-i)*s,a[f]=255<<24|m<<16|m<<8|m}_fillFrom32Bit(t){const{pixels:e,mask:n}=this;if(!t||!e?.length)return Y.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let o,r,s,i;o=r=s=e[0],e.length>=3?(r=e[1],s=e[2]):e.length===2&&(r=e[1]);const c=this.width*this.height;if(o.length!==c)return Y.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let a=0;if(n!=null&&n.length===c)for(i=0;i<c;i++)t[a++]=o[i],t[a++]=r[i],t[a++]=s[i],t[a++]=1&n[i];else for(i=0;i<c;i++)t[a++]=o[i],t[a++]=r[i],t[a++]=s[i],t[a++]=1}};function ie(t,e){let n=1/0,o=-1/0;const r=t.length;let s,i=0;if(e!=null)for(s=0;s<r;s++)e[s]&&(i=t[s],n=i<n?i:n,o=i>o?i:o);else for(s=0;s<r;s++)i=t[s],n=i<n?i:n,o=i>o?i:o;return new ct(n,o)}W([q({json:{write:!0}})],O.prototype,"width",void 0),W([q({json:{write:!0}})],O.prototype,"height",void 0),W([q({json:{write:!0}})],O.prototype,"pixelType",void 0),W([Rt("pixelType")],O.prototype,"castPixelType",null),W([q({json:{write:!0}})],O.prototype,"validPixelCount",void 0),W([q({json:{write:!0}})],O.prototype,"mask",void 0),W([q({json:{write:!0}})],O.prototype,"maskIsAlpha",void 0),W([q({json:{write:!0}})],O.prototype,"pixels",void 0),W([q()],O.prototype,"premultiplyAlpha",void 0),W([q({json:{write:!0}})],O.prototype,"statistics",void 0),W([q({json:{write:!0}})],O.prototype,"depthCount",void 0),W([q({json:{write:!0}})],O.prototype,"noDataValues",void 0),W([q({json:{write:!0}})],O.prototype,"bandMasks",void 0),O=J=W([Lt("esri.layers.support.PixelBlock")],O);const D=O;var ut,ft;(function(t){t[t.matchAny=0]="matchAny",t[t.matchAll=1]="matchAll"})(ut||(ut={})),function(t){t[t.bestMatch=0]="bestMatch",t[t.fail=1]="fail"}(ft||(ft={}));const se=6;function N(t){return t!=null&&t.declaredClass==="esri.layers.support.PixelBlock"&&t.pixels&&t.pixels.length>0}function le(t){if(!t?.length||t.some(l=>!N(l)))return null;if(t.length===1)return t[0]?.clone()??null;const e=t,{width:n,height:o,pixelType:r}=e[0];if(e.some(l=>l.width!==n||l.height!==o))return null;const s=e.map(({mask:l})=>l).filter(l=>l!=null);let i=null;s.length&&(i=new Uint8Array(n*o),i.set(s[0]),s.length>1&&Ut(s.slice(1),i));const c=[];e.forEach(({pixels:l})=>c.push(...l));const a=e.map(({statistics:l})=>l).filter(l=>l?.length),h=[];return a.forEach(l=>h.push(...l)),new D({pixelType:r,width:n,height:o,mask:i,pixels:c,statistics:h.length?h:null})}function oe(t){if(!t)return;const e=t.colormap;if(!e||e.length===0)return;const n=e.sort((u,p)=>u[0]-p[0]);let o=0;n[0][0]<0&&(o=n[0][0]);const r=Math.max(256,n[n.length-1][0]-o+1),s=new Uint8Array(4*r),i=[];let c,a=0,h=0;const l=n[0].length===5;if(r>65536)return n.forEach(u=>{i[u[0]-o]=l?u.slice(1):u.slice(1).concat([255])}),{indexed2DColormap:i,offset:o,alphaSpecified:l};if(t.fillUnspecified)for(c=n[h],a=c[0]-o;a<r;a++)s[4*a]=c[1],s[4*a+1]=c[2],s[4*a+2]=c[3],s[4*a+3]=l?c[4]:255,a===c[0]-o&&(c=h===n.length-1?c:n[++h]);else for(a=0;a<n.length;a++)c=n[a],h=4*(c[0]-o),s[h]=c[1],s[h+1]=c[2],s[h+2]=c[3],s[h+3]=l?c[4]:255;return{indexedColormap:s,offset:o,alphaSpecified:l}}function re(t,e){if(!N(t)||!e||!e.indexedColormap&&!e.indexed2DColormap)return t;const n=t.clone(),o=n.pixels;let r=n.mask;const s=n.width*n.height;if(o.length!==1)return t;const{indexedColormap:i,indexed2DColormap:c,offset:a,alphaSpecified:h}=e;let l=0;const u=o[0],p=new Uint8Array(u.length),f=new Uint8Array(u.length),m=new Uint8Array(u.length);let d,x=0;if(i){const y=i.length-1;if(r!=null)for(l=0;l<s;l++)r[l]&&(x=4*(u[l]-a),x<a||x>y?r[l]=0:(p[l]=i[x],f[l]=i[x+1],m[l]=i[x+2],r[l]=i[x+3]));else{for(r=new Uint8Array(s),l=0;l<s;l++)x=4*(u[l]-a),x<a||x>y?r[l]=0:(p[l]=i[x],f[l]=i[x+1],m[l]=i[x+2],r[l]=i[x+3]);n.mask=r}}else if(c)if(r!=null)for(l=0;l<s;l++)r[l]&&(d=c[u[l]],p[l]=d[0],f[l]=d[1],m[l]=d[2],r[l]=d[3]);else{for(r=new Uint8Array(s),l=0;l<s;l++)d=c[u[l]],p[l]=d[0],f[l]=d[1],m[l]=d[2],r[l]=d[3];n.mask=r}return n.pixels=[p,f,m],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=h,n}function ae(t,e){if(!N(t))return null;const{pixels:n,mask:o}=t,r=n.length;let s=e.lut;const{offset:i}=e;s&&s[0].length===1&&(s=n.map(()=>s));const c=[],a=e.outputPixelType||"u8";for(let l=0;l<r;l++){const u=pt(n[l],o,s[l],i||0,a);c.push(u)}const h=new D({width:t.width,height:t.height,pixels:c,mask:o,pixelType:a});return h.updateStatistics(),h}function pt(t,e,n,o,r){const s=t.length,i=D.createEmptyBand(r,s);if(e)for(let c=0;c<s;c++)e[c]&&(i[c]=n[t[c]-o]);else for(let c=0;c<s;c++)i[c]=n[t[c]-o];return i}function he(t,e){if(!N(t))return null;const n=t.clone(),{pixels:o}=n,r=n.width*n.height,s=e.length,i=Math.floor(s/2),c=e[Math.floor(i)],a=o[0];let h,l,u,p,f,m,d=!1;const x=new Uint8Array(r),y=new Uint8Array(r),k=new Uint8Array(r);let M=n.mask;const w=e[0].mappedColor.length===4;for(M||(M=new Uint8Array(r),M.fill(w?255:1),n.mask=M),f=0;f<r;f++)if(M[f]){for(h=a[f],d=!1,m=i,l=c,u=0,p=s-1;p-u>1;){if(h===l.value){d=!0;break}h>l.value?u=m:p=m,m=Math.floor((u+p)/2),l=e[Math.floor(m)]}d||(h===e[u].value?(l=e[u],d=!0):h===e[p].value?(l=e[p],d=!0):h<e[u].value?(d=!1,l=null):h>e[u].value&&(h<e[p].value?(l=e[u],d=!0):p===s-1?(d=!1,l=null):(l=e[p],d=!0))),d?(x[f]=l.mappedColor[0],y[f]=l.mappedColor[1],k[f]=l.mappedColor[2],M[f]=l.mappedColor[3]):x[f]=y[f]=k[f]=M[f]=0}return n.pixels=[x,y,k],n.mask=M,n.pixelType="u8",n.maskIsAlpha=w,n}function ce(t,e){if(!N(t))return null;const{width:n,height:o}=t,{inputRanges:r,outputValues:s,outputPixelType:i,noDataRanges:c,allowUnmatched:a,isLastInputRangeInclusive:h}=e,l=t.pixels[0],u=D.createEmptyBand(i,l.length),p=t.mask,f=new Uint8Array(n*o);p?f.set(p):f.fill(255);const m=t.pixelType.startsWith("f")?1e-6:0,d=r.map(w=>w-m);d[0]=r[0],d[d.length-1]=r[r.length-1]+(h?1e-6:0);const x=r.length/2,[y,k]=nt(i);for(let w=0;w<o;w++)for(let g=0;g<n;g++){const b=w*n+g;if(f[b]){const U=l[b];let P=!1;for(let B=x-1;B>=0;B--)if(U===d[2*B]||U>d[2*B]&&U<d[2*B+1]){u[b]=s[B],P=!0;break}P||(a?u[b]=U>k?k:U<y?y:U:f[b]=0)}}const M=c?.length;if(M)for(let w=0;w<o;w++)for(let g=0;g<n;g++){const b=w*n+g;if(!p||p[b]){const U=l[b];for(let P=0;P<M;P+=2)if(U>=c[P]&&U<=c[P+1]){u[b]=0,f[b]=0;break}}}return new D({width:n,height:o,pixelType:i,pixels:[u],mask:f})}function bt(t,e,n,o){const r=n!=null&&n.length>=2?new Set(n):null,s=n?.length===1?n[0]:null,i=!!e?.length;for(let c=0;c<t.length;c++)if(o[c]){const a=t[c];if(i){let h=!1;for(let l=0;l<e.length;l+=2)if(a>=e[l]&&a<=e[l+1]){h=!0;break}h||(o[c]=0)}o[c]&&(a===s||r?.has(a))&&(o[c]=0)}}function vt(t,e){const n=t[0].length;for(let o=0;o<n;o++)if(e[o]){let r=!1;for(let s=0;s<t.length;s++)if(t[s][o]){r=!0;break}r||(e[o]=0)}}function Ut(t,e){const n=t[0].length;for(let o=0;o<n;o++)if(e[o]){let r=!1;for(let s=0;s<t.length;s++)if(t[s][o]===0){r=!0;break}r&&(e[o]=0)}}function ue(t,e){if(!N(t))return null;const{width:n,height:o,pixels:r}=t,s=n*o,i=new Uint8Array(s);t.mask?i.set(t.mask):i.fill(255);const c=r.length,{includedRanges:a,noDataValues:h,outputPixelType:l,matchAll:u,lookups:p}=e;if(p){const f=[];for(let m=0;m<c;m++){const d=p[m],x=pt(r[m],i,d.lut,d.offset||0,"u8");f.push(x)}f.length===1?i.set(f[0]):u?vt(f,i):Ut(f,i)}else if(u){const f=[];for(let m=0;m<c;m++){const d=new Uint8Array(s);d.set(i),bt(r[m],a?.slice(2*m,2*m+2),h?.[m],d),f.push(d)}f.length===1?i.set(f[0]):vt(f,i)}else for(let f=0;f<c;f++)bt(r[f],a?.slice(2*f,2*f+2),h?.[f],i);return new D({width:n,height:o,pixelType:l,pixels:r,mask:i})}function fe(t){const{srcPixelType:e,inputRanges:n,outputValues:o,allowUnmatched:r,noDataRanges:s,isLastInputRangeInclusive:i,outputPixelType:c}=t;if(e!=="u8"&&e!=="s8"&&e!=="u16"&&e!=="s16")return null;const a=e.includes("16")?65536:256,h=e.includes("s")?-a/2:0,l=D.createEmptyBand(c,a),u=new Uint8Array(a);r&&u.fill(255);const[p,f]=nt(c);if(n?.length&&o?.length){const m=n.map(d=>d-1e-6);m[0]=n[0],i&&(m[m.length-1]=n[n.length-1]);for(let d=0;d<m.length;d++){const x=o[d]>f?f:o[d]<p?p:o[d],y=Math.ceil(m[2*d]-h),k=Math.floor(m[2*d+1]-h);for(let M=y;M<=k;M++)l[M]=x,u[M]=255}}if(s?.length)for(let m=0;m<s.length;m++){const d=Math.ceil(s[2*m]-h),x=Math.floor(s[2*m+1]-h);for(let y=d;y<=x;y++)u[y]=0}return{lut:l,offset:h,mask:u}}function pe(t,e,n){if(t!=="u8"&&t!=="s8"&&t!=="u16"&&t!=="s16")return null;const o=t.includes("16")?65536:256,r=t.includes("s")?-o/2:0,s=new Uint8Array(o);if(e)for(let i=0;i<e.length;i++){const c=Math.ceil(e[2*i]-r),a=Math.floor(e[2*i+1]-r);for(let h=c;h<=a;h++)s[h]=255}else s.fill(255);if(n)for(let i=0;i<n.length;i++)s[n[i]-r]=0;return{lut:s,offset:r}}function de(t,e,n,o,r,s,i,c){return{xmin:r<=n*t?0:r<n*t+t?r-n*t:t,ymin:s<=o*e?0:s<o*e+e?s-o*e:e,xmax:r+i<=n*t?0:r+i<n*t+t?r+i-n*t:t,ymax:s+c<=o*e?0:s+c<o*e+e?s+c-o*e:e}}function me(t,e){if(!t||t.length===0)return null;const n=t.find(m=>m.pixelBlock);if(n?.pixelBlock==null)return null;const o=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,r=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,s=.01*Math.min(o,r),i=t.sort((m,d)=>Math.abs(m.extent.ymax-d.extent.ymax)>s?d.extent.ymax-m.extent.ymax:Math.abs(m.extent.xmin-d.extent.xmin)>s?m.extent.xmin-d.extent.xmin:0),c=Math.min.apply(null,i.map(m=>m.extent.xmin)),a=Math.min.apply(null,i.map(m=>m.extent.ymin)),h=Math.max.apply(null,i.map(m=>m.extent.xmax)),l=Math.max.apply(null,i.map(m=>m.extent.ymax)),u={x:Math.round((e.xmin-c)/o),y:Math.round((l-e.ymax)/r)},p={width:Math.round((h-c)/o),height:Math.round((l-a)/r)},f={width:Math.round((e.xmax-e.xmin)/o),height:Math.round((e.ymax-e.ymin)/r)};return Math.round(p.width/n.pixelBlock.width)*Math.round(p.height/n.pixelBlock.height)!==i.length||u.x<0||u.y<0||p.width<f.width||p.height<f.height?null:{extent:e,pixelBlock:Pt(i.map(m=>m.pixelBlock),p,{clipOffset:u,clipSize:f})}}function dt(t,e,n,o,r,s){const{width:i,height:c}=n.block,{x:a,y:h}=n.offset,{width:l,height:u}=n.mosaic,p=de(i,c,o,r,a,h,l,u);let f=0,m=0;if(s){const d=s.hasGCSSShiftTransform?360:s.halfWorldWidth??0,x=i*s.resolutionX,y=s.startX+o*x;y<d&&y+x>d?m=s.rightPadding:y>=d&&(f=s.leftMargin-s.rightPadding,m=0)}if(p.xmax-=m,typeof e!="number")for(let d=p.ymin;d<p.ymax;d++){const x=(r*c+d-h)*l+(o*i-a)+f,y=d*i;for(let k=p.xmin;k<p.xmax;k++)t[x+k]=e[y+k]}else for(let d=p.ymin;d<p.ymax;d++){const x=(r*c+d-h)*l+(o*i-a)+f;for(let y=p.xmin;y<p.xmax;y++)t[x+y]=e}}function Pt(t,e,n={}){const{clipOffset:o,clipSize:r,alignmentInfo:s,blockWidths:i}=n;if(i)return ge(t,e,{blockWidths:i});const c=t.find(v=>N(v));if(c==null)return null;const a=r?r.width:e.width,h=r?r.height:e.height,l=c.width,u=c.height,p=e.width/l,f=e.height/u,m={offset:o||{x:0,y:0},mosaic:r||e,block:{width:l,height:u}},d=c.pixelType,x=D.getPixelArrayConstructor(d),y=c.pixels.length,k=[];let M,w;for(let v=0;v<y;v++){w=new x(a*h);for(let I=0;I<f;I++)for(let A=0;A<p;A++){const T=t[I*p+A];N(T)&&(M=T.pixels[v],dt(w,M,m,A,I,s))}k.push(w)}const g=t.some(v=>v==null||v.mask!=null&&v.mask.length>0),b=t.some(v=>v?.bandMasks&&v.bandMasks.length>1),U=g?new Uint8Array(a*h):void 0,P=b?[]:void 0;if(U){for(let v=0;v<f;v++)for(let I=0;I<p;I++){const A=t[v*p+I],T=A!=null?A.mask:null;dt(U,T??(A?255:0),m,I,v,s)}if(P)for(let v=0;v<y;v++){const I=new Uint8Array(a*h);for(let A=0;A<f;A++)for(let T=0;T<p;T++){const C=t[A*p+T],S=C?.bandMasks?.[v]??C?.mask;dt(I,S??(C?255:0),m,T,A,s)}P.push(I)}}const B=new D({width:a,height:h,pixels:k,pixelType:d,bandMasks:P,mask:U});return B.updateStatistics(),B}function ge(t,e,n){const o=t.find(x=>x!=null);if(o==null)return null;const r=t.some(x=>x==null||!!x.mask),{width:s,height:i}=e,c=r?new Uint8Array(s*i):null,{blockWidths:a}=n,h=[],l=o.getPlaneCount(),u=D.getPixelArrayConstructor(o.pixelType);if(r)for(let x=0,y=0;x<t.length;y+=a[x],x++){const k=t[x];if(!N(k))continue;const M=k.mask;for(let w=0;w<i;w++)for(let g=0;g<a[x];g++)c[w*s+g+y]=M==null?255:M[w*k.width+g]}const p=t.some(x=>x?.bandMasks&&x.bandMasks.length>1),f=p?[]:void 0,m=s*i;for(let x=0;x<l;x++){const y=new u(m),k=p?new Uint8Array(m):void 0;for(let M=0,w=0;M<t.length;w+=a[M],M++){const g=t[M];if(!N(g))continue;const b=g.pixels[x];if(b!=null){for(let U=0;U<i;U++)for(let P=0;P<a[M];P++)y[U*s+P+w]=b[U*g.width+P];if(k){const U=g.bandMasks?.[x]??g.mask;for(let P=0;P<i;P++)for(let B=0;B<a[M];B++)k[P*s+B+w]=U?U[P*g.width+B]:255}}}h.push(y),f&&k&&f.push(k)}const d=new D({width:s,height:i,mask:c,bandMasks:f,pixels:h,pixelType:o.pixelType});return d.updateStatistics(),d}function xe(t,e,n){if(!N(t))return null;const{width:o,height:r}=t,s=e.x,i=e.y,c=n.width+s,a=n.height+i;if(s<0||i<0||c>o||a>r||s===0&&i===0&&c===o&&a===r)return t;t.mask||(t.mask=new Uint8Array(o*r));const h=t.mask;for(let l=0;l<r;l++){const u=l*o;for(let p=0;p<o;p++)h[u+p]=l<i||l>=a||p<s||p>=c?0:1}return t.updateStatistics(),t}function we(t){if(!N(t))return null;const e=t.clone(),{width:n,height:o,pixels:r}=t,s=r[0],i=e.pixels[0],c=t.mask;for(let a=2;a<o-1;a++){const h=new Map;for(let u=a-2;u<a+2;u++)for(let p=0;p<4;p++){const f=u*n+p;lt(h,s[f],c?c[f]:1)}i[a*n]=Tt(h),i[a*n+1]=i[a*n+2]=i[a*n];let l=3;for(;l<n-1;l++){let u=(a-2)*n+l+1;lt(h,s[u],c?c[u]:1),u=(a-1)*n+l+1,lt(h,s[u],c?c[u]:1),u=a*n+l+1,lt(h,s[u],c?c[u]:1),u=(a+1)*n+l+1,lt(h,s[u],c?c[u]:1),u=(a-2)*n+l-3,rt(h,s[u],c?c[u]:1),u=(a-1)*n+l-3,rt(h,s[u],c?c[u]:1),u=a*n+l-3,rt(h,s[u],c?c[u]:1),u=(a+1)*n+l-3,rt(h,s[u],c?c[u]:1),i[a*n+l]=Tt(h)}i[a*n+l+1]=i[a*n+l]}for(let a=0;a<n;a++)i[a]=i[n+a]=i[2*n+a],i[(o-1)*n+a]=i[(o-2)*n+a];return e.updateStatistics(),e}function Tt(t){if(t.size===0)return 0;let e=0,n=-1,o=0;const r=t.keys();let s=r.next();for(;!s.done;)o=t.get(s.value),o>e&&(n=s.value,e=o),s=r.next();return n}function rt(t,e,n){if(n===0)return;const o=t.get(e);o===1?t.delete(e):t.set(e,o-1)}function lt(t,e,n){n!==0&&t.set(e,t.has(e)?t.get(e)+1:1)}function mt(t,e,n){let{x:o,y:r}=e;const{width:s,height:i}=n;if(o===0&&r===0&&i===t.height&&s===t.width)return t;const{width:c,height:a}=t,h=Math.max(0,r),l=Math.max(0,o),u=Math.min(o+s,c),p=Math.min(r+i,a);if(u<0||p<0||!N(t))return null;o=Math.max(0,-o),r=Math.max(0,-r);const{pixels:f}=t,m=s*i,d=f.length,x=[];for(let w=0;w<d;w++){const g=f[w],b=D.createEmptyBand(t.pixelType,m);for(let U=h;U<p;U++){const P=U*c;let B=(U+r-h)*s+o;for(let v=l;v<u;v++)b[B++]=g[P+v]}x.push(b)}const y=new Uint8Array(m),k=t.mask;for(let w=h;w<p;w++){const g=w*c;let b=(w+r-h)*s+o;for(let U=l;U<u;U++)y[b++]=k?k[g+U]:1}const M=new D({width:n.width,height:n.height,pixelType:t.pixelType,pixels:x,mask:y});return M.updateStatistics(),M}function It(t,e=!0){if(!N(t))return null;const{pixels:n,width:o,height:r,mask:s,pixelType:i}=t,c=[],a=Math.round(o/2),h=Math.round(r/2),l=r-1,u=o-1;for(let f=0;f<n.length;f++){const m=n[f],d=D.createEmptyBand(i,a*h);let x=0;for(let y=0;y<r;y+=2)for(let k=0;k<o;k+=2){const M=m[y*o+k];if(e){const w=k===u?M:m[y*o+k+1],g=y===l?M:m[y*o+k+o],b=k===u?g:y===l?w:m[y*o+k+o+1];d[x++]=(M+w+g+b)/4}else d[x++]=M}c.push(d)}let p=null;if(s!=null){p=new Uint8Array(a*h);let f=0;for(let m=0;m<r;m+=2)for(let d=0;d<o;d+=2){const x=s[m*o+d];if(e){const y=d===u?x:s[m*o+d+1],k=m===l?x:s[m*o+d+o],M=d===u?k:m===l?y:s[m*o+d+o+1];p[f++]=x*y*k*M?1:0}else p[f++]=x}}return new D({width:a,height:h,pixelType:i,pixels:c,mask:p})}function ye(t,e,n=0,o=!0){if(!N(t))return null;const{width:r,height:s}=e;let{width:i,height:c}=t;const a=new Map,h={x:0,y:0},l=1+n;let u=t;for(let p=0;p<l;p++){const f=Math.ceil(i/r),m=Math.ceil(c/s);for(let d=0;d<m;d++){h.y=d*s;for(let x=0;x<f;x++){h.x=x*r;const y=mt(u,h,e);a.set(`${p}/${d}/${x}`,y)}}p<l-1&&(u=It(u,o)),i=Math.round(i/2),c=Math.round(c/2)}return a}function ke(t){const{pixelBlock:e,tileSize:n,level:o,row:r,col:s,useBilinear:i}=t;if(!N(e))return null;const{width:c,height:a}=n,h=2**o,l=h*c,u=h*a;let p=mt(e,{y:r*u,x:s*l},{width:l,height:u});if(!p)return null;for(let f=o;f>0;f--)p=It(p,i);return p}function Bt(t,e,n,o,r=0){const{width:s,height:i}=t,{width:c,height:a}=e,h=o.cols,l=o.rows,u=Math.ceil(c/h-.1/h),p=Math.ceil(a/l-.1/l);let f,m,d,x,y,k,M;const w=u*h,g=w*p*l,b=new Float32Array(g),U=new Float32Array(g),P=new Uint32Array(g),B=new Uint32Array(g);let v,I,A=0;for(let T=0;T<p;T++)for(let C=0;C<u;C++){f=12*(T*u+C),m=n[f],d=n[f+1],x=n[f+2],y=n[f+3],k=n[f+4],M=n[f+5];for(let S=0;S<l;S++){A=(T*l+S)*w+C*h,I=(S+.5)/l;for(let F=0;F<S;F++)v=(F+.5)/h,b[A+F]=(m*v+d*I+x)*s+r,U[A+F]=(y*v+k*I+M)*i+r,P[A+F]=Math.floor(b[A+F]),B[A+F]=Math.floor(U[A+F])}f+=6,m=n[f],d=n[f+1],x=n[f+2],y=n[f+3],k=n[f+4],M=n[f+5];for(let S=0;S<l;S++){A=(T*l+S)*w+C*h,I=(S+.5)/l;for(let F=S;F<h;F++)v=(F+.5)/h,b[A+F]=(m*v+d*I+x)*s+r,U[A+F]=(y*v+k*I+M)*i+r,P[A+F]=Math.floor(b[A+F]),B[A+F]=Math.floor(U[A+F])}}return{offsets_x:b,offsets_y:U,offsets_xi:P,offsets_yi:B,gridWidth:w}}function Me(t,e){const{coefficients:n,spacing:o}=e,{offsets_x:r,offsets_y:s,gridWidth:i}=Bt(t,t,n,{rows:o[0],cols:o[1]}),{width:c,height:a}=t,h=new Float32Array(c*a),l=180/Math.PI;for(let u=0;u<a;u++)for(let p=0;p<c;p++){const f=u*i+p,m=u===0?f:f-i,d=u===a-1?f:f+i,x=r[m]-r[d],y=s[d]-s[m];if(isNaN(x)||isNaN(y))h[u*c+p]=90;else{let k=Math.atan2(y,x)*l;k=(360+k)%360,h[u*c+p]=k}}return h}function Ae(t,e,n,o,r="nearest"){if(!N(t))return null;r==="majority"&&(t=we(t));const{pixels:s,mask:i,bandMasks:c,pixelType:a}=t,h=t.width,l=t.height,u=D.getPixelArrayConstructor(a),p=s.length,{width:f,height:m}=e;let d=!1;for(let A=0;A<n.length;A+=3)n[A]===-1&&n[A+1]===-1&&n[A+2]===-1&&(d=!0);const{offsets_x:x,offsets_y:y,offsets_xi:k,offsets_yi:M,gridWidth:w}=Bt({width:h,height:l},e,n,o,r==="majority"?.5:0);let g;const b=(A,T,C,S)=>{const F=A instanceof Float32Array||A instanceof Float64Array?0:.5;for(let L=0;L<m;L++){g=L*w;for(let V=0;V<f;V++){if(x[g]<0||y[g]<0)A[L*f+V]=0;else if(S)A[L*f+V]=T[k[g]+M[g]*h];else{const G=Math.floor(x[g]),j=Math.floor(y[g]),$=Math.ceil(x[g]),H=Math.ceil(y[g]),X=x[g]-G,K=y[g]-j;if(!C||C[G+j*h]&&C[$+j*h]&&C[G+H*h]&&C[$+H*h]){const tt=(1-X)*T[G+j*h]+X*T[$+j*h],_=(1-X)*T[G+H*h]+X*T[$+H*h];A[L*f+V]=(1-K)*tt+K*_+F}else A[L*f+V]=T[k[g]+M[g]*h]}g++}}},U=[];let P;const B=c?.length===p,v=[];for(let A=0;A<p;A++){if(B){const T=new Uint8Array(f*m);b(T,c[A],c[A],!0),v.push(T)}P=new u(f*m),b(P,s[A],B?c[A]:i,r==="nearest"||r==="majority"),U.push(P)}const I=new D({width:f,height:m,pixelType:a,pixels:U,bandMasks:B?v:void 0});if(i!=null)I.mask=new Uint8Array(f*m),b(I.mask,i,i,!0);else if(d){I.mask=new Uint8Array(f*m);for(let A=0;A<f*m;A++)I.mask[A]=x[A]<0||y[A]<0?0:1}return I.updateStatistics(),I}const Q=new Map;Q.set("meter-per-second",1),Q.set("kilometer-per-hour",.277778),Q.set("knots",.514444),Q.set("feet-per-second",.3048),Q.set("mile-per-hour",.44704);const gt=180/Math.PI,xt=5,ot=new Wt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function at(t,e){return Q.get(t)/Q.get(e)||1}function St(t){return(450-t)%360}function wt(t,e="geographic"){const[n,o]=t,r=Math.sqrt(n*n+o*o);let s=Math.atan2(o,n)*gt;return s=(360+s)%360,e==="geographic"&&(s=St(s)),[r,s]}function be(t,e="geographic"){let n=t[1];e==="geographic"&&(n=St(n)),n%=360;const o=t[0];return[o*Math.cos(n/gt),o*Math.sin(n/gt)]}function ve(t,e,n,o="geographic"){if(!N(t)||n==null)return t;const r=e==="vector-magdir"?t.clone():yt(t,e),s=r.pixels[1];for(let i=0;i<s.length;i++)s[i]=o==="geographic"?(s[i]+n[i]+270)%360:(s[i]+360-n[i])%360;return e==="vector-magdir"?r:yt(r,"vector-magdir")}function yt(t,e,n="geographic",o=1){if(!N(t))return t;const{pixels:r,width:s,height:i}=t,c=s*i,a=r[0],h=r[1],l=t.pixelType.startsWith("f")?t.pixelType:"f32",u=D.createEmptyBand(l,c),p=D.createEmptyBand(l,c);let f=0;for(let d=0;d<i;d++)for(let x=0;x<s;x++)e==="vector-uv"?([u[f],p[f]]=wt([a[f],h[f]],n),u[f]*=o):([u[f],p[f]]=be([a[f],h[f]],n),u[f]*=o,p[f]*=o),f++;const m=new D({pixelType:l,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[u,p]});return m.updateStatistics(),m}function Ue(t,e,n=1){if(n===1||!N(t))return t;const o=t.clone(),{pixels:r,width:s,height:i}=o,c=r[0];r[1];let a=0;for(let h=0;h<i;h++)for(let l=0;l<s;l++)c[a]*=n,a++;return o.updateStatistics(),o}function Pe(t,e,n,o,r){if(r==null||!r.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/o),height:Math.round(n/o),resolution:t.width/e};const s=r.xmin,i=r.ymax,c=(t.xmax-t.xmin)/e*o,a=(t.ymax-t.ymin)/n*o,h=(c+a)/2;return t.xmin=s+Math.floor((t.xmin-s)/c)*c,t.xmax=s+Math.ceil((t.xmax-s)/c)*c,t.ymin=i+Math.floor((t.ymin-i)/a)*a,t.ymax=i+Math.ceil((t.ymax-i)/a)*a,{extent:t,width:Math.round(t.width/c),height:Math.round(t.height/a),resolution:h}}const Te=Ft(0,0,0);function Ft(t=0,e=0,n=Math.PI,o=!0){o&&(n=(2*Math.PI-n)%(2*Math.PI));const r=o?-1:1,s=13*r,i=-7*r,c=-2*r,a=-16*r,h=21.75,[l,u]=E(0,e+s,n,h),[p,f]=E(t-5.5,e+i,n,h),[m,d]=E(t+5.5,e+i,n,h),[x,y]=E(t-1.5,e+c,n,h),[k,M]=E(t+1.5,e+c,n,h),[w,g]=E(t-1.5,e+a,n,h),[b,U]=E(t+1.5,e+a,n,h);return[l,u,p,f,x,y,k,M,m,d,w,g,b,U]}function Ie(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const o=10,r=n?-1:1,s=5*r,i=20*r,c=25*r,a=45,h=0,l=0,u=2,p=0,f=u*r,m=n?1:-1,d=o/2*m;let[x,y]=[h+d,l-i],[k,M]=[x+u*m,y],[w,g]=[k-p*m,M+f],[b,U]=[h-d,l-c],[P,B]=[b+p*m,U-f],v=Math.ceil(t/xt),I=Math.floor(v/10);v-=8*I;const A=[],T=[];for(let X=0;X<v/2;X++,I--){I<=0&&v%2==1&&X===(v-1)/2&&(b=h,P=b+p*m,U=(U+y)/2,B=U-f);const[K,tt]=E(b,U,e,a);if(I>0){const[_,R]=E(k,U,e,a),[it,st]=E(x,y,e,a);A.push(_),A.push(R),A.push(K),A.push(tt),A.push(it),A.push(st)}else{const[_,R]=E(k,M,e,a),[it,st]=E(w,g,e,a),[Dt,Nt]=E(P,B,e,a);T.push(K),T.push(tt),T.push(Dt),T.push(Nt),T.push(it),T.push(st),T.push(_),T.push(R)}U+=s,y+=s,M+=s,g+=s,B+=s}const[C,S]=E(h+d,l+i,e,a),F=(o/2+u)*m,[L,V]=E(h+F,l+i,e,a),[G,j]=E(h+d,l-c,e,a),[$,H]=E(h+F,l-c,e,a);return{pennants:A,barbs:T,shaft:[C,S,L,V,G,j,$,H]}}function E(t,e,n,o=1){const r=Math.sqrt(t*t+e*e)/o,s=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[r,(2*Math.PI+s-n)%(2*Math.PI)]}const ht=[0,1,3,6,10,16,21,27,33,40,47,55,63],Be=[0,.5,1,1.5,2],Se=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function Z(t,e,n,o){const r=at(o||"knots",n);let s;for(s=1;s<e.length;s++)if(s===e.length-1){if(t<e[s]*r)break}else if(t<=e[s]*r)break;return Math.min(s-1,e.length-2)}function Fe(t,e,n,o,r){let s=0;switch(e){case"beaufort_kn":s=Z(t,ht,"knots",n);break;case"beaufort_km":s=Z(t,ht,"kilometer-per-hour",n);break;case"beaufort_ft":s=Z(t,ht,"feet-per-second",n);break;case"beaufort_m":s=Z(t,ht,"meter-per-second",n);break;case"classified_arrow":s=Z(t,r??[],o,n);break;case"ocean_current_m":s=Z(t,Be,"meter-per-second",n);break;case"ocean_current_kn":s=Z(t,Se,"knots",n)}return s}function Ce(t,e){const{style:n,inputUnit:o,outputUnit:r,breakValues:s}=e,i=ot.fromJSON(o),c=ot.fromJSON(r),a=7*6,h=15;let l=0,u=0;const{width:p,height:f,mask:m}=t,d=t.pixels[0],x=t.pixels[1],y=m!=null?m.filter(g=>g>0).length:p*f,k=new Float32Array(y*a),M=new Uint32Array(h*y),w=e.invertDirection?Ft(0,0,0,!1):Te;for(let g=0;g<f;g++)for(let b=0;b<p;b++){const U=g*p+b;if(!m||m[g*p+b]){const P=(x[U]+360)%360/180*Math.PI,B=Fe(d[U],n,i,c,s);for(let I=0;I<w.length;I+=2)k[l++]=(b+.5)/p,k[l++]=(g+.5)/f,k[l++]=w[I],k[l++]=w[I+1]+P,k[l++]=B,k[l++]=d[U];const v=7*(l/a-1);M[u++]=v,M[u++]=v+1,M[u++]=v+2,M[u++]=v+0,M[u++]=v+4,M[u++]=v+3,M[u++]=v+0,M[u++]=v+2,M[u++]=v+3,M[u++]=v+2,M[u++]=v+5,M[u++]=v+3,M[u++]=v+5,M[u++]=v+6,M[u++]=v+3}}return{vertexData:k,indexData:M}}const kt=[];function Ve(t,e){if(kt.length===0)for(let f=0;f<30;f++)kt.push(Ie(5*f,0,!e.invertDirection));const n=at(ot.fromJSON(e.inputUnit),"knots"),{width:o,height:r,mask:s}=t,i=t.pixels[0],c=t.pixels[1],a=6,h=[],l=[];let u=0,p=0;for(let f=0;f<r;f++)for(let m=0;m<o;m++){const d=f*o+m,x=i[d]*n;if((!s||s[f*o+m])&&x>=xt){const y=(c[d]+360)%360/180*Math.PI,{pennants:k,barbs:M,shaft:w}=kt[Math.min(Math.floor(x/5),29)];if(k.length+M.length===0)continue;let g=h.length/a;const b=(m+.5)/o,U=(f+.5)/r;for(let P=0;P<k.length;P+=2)h[u++]=b,h[u++]=U,h[u++]=k[P],h[u++]=k[P+1]+y,h[u++]=0,h[u++]=x;for(let P=0;P<M.length;P+=2)h[u++]=b,h[u++]=U,h[u++]=M[P],h[u++]=M[P+1]+y,h[u++]=0,h[u++]=x;for(let P=0;P<w.length;P+=2)h[u++]=b,h[u++]=U,h[u++]=w[P],h[u++]=w[P+1]+y,h[u++]=0,h[u++]=x;for(let P=0;P<k.length/6;P++)l[p++]=g,l[p++]=g+1,l[p++]=g+2,g+=3;for(let P=0;P<M.length/8;P++)l[p++]=g,l[p++]=g+1,l[p++]=g+2,l[p++]=g+1,l[p++]=g+2,l[p++]=g+3,g+=4;l[p++]=g+0,l[p++]=g+1,l[p++]=g+2,l[p++]=g+1,l[p++]=g+3,l[p++]=g+2,g+=4}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(l)}}function Ct(t,e){let n=0,o=0;const{width:r,height:s,mask:i}=t,c=t.pixels[0],a=[],h=[],l=at(ot.fromJSON(e.inputUnit),"knots"),u=e.style==="wind_speed"?xt:Number.MAX_VALUE;for(let p=0;p<s;p++)for(let f=0;f<r;f++){const m=c[p*r+f]*l;if((!i||i[p*r+f])&&m<u){for(let x=0;x<4;x++)a[n++]=(f+.5)/r,a[n++]=(p+.5)/s,a[n++]=x<2?-.5:.5,a[n++]=x%2==0?-.5:.5,a[n++]=0,a[n++]=m;const d=4*(n/24-1);h[o++]=d,h[o++]=d+1,h[o++]=d+2,h[o++]=d+1,h[o++]=d+2,h[o++]=d+3}}return{vertexData:new Float32Array(a),indexData:new Uint32Array(h)}}function _e(t,e){return e.style==="simple_scalar"?Ct(t,e):e.style==="wind_speed"?Ve(t,e):Ce(t,e)}function De(t,e,n,o=[0,0],r=.5){const{width:s,height:i,mask:c}=t,[a,h]=t.pixels,[l,u]=o,p=Math.round((s-l)/n),f=Math.round((i-u)/n),m=p*f,d=new Float32Array(m),x=new Float32Array(m),y=new Uint8Array(m);for(let M=0;M<f;M++)for(let w=0;w<p;w++){let g=0;const b=M*p+w,U=Math.max(0,M*n+u),P=Math.max(0,w*n+l),B=Math.min(i,U+n),v=Math.min(s,P+n);for(let I=U;I<B;I++)for(let A=P;A<v;A++){const T=I*s+A;if(!c||c[T]){g++;const C=[a[T],h[T]],[S,F]=C;d[b]+=S,x[b]+=F}}if(g>=(B-U)*(v-P)*(1-r)){y[b]=1;const[I,A]=wt([d[b]/g,x[b]/g]);d[b]=I,x[b]=A}else y[b]=0,d[b]=0,x[b]=0}const k=new D({width:p,height:f,pixels:[d,x],mask:y});return k.updateStatistics(),k}const z=()=>Y.getLogger("esri.views.2d.engine.flow.dataUtils"),Ne=10;async function Re(t,e,n,o){const r=performance.now(),s=Le(e,n),i=performance.now(),c=Ge(e,s,n.width,n.height),a=performance.now(),h=We(c),l=performance.now(),u=t==="Streamlines"?je(h,Ne):qe(h),p=performance.now();return et("esri-2d-profiler")&&(z().info("I.1","_createFlowFieldFromData (ms)",Math.round(i-r)),z().info("I.2","_getStreamlines (ms)",Math.round(a-i)),z().info("I.3","createAnimatedLinesData (ms)",Math.round(l-a)),z().info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(p-l)),z().info("I.5","createFlowMesh (ms)",Math.round(p-r)),z().info("I.6","Mesh size (bytes)",u.vertexData.buffer.byteLength+u.indexData.buffer.byteLength)),await Promise.resolve(),jt(o),u}function Le(t,e){const n=Oe(e.data,e.width,e.height,t.smoothing);return t.interpolate?(o,r)=>{const s=Math.floor(o),i=Math.floor(r);if(s<0||s>=e.width)return[0,0];if(i<0||i>=e.height)return[0,0];const c=o-s,a=r-i,h=s,l=i,u=s<e.width-1?s+1:s,p=i<e.height-1?i+1:i,f=n[2*(l*e.width+h)],m=n[2*(l*e.width+u)],d=n[2*(p*e.width+h)],x=n[2*(p*e.width+u)],y=n[2*(l*e.width+h)+1],k=n[2*(l*e.width+u)+1];return[(f*(1-a)+d*a)*(1-c)+(m*(1-a)+x*a)*c,(y*(1-a)+n[2*(p*e.width+h)+1]*a)*(1-c)+(k*(1-a)+n[2*(p*e.width+u)+1]*a)*c]}:(o,r)=>{const s=Math.round(o),i=Math.round(r);return s<0||s>=e.width||i<0||i>=e.height?[0,0]:[n[2*(i*e.width+s)],n[2*(i*e.width+s)+1]]}}function Ee(t,e,n,o,r,s,i,c,a){const h=[];let l=n,u=o,p=0,[f,m]=e(l,u);f*=t.velocityScale,m*=t.velocityScale;const d=Math.sqrt(f*f+m*m);let x,y;h.push({x:l,y:u,t:p,speed:d});for(let k=0;k<t.verticesPerLine;k++){let[M,w]=e(l,u);M*=t.velocityScale,w*=t.velocityScale;const g=Math.sqrt(M*M+w*w);if(g<t.minSpeedThreshold)return h;const b=M/g,U=w/g;if(l+=b*t.segmentLength,u+=U*t.segmentLength,p+=t.segmentLength/g,Math.acos(b*x+U*y)>t.maxTurnAngle)return h;if(t.collisions){const P=Math.round(l*a),B=Math.round(u*a);if(P<0||P>i-1||B<0||B>c-1)return h;const v=s[B*i+P];if(v!==-1&&v!==r)return h;s[B*i+P]=r}h.push({x:l,y:u,t:p,speed:g}),x=b,y=U}return h}function Ge(t,e,n,o){const r=[],s=new Mt,i=1/Math.max(t.lineCollisionWidth,1),c=Math.round(n*i),a=Math.round(o*i),h=new Int32Array(c*a);for(let u=0;u<h.length;u++)h[u]=-1;const l=[];for(let u=0;u<o;u+=t.lineSpacing)for(let p=0;p<n;p+=t.lineSpacing)l.push({x:p,y:u,sort:s.getFloat()});l.sort((u,p)=>u.sort-p.sort);for(const{x:u,y:p}of l)if(s.getFloat()<t.density){const f=Ee(t,e,u,p,r.length,h,c,a,i);if(f.length<2)continue;r.push(f)}return r}function Oe(t,e,n,o){if(o===0)return t;const r=Math.round(3*o),s=new Array(2*r+1);let i=0;for(let h=-r;h<=r;h++){const l=Math.exp(-h*h/(o*o));s[h+r]=l,i+=l}for(let h=-r;h<=r;h++)s[h+r]/=i;const c=new Float32Array(t.length);for(let h=0;h<n;h++)for(let l=0;l<e;l++){let u=0,p=0;for(let f=-r;f<=r;f++){if(l+f<0||l+f>=e)continue;const m=s[f+r];u+=m*t[2*(h*e+(l+f))],p+=m*t[2*(h*e+(l+f))+1]}c[2*(h*e+l)]=u,c[2*(h*e+l)+1]=p}const a=new Float32Array(t.length);for(let h=0;h<e;h++)for(let l=0;l<n;l++){let u=0,p=0;for(let f=-r;f<=r;f++){if(l+f<0||l+f>=n)continue;const m=s[f+r];u+=m*c[2*((l+f)*e+h)],p+=m*c[2*((l+f)*e+h)+1]}a[2*(l*e+h)]=u,a[2*(l*e+h)+1]=p}return a}function We(t,e){const n=new Mt,o=t.reduce((a,h)=>a+h.length,0),r=new Float32Array(4*o),s=new Array(t.length);let i=0,c=0;for(const a of t){const h=i;for(const l of a)r[4*i]=l.x,r[4*i+1]=l.y,r[4*i+2]=l.t,r[4*i+3]=l.speed,i++;s[c++]={startVertex:h,numberOfVertices:a.length,totalTime:a[a.length-1].t,timeSeed:n.getFloat()}}return{lineVertices:r,lineDescriptors:s}}function je(t,e){const{lineVertices:n,lineDescriptors:o}=t;let r=0,s=0;for(const p of o)r+=2*p.numberOfVertices,s+=6*(p.numberOfVertices-1);const i=new Float32Array(r*9),c=new Uint32Array(s);let a=0,h=0;function l(){c[h++]=a-2,c[h++]=a,c[h++]=a-1,c[h++]=a,c[h++]=a+1,c[h++]=a-1}function u(p,f,m,d,x,y,k,M){const w=a*9;let g=0;i[w+g++]=p,i[w+g++]=f,i[w+g++]=1,i[w+g++]=m,i[w+g++]=y,i[w+g++]=k,i[w+g++]=d/2,i[w+g++]=x/2,i[w+g++]=M,a++,i[w+g++]=p,i[w+g++]=f,i[w+g++]=-1,i[w+g++]=m,i[w+g++]=y,i[w+g++]=k,i[w+g++]=-d/2,i[w+g++]=-x/2,i[w+g++]=M,a++}for(const p of o){const{totalTime:f,timeSeed:m}=p;let d=null,x=null,y=null,k=null,M=null,w=null;for(let g=0;g<p.numberOfVertices;g++){const b=n[4*(p.startVertex+g)],U=n[4*(p.startVertex+g)+1],P=n[4*(p.startVertex+g)+2],B=n[4*(p.startVertex+g)+3];let v=null,I=null,A=null,T=null;if(g>0){v=b-d,I=U-x;const C=Math.sqrt(v*v+I*I);if(v/=C,I/=C,g>1){let S=v+M,F=I+w;const L=Math.sqrt(S*S+F*F);S/=L,F/=L;const V=Math.min(1/(S*v+F*I),e);S*=V,F*=V,A=-F,T=S}else A=-I,T=v;A!==null&&T!==null&&(u(d,x,y,A,T,f,m,B),l())}d=b,x=U,y=P,M=v,w=I,k=B}u(d,x,y,-w,M,f,m,k)}return{vertexData:i,indexData:c}}function qe(t){const{lineVertices:e,lineDescriptors:n}=t;let o=0,r=0;for(const A of n){const T=A.numberOfVertices-1;o+=4*T*2,r+=6*T*2}const s=new Float32Array(o*16),i=new Uint32Array(r);let c,a,h,l,u,p,f,m,d,x,y,k,M,w,g=0,b=0;function U(){i[b++]=g-8,i[b++]=g-7,i[b++]=g-6,i[b++]=g-7,i[b++]=g-5,i[b++]=g-6,i[b++]=g-4,i[b++]=g-3,i[b++]=g-2,i[b++]=g-3,i[b++]=g-1,i[b++]=g-2}function P(A,T,C,S,F,L,V,G,j,$,H,X,K,tt){const _=g*16;let R=0;for(const it of[1,2])for(const st of[1,2,3,4])s[_+R++]=A,s[_+R++]=T,s[_+R++]=C,s[_+R++]=S,s[_+R++]=V,s[_+R++]=G,s[_+R++]=j,s[_+R++]=$,s[_+R++]=it,s[_+R++]=st,s[_+R++]=K,s[_+R++]=tt,s[_+R++]=F/2,s[_+R++]=L/2,s[_+R++]=H/2,s[_+R++]=X/2,g++}function B(A,T){let C=d+y,S=x+k;const F=Math.sqrt(C*C+S*S);C/=F,S/=F;const L=d*C+x*S;C/=L,S/=L;let V=y+M,G=k+w;const j=Math.sqrt(V*V+G*G);V/=j,G/=j;const $=y*V+k*G;V/=$,G/=$,P(c,a,h,l,-S,C,u,p,f,m,-G,V,A,T),U()}function v(A,T,C,S,F,L){if(d=y,x=k,y=M,k=w,d==null&&x==null&&(d=y,x=k),u!=null&&p!=null){M=A-u,w=T-p;const V=Math.sqrt(M*M+w*w);M/=V,w/=V}d!=null&&x!=null&&B(F,L),c=u,a=p,h=f,l=m,u=A,p=T,f=C,m=S}function I(A,T){d=y,x=k,y=M,k=w,d==null&&x==null&&(d=y,x=k),d!=null&&x!=null&&B(A,T)}for(const A of n){c=null,a=null,h=null,l=null,u=null,p=null,f=null,m=null,d=null,x=null,y=null,k=null,M=null,w=null;const{totalTime:T,timeSeed:C}=A;for(let S=0;S<A.numberOfVertices;S++)v(e[4*(A.startVertex+S)],e[4*(A.startVertex+S)+1],e[4*(A.startVertex+S)+2],e[4*(A.startVertex+S)+3],T,C);I(T,C)}return{vertexData:s,indexData:i}}function Vt(t,e){const n=e.pixels,{width:o,height:r}=e,s=new Float32Array(o*r*2),i=e.mask||new Uint8Array(o*r*2);if(e.mask||i.fill(255),t==="vector-uv")for(let c=0;c<o*r;c++)s[2*c]=n[0][c],s[2*c+1]=-n[1][c];else if(t==="vector-magdir")for(let c=0;c<o*r;c++){const a=n[0][c],h=zt(n[1][c]),l=Math.cos(h-Math.PI/2),u=Math.sin(h-Math.PI/2);s[2*c]=l*a,s[2*c+1]=u*a}return{data:s,mask:i,width:o,height:r}}async function $e(t,e,n,o,r,s){const i=performance.now(),c=qt(e.spatialReference);if(!c){const w=await _t(t,e,n,o,r,s);return et("esri-2d-profiler")&&z().info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-i)),et("esri-2d-profiler")&&z().info("I.9","Number of parts",1),w}const[a,h]=c.valid,l=h-a,u=Math.ceil(e.width/l),p=e.width/u,f=Math.round(n/u);let m=e.xmin;const d=[],x=performance.now();for(let w=0;w<u;w++){const g=new $t({xmin:m,xmax:m+p,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});d.push(_t(t,g,f,o,r,s)),m+=p}const y=await Promise.all(d);et("esri-2d-profiler")&&z().info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-x)),et("esri-2d-profiler")&&z().info("I.9","Number of parts",y.length);const k={data:new Float32Array(n*o*2),mask:new Uint8Array(n*o),width:n,height:o};let M=0;for(const w of y){for(let g=0;g<w.height;g++)for(let b=0;b<w.width;b++)M+b>=n||(k.data[2*(g*n+M+b)]=w.data[2*(g*w.width+b)],k.data[2*(g*n+M+b)+1]=w.data[2*(g*w.width+b)+1],k.mask[g*n+M+b]=w.mask[g*w.width+b]);M+=w.width}return et("esri-2d-profiler")&&z().info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-i)),k}async function _t(t,e,n,o,r,s){const i={requestProjectedLocalDirections:!0,signal:s};if(r!=null&&(i.timeExtent=r),t.type==="imagery"){await t.load({signal:s});const h=t.rasterInfo.dataType,l=await t.fetchImage(e,n,o,i);return l?.pixelData?.pixelBlock==null?{data:new Float32Array(n*o*2),mask:new Uint8Array(n*o),width:n,height:o}:Vt(h,l.pixelData.pixelBlock)}await t.load({signal:s});const c=t.serviceRasterInfo.dataType,a=await t.fetchPixels(e,n,o,i);return a?.pixelBlock==null?{data:new Float32Array(n*o*2),mask:new Uint8Array(n*o),width:n,height:o}:Vt(c,a.pixelBlock)}export{pe as A,se as B,ue as C,Ae as D,ke as E,fe as F,pt as G,ce as H,me as M,mt as P,Me as R,De as S,xe as T,Pt as U,ye as W,Ct as _,ne as a,Kt as b,$e as c,_e as d,ot as e,yt as f,D as g,at as h,ct as i,nt as j,re as k,wt as l,Pe as m,he as n,N as o,Ue as p,ae as q,oe as r,Re as s,Qt as t,ve as u,Yt as v,At as w,le as x,ft as y,ut as z};
