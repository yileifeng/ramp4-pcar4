{"version":3,"file":"WFSSourceWorker-CQFpdzMK.js","sources":["../../node_modules/@arcgis/core/layers/graphics/sources/WFSSourceWorker.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.32/esri/copyright.txt for details.\n*/\nimport{createTask as e}from\"../../../core/asyncUtils.js\";import t from\"../../../core/Error.js\";import r from\"../../../core/Logger.js\";import{throwIfAborted as a,isAbortError as s}from\"../../../core/promiseUtils.js\";import o from\"../../../core/Warning.js\";import{equals as n}from\"../../../geometry/support/spatialReferenceUtils.js\";import{convertFromGeometry as i,convertToGeometry as u}from\"../featureConversionUtils.js\";import{executeQueryForSnapping as l}from\"../data/executeQueryForSnapping.js\";import h from\"../data/FeatureStore.js\";import{checkProjectionSupport as c,project as m}from\"../data/projectionSupport.js\";import{QueryEngine as p}from\"../data/QueryEngine.js\";import{validateGeoJSON as g,createOptimizedFeatures as d}from\"./geojson/geojson.js\";import{mixAttributes as f}from\"./support/sourceUtils.js\";import{getGetFeatureSpatialReference as y,getFeatureCount as _,getFeature as x}from\"../../ogc/wfsUtils.js\";import w from\"../../support/FieldsIndex.js\";import{isNumber as C}from\"../../../support/guards.js\";import{utc as R}from\"../../../time/constants.js\";const F=\"esri.layers.WFSLayer\";class S{constructor(){this._customParameters=null,this._queryEngine=null,this._supportsPagination=!0}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,r={}){const{getFeatureUrl:s,getFeatureOutputFormat:o,fields:n,geometryType:i,featureType:u,maxRecordCount:l,maxTotalRecordCount:m,maxPageCount:g,objectIdField:d,customParameters:f}=e,{spatialReference:_,getFeatureSpatialReference:x}=y(s,u,e.spatialReference);try{await c(x,_)}catch{throw new t(\"unsupported-projection\",\"Projection not supported\",{inSpatialReference:x,outSpatialReference:_})}a(r),this._customParameters=f,this._featureType=u,this._fieldsIndex=w.fromLayerJSON({fields:n,dateFieldsTimeReference:n.some((e=>\"esriFieldTypeDate\"===e.type))?{timeZoneIANA:R}:null}),this._geometryType=i,this._getFeatureUrl=s,this._getFeatureOutputFormat=o,this._getFeatureSpatialReference=x,this._maxRecordCount=l,this._maxTotalRecordCount=m,this._maxPageCount=g,this._objectIdField=d,this._spatialReference=_;let C=await this._snapshotFeatures(r);if(C.errors.length>0&&(this._supportsPagination=!1,C=await this._snapshotFeatures(r),C.errors.length>0))throw C.errors[0];return this._queryEngine=new p({fieldsIndex:this._fieldsIndex,geometryType:i,hasM:!1,hasZ:!1,objectIdField:d,spatialReference:_,timeInfo:null,featureStore:new h({geometryType:i,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(C.features),{warnings:E(C),extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new t(\"wfs-source:editing-not-supported\",\"applyEdits() is not supported on WFSLayer\")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){await this._waitSnapshotComplete();return(await this._queryEngine.executeQueryForIds(e,t.signal)).filter(C)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),l(this._queryEngine,e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(t){return this._customParameters=t.customParameters,this._maxRecordCount=t.maxRecordCount,this._maxTotalRecordCount=t.maxTotalRecordCount,this._maxPageCount=t.maxPageCount,this._snapshotTask?.abort(),this._snapshotTask=e((e=>this._snapshotFeatures({signal:e}))),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),this._queryEngine.featureStore.addMany(e.features);for(const t of E(e))r.getLogger(F).warn(new o(\"wfs-layer:refresh-warning\",t.message,t.details));e.errors?.length&&r.getLogger(F).warn(new o(\"wfs-layer:refresh-error\",\"Refresh completed with errors\",{errors:e.errors}))}),(()=>{this._queryEngine.featureStore.clear()})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures(e){const t=e?.signal,r=this._maxTotalRecordCount,o=this._maxPageCount,n=this._supportsPagination?await _(this._getFeatureUrl,this._featureType.typeName,{customParameters:this._customParameters,signal:t}):void 0;let i=[];const u=[];if(null==n)try{i=await this._singleQuery(t)}catch(l){s(l)||u.push(l)}else{const e=Math.min(n,r),a=T(this,Math.max(1,Math.min(Math.ceil(e/this._maxRecordCount),o)),t);await Promise.allSettled(Array.from({length:10}).map((()=>j(a,i,u))))}return a(t),{features:i,totalRecordCount:n,maxTotalRecordCount:r,maxPageCount:o,errors:u}}async _singleQuery(e){const t=await x(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,signal:e});return this._processGeoJSON(t,{signal:e})}async _pageQuery(e,t){const r=e*this._maxRecordCount,a=await x(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,startIndex:r,count:this._maxRecordCount,signal:t});return this._processGeoJSON(a,{startIndex:r,signal:t})}_processGeoJSON(e,t){g(e,this._getFeatureSpatialReference.wkid);const{startIndex:r,signal:s}=t;a(s);const o=d(e,{geometryType:this._geometryType,hasZ:!1,objectIdField:this._objectIdField});if(!n(this._spatialReference,this._getFeatureSpatialReference))for(const a of o)null!=a.geometry&&(a.geometry=i(m(u(a.geometry,this._geometryType,!1,!1),this._getFeatureSpatialReference,this._spatialReference)));let l=r??1;for(const a of o){const e={};f(this._fieldsIndex,e,a.attributes,!0),a.attributes=e,null==e[this._objectIdField]&&(a.objectId=e[this._objectIdField]=l++)}return o}}function*T(e,t,r){for(let a=0;a<t;a++)yield e._pageQuery(a,r)}async function j(e,t,r){let a=e.next();for(;!a.done;){try{const e=await a.value;t.push(...e)}catch(o){s(o)||r.push(o)}a=e.next()}}function E(e){const t=[];return null!=e.totalRecordCount&&(e.features.length<e.totalRecordCount&&t.push({name:\"wfs-layer:maxRecordCount-too-low\",message:`Could only fetch ${e.features.length} of ${e.totalRecordCount} in ${e.maxPageCount} queries. Try increasing the value of WFSLayer.maxRecordCount.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount}}),e.totalRecordCount>e.maxTotalRecordCount&&t.push({name:\"wfs-layer:large-dataset\",message:`The number of ${e.totalRecordCount} features exceeds the maximum allowed of ${e.maxTotalRecordCount}.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount,maxTotalRecordCount:e.maxTotalRecordCount}})),t}export{S as default};\n"],"names":["F","S","e","r","s","n","i","u","l","m","g","f","_","x","y","c","t","a","w","R","C","p","h","E","o","T","j","d"],"mappings":"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","x_google_ignoreList":[0]}