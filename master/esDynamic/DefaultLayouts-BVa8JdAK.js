import{c1 as We,kO as Bt,iB as ni,fP as we,x as c,bi as Ce,z as w,K as q,G as be,aI as Te,aP as jt,ad as Ue,eU as oi,cC as lt,aM as se,df as ht,fp as Ve,n as li,aY as hi,iM as ci,cS as ui,a9 as di,b_ as gi,dm as kt,aO as pi,kP as _i,gA as Oe,jn as ct,fe as fi,fC as Yt,gm as mi,fA as Qt}from"./main-BC8gbEPx.js";import{b as Xt,i as $t,c as ut,h as vi,X as xi,Q as yi,q as wi,n as Ci}from"./mat4-BDUaQr32.js";import{o as ee,e as H}from"./mat4f64-BaJwL7tQ.js";import{j as bi,A as Ti,g as Oi,s as G,r as Si,c as Ri,H as Ii,y as Pi,E as Zt,o as Jt}from"./vec32-CKLwdlap.js";import{E as Di,U as Ei,C as Ai}from"./sphere-BQalhKXp.js";import{m as Fi}from"./plane-DnaQmUZU.js";import{s as Kt,n as dt,N as Mi}from"./vec4f64-CjUMzAyX.js";import{s as ae,u as Li,c as ne,f as ze,H as Se}from"./InterleavedLayout-BbMawCR1.js";import{n as P,u as er,l as gt,S as tr,e as Ni}from"./ShaderOutput-C_OqLoo1.js";import{au as U,Z as rr,q as ir,g as pt,ay as Hi,az as Wi,j as sr,ad as ar,aT as nr,ap as Re,am as _t,C as V,aH as Ui,al as or,ae as qe,e as Ge,aB as Vi,aU as ft,F as B,G as j,ao as lr,as as zi,at as mt,aV as qi,O as E,E as Be,aW as vt,Y as je,aX as Gi,aY as Bi,aZ as ji,I as A,a_ as ki,a$ as Yi,P as xt,M as Qi,aR as Xi,a as $i,ag as Zi,aF as Ji,u as Ki,v as es,ai as ts,aG as rs,r as is,z as ss,x as as,aJ as ns,aK as os,aL as ls,H as hs,aM as cs,aN as us,aO as ds,aP as gs,J as ps,K as _s,L as fs,aQ as ms,B as vs,aS as xs,b0 as ys,b1 as ws,f as Cs,l as bs,n as Ts}from"./Geometry-6d2Fi3Pn.js";import{a as Ie,e as yt}from"./basicInterfaces-Dsf65ICa.js";import{e as x}from"./VertexAttribute-DFC3a3eR.js";import{n as C}from"./glsl-o28TenZV.js";import{i as k}from"./ShaderBuilder-Ds5biX5E.js";import{C as Pe,G as Os,L as hr,_ as te,F as cr,E as Ss,M as ur,f as Rs}from"./enums-DBi1-Mm2.js";import{B as Y,c as wt,g as Q,f as Is}from"./renderState-eEtyJpmy.js";import{o as W,u as re,l as oe,_ as De,b as dr,e as le,j as O,x as Ps,v as gr,r as Ds,G as Es}from"./vec2-BnynUbeJ.js";import{n as y}from"./vec2f64-CEUyUoff.js";import{h as As,o as Fs}from"./projectBuffer-CI8y-xLT.js";import{w as Ms}from"./Indices-Docepraz.js";import{l as pr}from"./ViewingMode-CyR_b1T8.js";import{t as X}from"./orientedBoundingBox-Cx1yARP6.js";import{p as ke,a as _r}from"./triangulationUtils-DIgcI7lw.js";import{t as Ls,_ as Ns,a as Hs,e as Ye,C as Ws,b as fr,u as Us}from"./RibbonLine.glsl-DUbnmbJ8.js";import{r as Vs,i as Qe,u as zs}from"./HUDMaterial-JZfd5xsg.js";import{a as mr}from"./BindType-CKbZk6AG.js";import{r as Ct}from"./signal-UgirE0-u.js";import{j as qs,v as vr,w as xr}from"./axisAngleDegrees-CbonGdf-.js";import{w as Gs}from"./HighlightDefaults-OPxBBZpm.js";import{t as Xe}from"./VertexElementDescriptor-BAy1DPb3.js";import{E as yr}from"./VertexArrayObject-Bo1SXp0_.js";import{p as wr,w as he}from"./Texture-CgORJFQB.js";import{t as Bs}from"./NestedMap-Ddo7BfvO.js";import{b as js}from"./dehydratedFeatureUtils-DGoW5D8R.js";import{e as ks}from"./mat3f64-Dh9_zhFu.js";import{s as Cr,z as Ys}from"./vec42-D8CJyqHG.js";import{g as Qs,C as Xs}from"./Scheduler-D6n_mU38.js";var bt,Tt;(function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"})(bt||(bt={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(Tt||(Tt={}));var $,br,Tr;(function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"})($||($={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(br||(br={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(Tr||(Tr={}));let Or=class{constructor(){this._extent=We(),this.resolution=0,this.renderLocalOrigin=Ls(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new $s}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryView();const t=.001*e.range;if(this._extent[0]-t<=e.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Bt(this._extent,e.range,0,r)}if(this._extent[2]+t>=e.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Bt(this._extent,-e.range,0,r)}}setupGeometryView(){this.canvasGeometries.numViews=1,ni(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},$s=class{constructor(){this.extents=[We(),We(),We()],this.numViews=0}};var b;(function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(b||(b={}));let Zs=class{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=we(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,t,r){this._handle&&this._handle.fbo?.width===t&&this._handle.fbo?.height===r||(this._handle?.release(),this._handle=this._fbos.acquire(t,r,this._name,this._format)),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},ce=class{constructor(e,t,r,i,s=U.RGBA_MIPMAP){this.output=r,this.content=i,this.fbo=new Zs(e,s,t)}get valid(){return this.fbo.valid}},Js=class{constructor(e){this.targets=[new ce(e,"overlay color",P.Color,b.Color),new ce(e,"overlay IM color",P.Color,b.ColorNoRasterImage),new ce(e,"overlay highlight",P.Highlight,b.Highlight,U.RG),new ce(e,"overlay water",P.Normal,b.WaterNormal),new ce(e,"overlay occluded",P.Color,b.Occluded)],rr()&&this.targets.push(new ce(e,"overlay olid",P.ObjectAndLayerIdColor,b.ObjectAndLayerIdColor,U.RGBA))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,r)=>t.valid?e|=1<<r:e,0)}};var Sr;(function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight",e[e.ViewshedShadowMap=3]="ViewshedShadowMap"})(Sr||(Sr={}));var Z,$e;function Ks(e){return e!=null&&!e.running}(function(e){e[e.Idle=0]="Idle",e[e.Rendering=1]="Rendering",e[e.Ready=2]="Ready",e[e.Fading=3]="Fading"})(Z||(Z={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA",e[e.COUNT=2]="COUNT"}($e||($e={}));var Ot;let Ze=Ot=class extends be{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new Ot({cloudCover:this.cloudCover})}};c([Ce({cloudy:"cloudy"}),w({json:{write:{isRequired:!0}}})],Ze.prototype,"type",void 0),c([w({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Ze.prototype,"cloudCover",void 0),Ze=Ot=c([q("esri.views.3d.environment.CloudyWeather")],Ze);var St;let Je=St=class extends be{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new St({fogStrength:this.fogStrength})}};c([Ce({foggy:"foggy"}),w({json:{write:{isRequired:!0}}})],Je.prototype,"type",void 0),c([w({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Je.prototype,"fogStrength",void 0),Je=St=c([q("esri.views.3d.environment.FoggyWeather")],Je);var Rt;let Ee=Rt=class extends be{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new Rt({cloudCover:this.cloudCover,precipitation:this.precipitation})}};c([Ce({rainy:"rainy"}),w({json:{write:{isRequired:!0}}})],Ee.prototype,"type",void 0),c([w({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Ee.prototype,"cloudCover",void 0),c([w({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Ee.prototype,"precipitation",void 0),Ee=Rt=c([q("esri.views.3d.environment.RainyWeather")],Ee);var It;let ue=It=class extends be{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new It({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};c([Ce({snowy:"snowy"}),w({json:{write:{isRequired:!0}}})],ue.prototype,"type",void 0),c([w({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ue.prototype,"cloudCover",void 0),c([w({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ue.prototype,"precipitation",void 0),c([w({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],ue.prototype,"snowCover",void 0),ue=It=c([q("esri.views.3d.environment.SnowyWeather")],ue);var Pt;let Ke=Pt=class extends be{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new Pt({cloudCover:this.cloudCover})}};c([Ce({sunny:"sunny"}),w({json:{write:{isRequired:!0}}})],Ke.prototype,"type",void 0),c([w({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Ke.prototype,"cloudCover",void 0),Ke=Pt=c([q("esri.views.3d.environment.SunnyWeather")],Ke);const Dt=1e4,ea=1e5;class ta{constructor(){this.startTime=0,this._data=Ct(null),this._readChannels=$e.RG,this.parallax=new Rr,this.parallaxNew=new Rr,this._anchorPoint=Te(),this._fadeState=Ct(f.HIDE),this._fadeFactor=Ct(1)}get data(){return this._data.value}set data(t){this._data.value=t}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case f.HIDE:return 0;case f.FADE_OUT:return 1-this.fadeFactor;case f.FADE_IN:return this.fadeFactor;case f.SHOW:case f.CROSS_FADE:return 1}}fade(t,r,i){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=i?jt((r-this.startTime)/(ia*i),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(t,r),this._updateParallax(t)}_evaluateState(t,r){const i=t.relativeElevation,s=this._updateAnchorPoint(t);(i>1.7*Dt||i<-1e4||s>Pr)&&this.opacity>0?this._startFade(f.HIDE,r):this.isFading||(i>Dt||i<-.35*Dt||s>sa*Pr?this.opacity>0&&this._startFade(f.FADE_OUT,r):Ks(this.data)&&(this.opacity===0?this._startFade(f.FADE_IN,r):this.data.state===Z.Ready&&(this.fadeState===f.SHOW?this._startFade(f.CROSS_FADE,r):this._startFade(f.SHOW,r))))}_updateParallax(t){const r=bi(t.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(r-Ue.radius*Ue.radius,0))/Math.sqrt(r),vr(Ir,this.parallax.anchorPoint,de),Xt(this.parallax.transform,ee,de[3],xr(de)),vr(Ir,this.parallaxNew.anchorPoint,de),Xt(this.parallaxNew.transform,ee,de[3],xr(de))}_updateAnchorPoint(t){return Ti(this._anchorPoint,t.eye),Oi(this._anchorPoint,this._anchorPoint,Ue.radius),this.fadeState===f.HIDE&&this.data?.state===Z.Ready?(G(this.parallax.anchorPoint,this._anchorPoint),0):Si(Ri(ra,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(t,r){switch(this._fadeState.value=t,this.startTime=r,t){case f.CROSS_FADE:this.requestFade(),this._switchReadChannels(),G(this.parallaxNew.anchorPoint,this._anchorPoint);break;case f.FADE_IN:this.requestFade(),this._switchReadChannels(),G(this.parallax.anchorPoint,this._anchorPoint),G(this.parallaxNew.anchorPoint,this._anchorPoint);break;case f.FADE_OUT:this.requestFade();break;case f.SHOW:this._switchReadChannels(),G(this.parallax.anchorPoint,this._anchorPoint),G(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case f.HIDE:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==Z.Ready&&(this.data.state=Z.Idle),this.fadeState){case f.CROSS_FADE:G(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=f.SHOW;break;case f.FADE_IN:this._fadeState.value=f.SHOW;break;case f.FADE_OUT:this._fadeState.value=f.HIDE;break;case f.SHOW:case f.HIDE:break;default:oi(this.fadeState)}}_switchReadChannels(){this.data?.state===Z.Ready&&(this._readChannels=1-this._readChannels,this.data.state=Z.Fading)}get isFading(){return this.fadeState===f.FADE_OUT||this.fadeState===f.FADE_IN||this.fadeState===f.CROSS_FADE}}var f;(function(e){e[e.HIDE=0]="HIDE",e[e.FADE_IN=1]="FADE_IN",e[e.SHOW=2]="SHOW",e[e.CROSS_FADE=3]="CROSS_FADE",e[e.FADE_OUT=4]="FADE_OUT"})(f||(f={}));let Rr=class{constructor(){this.anchorPoint=Te(),this.radiusCurvatureCorrection=0,this.transform=H()}};const Ir=lt(0,0,1),de=qs(),ra=Te(),ia=1.25,sa=.5,Pr=2e5;let aa=class extends ir{constructor(e,t){super(e,"samplerCube",mr.Bind,(r,i)=>r.bindTexture(e,t(i)))}};function na(e){const t=e.fragment;t.constants.add("radiusCloudsSquared","float",oa).code.add(C`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),t.uniforms.add(new pt("radiusCurvatureCorrection",({clouds:i})=>i.parallax.radiusCurvatureCorrection)).code.add(C`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),t.code.add(C`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),Hi(t),Wi(t);const r=lt(.28,.175,.035);t.constants.add("RIM_COLOR","vec3",r),t.code.add(C`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${C.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${C.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${C.float(.2)} * pow(dirDotLight, ${C.float(10)}) * (1. - pow(sunsetTransition, ${C.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),t.uniforms.add(new sr("readChannelsRG",i=>i.clouds.readChannels===$e.RG),new aa("cubeMap",i=>i.clouds.data?.cubeMap?.colorTexture??null)).code.add(C`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = texture(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),t.uniforms.add(new ar("anchorPoint",i=>i.clouds.parallax.anchorPoint),new ar("anchorPointNew",i=>i.clouds.parallaxNew.anchorPoint),new nr("rotationClouds",i=>i.clouds.parallax.transform),new nr("rotationCloudsNew",i=>i.clouds.parallaxNew.transform),new pt("cloudsOpacity",i=>i.clouds.opacity),new pt("fadeFactor",i=>i.clouds.fadeFactor),new sr("crossFade",i=>i.clouds.fadeState===f.CROSS_FADE)).code.add(C`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)}const oa=(Ue.radius+ea)**2;var ge;(function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"})(ge||(ge={}));let Et=class extends Re{constructor(){super(...arguments),this.color=lt(1,1,1)}};function Dr(){const e=new k;return e.include(_t),e.fragment.uniforms.add(new V("tex",t=>t.texture),new Ui("uColor",t=>t.color)),e.fragment.main.add(C`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const la=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:Et,build:Dr},Symbol.toStringTag,{value:"Module"}));let Er=class extends ir{constructor(e,t){super(e,"ivec2",mr.Pass,(r,i,s)=>r.setUniform2iv(e,t(i,s)))}};class At extends Re{}function Ar(){const e=new k,{outputs:t,fragment:r}=e;return e.include(_t),r.uniforms.add(new or("textureInput",i=>i.input)),r.constants.add("outlineWidth","int",Math.ceil(Ae)),r.constants.add("cellSize","int",J),t.add("fragGrid","vec2"),r.main.add(C`ivec2 inputTextureSize = textureSize(textureInput, 0);
ivec2 cellBottomLeftCornerInput = ivec2(floor(gl_FragCoord.xy) * vec2(cellSize));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = uvec2( texelFetch(textureInput, coordMid, 0).rg * 255.0) & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
uvec2(texelFetch(textureInput,coord+ivec2(0,0),0).rg * 255.0) & uvec2(0x55u),
uvec2(texelFetch(textureInput,coord+ivec2(1,0),0).rg * 255.0) & uvec2(0x55u),
uvec2(texelFetch(textureInput,coord+ivec2(0,1),0).rg * 255.0) & uvec2(0x55u),
uvec2(texelFetch(textureInput,coord+ivec2(1,1),0).rg * 255.0) & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = vec2(outputValue) / 255.0;`),e}const J=32,Ae=9,Ft=.4,ha=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:At,blurSize:Ft,build:Ar,gridCellPixelSize:J,outlineSize:Ae},Symbol.toStringTag,{value:"Module"}));function et(e){const{vertex:t}=e;t.uniforms.add(new V("coverageTexture",r=>r.coverageTexture),new Er("highlightRenderCellCount",r=>W(Fr,r.horizontalCellCount,r.verticalCellCount)),new Er("highlightTextureResolution",({highlightTexture:r})=>W(Fr,r.descriptor.width,r.descriptor.height)),new qe("highlightLevel",r=>r.highlightLevel)).constants.add("cellSize","int",J),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add(C`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`).main.add(C`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = uvec2(texelFetch(coverageTexture, cellPos, 0).rg * 255.0);
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const Fr=y();function Mr(){const e=new k;e.include(et);const{fragment:t}=e;return t.uniforms.add(new V("highlightTexture",r=>r.highlightTexture),new V("highlightOptionsTexture",r=>r.highlightOptionsTexture),new Ge("pixelRatio",r=>r.pixelRatio),new Ge("occludedIntensityFactor",r=>r.occludedFactor),new Vi("maxHighlightLevel",r=>r.highlights.length-1)),t.constants.add("pixelSampleScale","float",1),e.include(ft),t.code.add(C`const float pascal17[9] = float[9](12870.0, 11440.0, 8008.0, 4368.0, 1820.0, 560.0, 120.0, 16.0, 1.0);
const float denom17 =  65536.0;
float colorWeight[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
float colorOcclusion[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
float weights[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
void applyTexel(vec2 texel, float weight) {
if (texel != vec2(0.0)){
int maxChannel = (maxHighlightLevel >> 2) & 1;
for (int channelIndex = 0; channelIndex <= maxChannel; ++channelIndex){
uint channel = readChannel(texel, channelIndex << 2);
int firstIndex = channelIndex << 2;
int maxIndex  = min(firstIndex + 3, maxHighlightLevel);
for (int highlightIndex = firstIndex; highlightIndex <= maxIndex; ++highlightIndex ) {
uint v = readChannelBits(channel, highlightIndex);
if ((v & 1u) == 1u){
colorWeight[highlightIndex] += weight;
if ((v & 2u) == 2u){
colorOcclusion[highlightIndex] += weight;
}
}
}
}
}
}
vec2 readTexel(ivec2 iuv, int du, int dv) {
return texelFetch(highlightTexture, iuv + ivec2(du, dv), 0).rg;
}
void readAndApplyTexel(ivec2 iuv, int du, int dv, float weight) {
vec2 texel = readTexel(iuv, du, dv);
applyTexel(texel, weight);
}
void readAndApply2TexelsU(ivec2 iuv, int du, int dv, float weight) {
readAndApplyTexel(iuv, -du, dv, weight);
readAndApplyTexel(iuv, +du, dv, weight);
}
float getWeight(int pixelDistance) {
float scaledDistance = float(pixelDistance) * pixelSampleScale / pixelRatio;
float d0f = floor(scaledDistance);
int d0 = int(d0f);
if (d0 >= 8){
return 0.0;
}
float w0 = pascal17[d0];
float w1 = pascal17[d0+1];
float f =  scaledDistance - d0f;
return mix(w0, w1, f);
}`),t.main.add(C`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
ivec2 iuv = ivec2(sUV * highlightTextureSize);
vec2 centerTexel = texelFetch(highlightTexture, iuv, 0).rg;
bool outlinePossible = false;
if (vOutlinePossible > 0.0){
for (int highlightLevel=0; highlightLevel<= maxHighlightLevel; ++highlightLevel) {
if ((readLevelBits(centerTexel,highlightLevel) & 1u) == 0u) {
outlinePossible = true;
break;
}
}
}
if (outlinePossible) {
int maxPixelDistance = clamp(int(8.0 * pixelRatio / pixelSampleScale), 2, 16);
float weightSum = 0.0;
for(int y = 0; y <= maxPixelDistance; ++y) {
float w = getWeight(y);
weights[y] = w;
weightSum += w * (y == 0 ? 1.0 : 2.0);
}
for(int y = 0; y <= maxPixelDistance; ++y) {
weights[y] = weights[y] / weightSum;
}
float weight0 = weights[0];
applyTexel(centerTexel, weight0 * weight0);
for(int y = 0; y <= maxPixelDistance; y += 1) {
float yFactor = weights[y];
if (y != 0) {
float xFactor = weight0;
float weight = xFactor * yFactor;
if (weight > 0.0) {
readAndApplyTexel(iuv, 0, +y, weight);
readAndApplyTexel(iuv, 0, -y, weight);
}
}
for(int x = 1; x <= maxPixelDistance; x += 1) {
float xFactor = weights[x];
float weight = xFactor * yFactor;
if (weight > 0.0) {
readAndApply2TexelsU(iuv, x, +y, weight);
if (y != 0){
readAndApply2TexelsU(iuv, x, -y, weight);
}
}
}
}
} else {
applyTexel(centerTexel, 1.0);
}
int frontColorIndex = 999;
int maxColorIndex = 0;
for (int i = 0; i <= maxHighlightLevel; ++i) {
if (colorWeight[i] > 0.0){
frontColorIndex = min(frontColorIndex, i);
maxColorIndex = max(maxColorIndex, i);
}
}
if (frontColorIndex == 999){
fragColor = vec4(0.0);
return;
}
vec4 accumulatedColor = vec4(0.0);
for (int curColorIndex = frontColorIndex; curColorIndex <= maxColorIndex; ++curColorIndex) {
float curColorWeight = colorWeight[curColorIndex];
if (curColorWeight <= 0.01){
continue;
}
uint vc = readLevelBits(centerTexel, curColorIndex);
bool centerFilled = (vc & 1u) == 1u;
bool centerOccluded = (vc & 3u) == 3u;
float curColorOcclusion = colorOcclusion[curColorIndex];
bool occluded = centerFilled ? centerOccluded : curColorOcclusion > 0.5 * curColorWeight;
int colorChannel = centerFilled ? 0 : 1;
vec4 colorBase = texelFetch(highlightOptionsTexture, ivec2(curColorIndex, colorChannel), 0);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, 0.03, curColorWeight);
float intensity = colorBase.a * occlusionFactor * outlineFactor;
vec3 currentColor = colorBase.rgb;
float a0 = accumulatedColor.a;
float a1 = intensity;
float alpha = clamp(a0 + a1 - a0 * a1, 0.0, 1.0);
if (alpha > 0.001){
vec3 blendedColor = ((1.0 - a1) * a0 * accumulatedColor.rgb + a1 * currentColor) / alpha;
accumulatedColor = vec4(blendedColor, alpha);
}
}
fragColor = accumulatedColor;`),e}const ca=Object.freeze(Object.defineProperty({__proto__:null,build:Mr},Symbol.toStringTag,{value:"Module"}));let Lr=class extends B{constructor(e,t){super(e,t,new j(ca,()=>import("./ImageMaterial.glsl-CkjjitKN.js").then(r=>r.H)))}initializePipeline(){return Y({blending:wt,colorWrite:Q})}},Nr=class extends B{constructor(e,t){super(e,t,new j(ha,()=>import("./ImageMaterial.glsl-CkjjitKN.js").then(r=>r.a)))}initializePipeline(){return Y({colorWrite:Q})}},ua=class extends Re{constructor(){super(...arguments),this.occludedFactor=Gs,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}};function Hr(){const e=new k;e.include(et),e.include(ft);const{fragment:t}=e;return e.outputs.add("fragSingleHighlight","vec2",0),t.uniforms.add(new V("highlightTexture",r=>r.highlightTexture),new qe("highlightLevel",r=>r.highlightLevel)),t.main.add(C`ivec2 iuv = ivec2(gl_FragCoord.xy);
vec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}const da=Object.freeze(Object.defineProperty({__proto__:null,build:Hr},Symbol.toStringTag,{value:"Module"}));let Wr=class extends B{constructor(e,t){super(e,t,new j(da,()=>import("./ImageMaterial.glsl-CkjjitKN.js").then(r=>r.b)))}initializePipeline(){return Y({colorWrite:Q})}};function Ur(){const e=new k;e.include(et);const{fragment:t}=e;return t.uniforms.add(new V("blurInput",r=>r.singleHighlightBlurTexture),new lr("blurSize",r=>r.blurSize),new V("highlightTexture",r=>r.highlightTexture),new V("highlightOptionsTexture",r=>r.highlightOptionsTexture),new qe("highlightLevel",r=>r.highlightLevel),new Ge("occludedIntensityFactor",r=>r.occludedFactor)),t.constants.add("inner","float",1-(Ae-Ft)/Ae),e.include(ft),t.main.add(C`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
vec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}const ga=Object.freeze(Object.defineProperty({__proto__:null,build:Ur},Symbol.toStringTag,{value:"Module"}));let Vr=class extends B{constructor(e,t){super(e,t,new j(ga,()=>import("./ImageMaterial.glsl-CkjjitKN.js").then(r=>r.S)))}initializePipeline(){return Y({blending:wt,colorWrite:Q})}},Mt=class extends Re{constructor(){super(...arguments),this.blurSize=y()}};function zr(){const e=new k;return e.include(et),e.outputs.add("fragSingleHighlight","vec2",0),e.fragment.uniforms.add(new lr("blurSize",t=>t.blurSize),new or("blurInput",t=>t.blurInput)).main.add(C`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragSingleHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragSingleHighlight = sum;
}`),e}const pa=Object.freeze(Object.defineProperty({__proto__:null,SingleHighlightBlurDrawParameters:Mt,build:zr},Symbol.toStringTag,{value:"Module"}));let qr=class extends B{constructor(e,t){super(e,t,new j(pa,()=>import("./ImageMaterial.glsl-CkjjitKN.js").then(r=>r.c)))}initializePipeline(){return Y({colorWrite:Q})}};const _a=[],fa=[new Xe(x.POSITION,3,Pe.FLOAT,0,12)];new Xe(x.POSITION,2,Pe.FLOAT,0,8),new Xe(x.POSITION,2,Pe.FLOAT,0,16),new Xe(x.UV0,2,Pe.FLOAT,8,16);let tt=class extends zi{constructor(){super(...arguments),this.produces=mt.HIGHLIGHTS,this.consumes={required:[mt.HIGHLIGHTS,"highlights"]},this._useMultipleHighlights=!1,this._downsampleDrawParameters=new At,this._passParameters=new ua,this._singleHighlightBlurDrawParameters=new Mt,this._grid=new ma}initialize(){this.addHandles([se(()=>this._updateOptionsTexture(),()=>{},ht)])}destroy(){this._grid.coverage=we(this._grid.coverage),this._grid.vao=Ve(this._grid.vao),this._passParameters.highlightOptionsTexture=we(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){const e=new wr(16,2);e.internalFormat=Os.RGBA,e.samplingMode=hr.NEAREST,this._passParameters.highlightOptionsTexture=new he(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(va(this.view.state.highlights)),this.requestRender(Ie.UPDATE)}precompile(){this.techniques.precompile(Nr),this._useMultipleHighlights?this.techniques.precompile(Lr):(this.techniques.precompile(Wr),this.techniques.precompile(qr),this.techniques.precompile(Vr))}render(e){const t=e.find(({name:m})=>m===mt.HIGHLIGHTS),{techniques:r,bindParameters:i,_passParameters:s,renderingContext:a}=this;if(!i.decorations)return t;const n=r.get(Nr);if(!n.compiled)return this.requestRender(Ie.UPDATE),t;const o=e.find(({name:m})=>m==="highlights").getTexture(),l=()=>{this._gridUpdateResources(o);const m=this._gridComputeCoverage(n,o,i),{horizontalCellCount:p,verticalCellCount:R}=m;return s.horizontalCellCount=p,s.verticalCellCount=R,s.coverageTexture=m.coverage?.getTexture(),m},d=m=>{const p=m.verticalCellCount*m.horizontalCellCount;a.bindVAO(m.vao),a.drawElementsInstanced(Ss.TRIANGLES,6,Pe.UNSIGNED_BYTE,0,p)},{camera:g}=i,_=()=>{a.bindFramebuffer(t.fbo),a.setViewport4fv(g.fullViewport)};return this._useMultipleHighlights?this._renderMultiple(o,l,d,_):this._renderSingle(o,l,d,_),s.highlightTexture=null,s.coverageTexture=null,t}_renderMultiple(e,t,r,i){const{techniques:s,bindParameters:a,_passParameters:n,renderingContext:o}=this,l=s.get(Lr);if(!l.compiled)return void this.requestRender(Ie.UPDATE);const d=t();n.highlightTexture=e,n.pixelRatio=a.camera.pixelRatio,o.bindTechnique(l,a,n),i(),r(d)}_renderSingle(e,t,r,i){const{fboCache:s,techniques:a,bindParameters:n,_passParameters:o,renderingContext:l}=this,d=a.get(Wr),g=a.get(qr),_=a.get(Vr);if(!_.compiled||!g.compiled||!d.compiled)return void this.requestRender(Ie.UPDATE);const m=t(),{width:p,height:R}=e.descriptor;o.highlightTexture=e;const{camera:me}=n,{fullWidth:ve,fullHeight:nt,pixelRatio:Le}=me,xe=Math.ceil(ve/Le),ye=Math.ceil(nt/Le),{_singleHighlightBlurDrawParameters:v}=this,I=this.view._stage.renderView.renderer,{highlights:Gt}=n;for(let Ne=0;Ne<Gt.length;++Ne){const{name:ai}=Gt[Ne];if(!I.hasHighlightOptions(ai))continue;o.highlightLevel=Ne,l.setClearColor(0,0,0,0);const ot=s.acquire(p,R,"single highlight",U.RG);l.bindFramebuffer(ot.fbo),l.setViewport(0,0,p,R),l.clear(te.COLOR),l.bindTechnique(d,n,o),r(m),v.blurInput=ot.getTexture(),W(v.blurSize,1/xe,0);const He=s.acquire(xe,ye,"single highlight blur h",U.RG);l.unbindTexture(He.fbo?.colorTexture),l.bindFramebuffer(He.fbo),l.setViewport(0,0,xe,ye),l.clear(te.COLOR),l.bindTechnique(g,n,o,v),r(m),ot.release(),W(v.blurSize,0,1/ye),o.singleHighlightBlurTexture=He.getTexture(),i(),l.bindTechnique(_,n,o,v),r(m),He.release()}}_gridUpdateResources(e){const t=this._grid,{width:r,height:i}=e.descriptor;if(t.horizontalCellCount=Math.ceil(r/J),t.verticalCellCount=Math.ceil(i/J),t.vao)return;const s=this.renderingContext,a=yr.createIndex(s,cr.STATIC_DRAW,wa);t.vao=new Vs(s,qi,new Map([["geometry",_a]]),new Map([["geometry",yr.createVertex(s,cr.STATIC_DRAW)]]),a)}_gridComputeCoverage(e,t,r){const i=this.renderingContext,s=this._grid,a=t.descriptor,n=Math.ceil(a.width/J),o=Math.ceil(a.height/J);this._downsampleDrawParameters.input=t,s.coverage?.release();const l=this.fboCache.acquire(n,o,"highlight coverage",U.RG);return s.coverage=l,i.bindFramebuffer(l.fbo),i.bindTechnique(e,r,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,n,o),i.screen.draw(),s}get test(){}};c([w()],tt.prototype,"produces",void 0),c([w()],tt.prototype,"consumes",void 0),tt=c([q("esri.views.3d.webgl-engine.effects.highlight.Highlight")],tt);class ma{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}function va(e){const t=new Uint8Array(128);let r=0;for(const i of e){const s=4*r,a=4*r+64;++r;const{color:n}=i,o=i.haloColor??n;t[s+0]=n.r,t[s+1]=n.g,t[s+2]=n.b,t[s+3]=i.fillOpacity*n.a*255,t[a+0]=o.r,t[a+1]=o.g,t[a+2]=o.b,t[a+3]=i.haloOpacity*o.a*255}return t}let xa=0;function ya(e){let t=0;for(const i of e){const{name:s}=i;t+=s.length;const{color:a,fillOpacity:n,haloColor:o,haloOpacity:l}=i;t+=a.r+a.g+a.b+a.a+n,t+=o?o.r+o.g+o.b+o.a+l:0}const r=e.at(0);if(r){const{shadowOpacity:i,shadowDifference:s,shadowColor:a}=r;t+=i+s+a.r+a.g+a.b+a.a}return xa+++(t>=0?0:1)}const wa=new Uint8Array([0,1,2,2,1,3]);function Ca(e,t,r,i,s,a=0){const n=i.highlights,o=n.length>1?t.acquire(r.width,r.height,"highlight mix",U.RG):null;if(o){const d=e.getBoundFramebufferObject();e.bindFramebuffer(o.fbo),e.clearFramebuffer(Kt),e.bindFramebuffer(d)}const l=o?.getTexture();i.highlightMixTexture=l,W(i.highlightMixOrigin,a,0),n.forEach((d,g)=>{g>0&&(e.bindTexture(l,he.TEXTURE_UNIT_FOR_UPDATES),e.gl.copyTexSubImage2D(ur.TEXTURE_2D,0,0,0,a,0,r.width,r.height),e.bindTexture(null,he.TEXTURE_UNIT_FOR_UPDATES)),e.clear(te.DEPTH),i.highlightLevel=g,s()}),i.highlightLevel=null,i.highlightMixTexture=null,o?.release()}let ba=class{constructor(e,t,r,i){this._textures=e,this._techniques=t,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new Bs}dispose(){this._textures.destroy()}acquire(e,t,r){if(this._ownMaterial(e),!e.produces.get(t)?.(r))return null;let i=this._id2glMaterialRef.get(r,e.id);if(i==null){const s=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:r});i=new Ta(s),this._id2glMaterialRef.set(r,e.id,i)}return i.ref(),i.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);r!=null&&(r.unref(),r.referenced||(Ve(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&li.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Ta=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,ae(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var rt;(function(e){e[e.Immediate=0]="Immediate",e[e.FadeWithWeather=1]="FadeWithWeather"})(rt||(rt={}));let Oa=class{constructor(e){this.shadowMap=e,this.slot=E.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=Be.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new Qe,this._inverseViewport=y(),this._oldLighting=new vt,this._newLighting=new vt,this._fadedLighting=new vt,this._lighting=this._newLighting,this.ssr=new Sa,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=y(),this.highlightMixTexture=null,this.hudRenderStyle=js.Occluded,this.hudOccludedFragmentOpacity=1,this.clouds=new ta,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,r,i){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=r,this._newLighting.set(e),i===rt.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},Sa=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=H()}},Ra=class{constructor(e,t){this.rctx=e,this.lastFrameCamera=new Qe,this.output=P.Color,this.renderOccludedMask=it,this.bind=new Oa(t),this.bind.alignPixelEnabled=!0}};const it=je.Occlude|je.OccludeAndTransparent|je.OccludeAndTransparentStencil;let Fe=class extends Qe{constructor(){super(...arguments),this._projectionMatrix=H()}get projectionMatrix(){return this._projectionMatrix}};c([w()],Fe.prototype,"_projectionMatrix",void 0),c([w({readOnly:!0})],Fe.prototype,"projectionMatrix",null),Fe=c([q("esri.views.3d.webgl-engine.lib.CascadeCamera")],Fe);var Lt;(function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"})(Lt||(Lt={}));class st{constructor(){this.camera=new Fe,this.lightMat=H()}}class Ia{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class Pa{constructor(t,r){this._fbos=t,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Ia,this._projectionView=H(),this._projectionViewInverse=H(),this._modelViewLight=H(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=dt(),this._cascades=[new st,new st,new st,new st],this._lastOrigin=null,this._maxTextureWidth=Math.min(hi("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Cr(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=we(this._handle),this._discardSnapshots()}set maxCascades(t){this.settings.maxNumCascadesHighQuality=jt(Math.floor(t),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let t=0;t<this._numCascades;++t)Ht[t]=this._cascades[t];return Ht.length=this._numCascades,Ht}start(t,r,i,s,a){ae(this.enabled);const{near:n,far:o}=La(i);this._computeCascadeDistances(n,o,s),this._textureHeight=this._computeTextureHeight(t,a,s),this._setupMatrices(t,r);const{viewMatrix:l,projectionMatrix:d}=t;for(let g=0;g<this._numCascades;++g)this._constructCascade(g,d,l,r);this._lastOrigin=null,this.clear()}finish(){ae(this.enabled),this._handle?.detachDepth()}getShadowMapMatrices(t){if(!this._lastOrigin||!Ii(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||Te(),G(this._lastOrigin,t);for(let r=0;r<this._numCascades;++r){$t(Qr,this._cascades[r].lightMat,t);for(let i=0;i<16;++i)Xr[16*r+i]=Qr[i]}}return Xr}moveSnapshot(t){ae(this.enabled),this._handle?.detachDepth(),this._snapshots[t]?.release(),this._snapshots[t]=this._handle,this._handle=null,this.clear()}copySnapshot(t){const r=this._handle?.getTexture()?.descriptor;if(!this.enabled||!r)return;this._snapshots[t]?.release();const{width:i,height:s}=r,a=t===Lt.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[t]=this._fbos.acquire(i,s,a,U.RGBA4);const n=this._fbos.rctx;this._bindFbo();const o=n.bindTexture(this._snapshots[t]?.getTexture(),he.TEXTURE_UNIT_FOR_UPDATES);n.gl.copyTexSubImage2D(ur.TEXTURE_2D,0,0,0,0,0,i,s),n.bindTexture(o,he.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(t){return this.enabled?this._snapshots[t]?.getTexture():null}clear(){const t=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),t.setClearColor(1,1,1,1),t.clear(te.COLOR|te.DEPTH)}_computeTextureHeight(t,r,i){const s=Math.min(window.devicePixelRatio,r)/t.pixelRatio,a=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,n=Gi(Math.floor(Math.max(t.fullWidth,t.fullHeight)*s*a)),o=Math.min(this._maxTextureWidth,this._numCascades*n);return Bi(o/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",U.RGBA4)),this._handle?.acquireDepth(ji.DEPTH16_BUFFER)}_discardSnapshot(t){this._snapshots[t]=we(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}_bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(t,r,i,s){const a=this._cascades[t],n=-this._cascadeDistances[t],o=-this._cascadeDistances[t+1],l=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]),d=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]);ae(l<d);for(let p=0;p<8;++p){Cr(Gr,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?l:d,1);const R=N[p];Ys(R,Gr,this._projectionViewInverse),R[0]/=R[3],R[1]/=R[3],R[2]/=R[3]}Pi(Nt,N[0]),a.camera.viewMatrix=$t(Da,this._modelViewLight,Nt);for(let p=0;p<8;++p)Zt(N[p],N[p],a.camera.viewMatrix);let g=N[0][2],_=N[0][2];for(let p=1;p<8;++p)g=Math.min(g,N[p][2]),_=Math.max(_,N[p][2]);g-=200,_+=200,a.camera.near=-_,a.camera.far=-g,Ma(i,s,g,_,a.camera),ut(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const m=this._textureHeight;a.camera.viewport=[t*m,0,m,m]}_setupMatrices(t,r){ut(this._projectionView,t.projectionMatrix,t.viewMatrix),vi(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===pr.Global?t.eye:Jt(Nt,0,0,1);xi(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],i)}_computeCascadeDistances(t,r,i){const s=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Li(r/t,4)),s);const a=(r-t)/this._numCascades,n=(r/t)**(1/this._numCascades);let o=t,l=t;for(let d=0;d<this._numCascades+1;++d)this._cascadeDistances[d]=ci(o,l,this.settings.splitSchemeLambda),o*=n,l+=a}get test(){}}const Da=H(),Gr=dt(),N=[];for(let e=0;e<8;++e)N.push(dt());const Br=y(),jr=y(),Ea=y(),kr=y(),Yr=y(),Nt=Te(),Ht=[],Qr=H(),Xr=ee.concat(ee,ee,ee,ee),L=y(),pe=y(),ie=[y(),y(),y(),y()],T=y(),Wt=y(),K=y(),Me=y(),_e=y(),fe=y(),at=y();function Aa(e,t,r,i,s,a,n,o){W(L,0,0);for(let v=0;v<4;++v)re(L,L,e[v]);oe(L,L,.25),W(pe,0,0);for(let v=4;v<8;++v)re(pe,pe,e[v]);oe(pe,pe,.25),De(ie[0],e[4],e[5],.5),De(ie[1],e[5],e[6],.5),De(ie[2],e[6],e[7],.5),De(ie[3],e[7],e[4],.5);let l=0,d=dr(ie[0],L);for(let v=1;v<4;++v){const I=dr(ie[v],L);I<d&&(d=I,l=v)}le(T,ie[l],e[l+4]);const g=T[0];let _,m;T[0]=-T[1],T[1]=g,le(Wt,pe,L),O(Wt,T)<0&&Ps(T,T),De(T,T,Wt,r),gr(T,T),_=m=O(le(K,e[0],L),T);for(let v=1;v<8;++v){const I=O(le(K,e[v],L),T);I<_?_=I:I>m&&(m=I)}Ds(i,L),oe(K,T,_-t),re(i,i,K);let p=-1,R=1,me=0,ve=0;for(let v=0;v<8;++v){le(Me,e[v],i),gr(Me,Me);const I=T[0]*Me[1]-T[1]*Me[0];I>0?I>p&&(p=I,me=v):I<R&&(R=I,ve=v)}ne(p>0,"leftArea"),ne(R<0,"rightArea"),oe(_e,T,_),re(_e,_e,L),oe(fe,T,m),re(fe,fe,L),at[0]=-T[1],at[1]=T[0];const nt=ze(i,e[ve],fe,re(K,fe,at),1,s),Le=ze(i,e[me],fe,K,1,a),xe=ze(i,e[me],_e,re(K,_e,at),1,n),ye=ze(i,e[ve],_e,K,1,o);ne(nt,"rayRay"),ne(Le,"rayRay"),ne(xe,"rayRay"),ne(ye,"rayRay")}function u(e,t){return 3*t+e}const $r=y();function F(e,t){return W($r,e[t],e[t+3]),$r}const D=y(),h=ks();function Fa(e,t,r,i,s){le(D,r,i),oe(D,D,.5),h[0]=D[0],h[1]=D[1],h[2]=0,h[3]=D[1],h[4]=-D[0],h[5]=0,h[6]=D[0]*D[0]+D[1]*D[1],h[7]=D[0]*D[1]-D[1]*D[0],h[8]=1,h[u(0,2)]=-O(F(h,0),e),h[u(1,2)]=-O(F(h,1),e);let a=O(F(h,0),r)+h[u(0,2)],n=O(F(h,1),r)+h[u(1,2)],o=O(F(h,0),i)+h[u(0,2)],l=O(F(h,1),i)+h[u(1,2)];a=-(a+o)/(n+l),h[u(0,0)]+=h[u(1,0)]*a,h[u(0,1)]+=h[u(1,1)]*a,h[u(0,2)]+=h[u(1,2)]*a,a=1/(O(F(h,0),r)+h[u(0,2)]),n=1/(O(F(h,1),r)+h[u(1,2)]),h[u(0,0)]*=a,h[u(0,1)]*=a,h[u(0,2)]*=a,h[u(1,0)]*=n,h[u(1,1)]*=n,h[u(1,2)]*=n,h[u(2,0)]=h[u(1,0)],h[u(2,1)]=h[u(1,1)],h[u(2,2)]=h[u(1,2)],h[u(1,2)]+=1,a=O(F(h,1),t)+h[u(1,2)],n=O(F(h,2),t)+h[u(2,2)],o=O(F(h,1),r)+h[u(1,2)],l=O(F(h,2),r)+h[u(2,2)],a=-.5*(a/n+o/l),h[u(1,0)]+=h[u(2,0)]*a,h[u(1,1)]+=h[u(2,1)]*a,h[u(1,2)]+=h[u(2,2)]*a,a=O(F(h,1),t)+h[u(1,2)],n=O(F(h,2),t)+h[u(2,2)],o=-n/a,h[u(1,0)]*=o,h[u(1,1)]*=o,h[u(1,2)]*=o,s[0]=h[0],s[1]=h[1],s[2]=0,s[3]=h[2],s[4]=h[3],s[5]=h[4],s[6]=0,s[7]=h[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=h[6],s[13]=h[7],s[14]=0,s[15]=h[8]}function Ma(e,t,r,i,s){const a=1/N[0][3],n=1/N[4][3];ae(a<n);let o=a+Math.sqrt(a*n);const l=Math.sin(ui(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=l,Aa(N,o,l,Br,jr,Ea,kr,Yr),Fa(Br,jr,kr,Yr,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}function La(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}let Zr=class extends B{constructor(e,t){super(e,t,new j(la,()=>import("./ImageMaterial.glsl-CkjjitKN.js").then(r=>r.T)))}initializePipeline(e){return e.hasAlpha?Y({blending:wt,colorWrite:Q}):Y({colorWrite:Q})}},Jr=class extends ki{constructor(){super(...arguments),this.hasAlpha=!1}};c([A()],Jr.prototype,"hasAlpha",void 0);let Ut=class extends Re{constructor(){super(...arguments),this.overlayIndex=$.INNER,this.opacity=1}};function Kr(){const e=new k;return e.include(_t),e.fragment.uniforms.add(new V("tex",t=>t.texture)),e.fragment.uniforms.add(new qe("overlayIdx",t=>t.overlayIndex)),e.fragment.uniforms.add(new Ge("opacity",t=>t.opacity)),e.fragment.main.add(C`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const Na=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Ut,build:Kr},Symbol.toStringTag,{value:"Module"}));let ei=class extends B{constructor(e,t){super(e,t,new j(Na,()=>import("./ImageMaterial.glsl-CkjjitKN.js").then(r=>r.O)))}},z=class extends zs{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Ut,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new di,this._passParameters=new Et,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Qe,this.events=new gi,this.longitudeCyclical=null,this.produces=new Map([[E.DRAPED_MATERIAL,t=>t!==P.Highlight||this.hasHighlights],[E.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this._view,t=e._stage,r=t.renderer.fboCache,{waterTextures:i,textures:s}=t.renderView;this._renderContext=new Ra(this._rctx,new Pa(r,e.state.viewingMode)),this.addHandles([se(()=>i.updating,()=>this.events.emit("content-changed"),kt),se(()=>this.spatialReference,o=>this._localOriginFactory=new Ns(o),kt),pi(()=>e.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),se(()=>ya(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,ht),se(()=>e.state.highlights,o=>{this._bindParameters.highlights=o,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap,this._updateHighlights()},ht),e.resourceController.scheduler.registerTask(Qs.STAGE,this)]),this._materials=new ba(s,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));const{_bindParameters:a,_camera:n}=this;n.near=1,n.far=1e4,n.relativeElevation=null,a.slot=E.DRAPED_MATERIAL,a.mainDepth=null,a.camera=n,a.oitPass=Be.NONE,a.updateLighting([new Yi(_i())],0,0,rt.Immediate)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=Ve(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view._stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){this._pluginContext=e,this._techniques.precompile(ei)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||Oe(this._renderers,e=>e.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e)}_updateHighlights(){const e=this._view.state;this._renderers.forEach(t=>t.updateHighlights(e.highlightOrderMap))}createDrapeSourceRenderer(e,t,r){this._renderers.get(e)?.destroy();const s=new t({...r,rendererContext:this,drapeSource:e});return this._renderers.set(e,s),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(se(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),s}removeDrapeSourceRenderer(e){if(e==null)return;const t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&ct(e,t=>t.drapeTargetType===Hs.WithoutRasterImage)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=ct(e,t=>t.drapeSourceType===Ye.Features),this._hasDrapedRasterSource=ct(e,t=>t.drapeSourceType===Ye.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new Js(this._stage.renderer.fboCache),this._overlays=[new Or,new Or]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=Ve(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){if(e!=null)return e===b.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(b.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_processDrapeSources(e,t){let r=!1;for(const[i,s]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&s.commitChanges(this._view.state.highlightOrderMap)&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=Oe(this._renderers,i=>i.hasHighlights),this.notifyChange("rendersOccludedDraped"))}hasHighlightOptions(e){return Oe(this._renderers,t=>t.hasHighlightOptions(e))}processSyncDrapeSources(){this._processDrapeSources(Xs,e=>e.updatePolicy===Ws.SYNC)}get isEmpty(){return!xt.OVERLAY_DRAW_DEBUG_TEXTURE&&!Oe(this._renderers,e=>!e.isEmpty)}get hasWater(){const e=Oe(this._renderers,t=>t.hasWater);return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Vt,++this._techniques.precompiling;const t=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=e,t}renders(e){if(xt.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==b.Occluded&&e!==b.Highlight)return!0;++this._techniques.precompiling;const t=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,t}get mode(){return this.isEmpty?ge.Disabled:this.hasWater&&this.renders(b.WaterNormal)?ge.EnabledWithWater:this._renderTargets?.getTexture(b.Color)?ge.Enabled:ge.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach(r=>t=r.updateAnimation(e)||t),t&&this.parent.requestRender(Ie.BACKGROUND),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(this._renderTargets){this._bindParameters.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const t of this._renderTargets.targets){if(t.content===b.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=t.output;this._renderContext.output=r,this._bindParameters.slot=r===P.Normal?E.DRAPED_WATER:E.DRAPED_MATERIAL,t.content===b.Occluded&&(this._renderContext.renderOccludedMask=Vt),this._sortedRenderers.forAll(({drapeSource:i,renderer:s})=>{t.content===b.ColorNoRasterImage&&i.drapeSourceType===Ye.RasterImage||s.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=it}--this._techniques.precompiling}}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const t of this._overlays)this.longitudeCyclical?t.setupGeometryViewsCyclical(this.longitudeCyclical):t.setupGeometryView();this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;for(const t of this._renderTargets.targets){if(t.content===b.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget($.INNER,t),i=this._drawTarget($.OUTER,t);(r||i)&&t.fbo.generateMipMap()}}}_drawTarget(e,t){const r=this._overlays[e],i=r.canvasGeometries;if(i.numViews===0)return!1;const s=this._view.state.contentPixelRatio;this._screenToWorldRatio=s*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const a=t.output;if(this.isEmpty||a===P.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:n,_camera:o,_renderContext:l,_bindParameters:d}=this;if(o.pixelRatio=r.pixelRatio*s,l.output=a,d.screenToWorldRatio=this._screenToWorldRatio,d.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,d.slot=a===P.Normal?E.DRAPED_WATER:E.DRAPED_MATERIAL,t.content===b.Occluded&&(l.renderOccludedMask=Vt),!this.renders(t.content))return l.renderOccludedMask=it,!1;const{resolution:g}=r,_=e===$.INNER?0:g;if(n.setViewport(_,0,g,g),this._bindTargetFBO(t),e===$.INNER&&(n.setClearColor(0,0,0,0),n.clear(te.COLOR)),xt.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==b.Occluded&&t.content!==b.Highlight){this._techniques.precompile(Zr,zt);const m=this._techniques.get(Zr,zt);for(let p=0;p<i.numViews;p++)this._setViewParameters(i.extents[p],r),this._ensureDebugPatternResources(r.resolution,Wa[e]),n.bindTechnique(m,d,this._passParameters),n.screen.draw()}if(t.output===P.Highlight){const{fboCache:m}=this._stage.renderer,p=this._resolution;this._bindTargetFBO(t),Ca(n,m,{width:p,height:p},d,()=>this._renderAllGeometry(e,t),_)}else this._renderAllGeometry(e,t);return n.bindFramebuffer(null),l.renderOccludedMask=it,!0}_renderAllGeometry(e,t){const r=this._overlays[e],i=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:s,renderer:a})=>{if(t.content===b.ColorNoRasterImage&&s.drapeSourceType===Ye.RasterImage)return;const{fullOpacity:n}=s,o=n!=null&&n<1&&t.output===P.Color&&this._bindTemporaryFBO();for(let l=0;l<i.numViews;l++)this._setViewParameters(i.extents[l],r),a.render(this._renderContext);if(o){this._bindTargetFBO(t),this._overlayParameters.texture=o.getTexture(),this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=e;const l=this._techniques.get(ei);this._rctx.bindTechnique(l,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release()}})}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.bind(this._rctx,r,t)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this._stage.renderer.fboCache,i=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(te.COLOR),i}get _resolution(){return this._overlays?.[$.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:a}of this._sortedRenderers)s=a.intersect?.(e,t,r,i,s)??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this._view.map.allLayers,t=e.length;this._renderers.forEach((r,i)=>{const s=e.indexOf(i.layer),a=s>=0,n=i.renderGroup??(a?fr.MapLayer:fr.ViewLayer),o=t*n+(a?s:0);this._sortedRenderers.push(new Ha(i,r,o))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],yi(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),wi(r.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(Jt(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let a=0;a<e;a++)for(let n=0;n<e;n++){const o=Math.floor(n/10),l=Math.floor(a/10);o<2||l<2||10*o>e-20||10*l>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&o&&1&l?1&n^1&a?0:255:1&o^1&l?0:128)}const s=new wr(e);s.samplingMode=hr.NEAREST,this._passParameters.texture=new he(this._rctx,s,r)}get test(){}};c([w()],z.prototype,"hasHighlights",void 0),c([w()],z.prototype,"_sortedDrapeSourceRenderersDirty",void 0),c([w({constructOnly:!0})],z.prototype,"parent",void 0),c([w({readOnly:!0})],z.prototype,"_techniques",null),c([w({type:Boolean,readOnly:!0})],z.prototype,"updating",null),c([w()],z.prototype,"isEmpty",null),c([w({readOnly:!0})],z.prototype,"rendersOccludedDraped",null),z=c([q("esri.views.3d.terrain.OverlayRenderer")],z);class Ha{constructor(t,r,i){this.drapeSource=t,this.renderer=r,this.index=i}}const Wa=[[1,.5,.5],[.5,.5,1]],ti=-2,Vt=je.OccludeAndTransparent,zt=new Jr;zt.hasAlpha=!0;let Ua=class{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=H(),this._shaderTransformation=null,this._boundingSphere=null,this.id=fi(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){Ci(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=H(),ut(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=Di(),Zt(Ei(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*Fi(this.shaderTransformation)),this._boundingSphere):Ai}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlight(){return this.geometry.highlights}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};class ri extends Qi{intersect(t,r,i,s,a,n){return Xi(t,i,s,a,void 0,n)}}function ii(e){const t=new k,{vertex:r,fragment:i,attributes:s,varyings:a}=t,{vvColor:n,hasVertexColors:o}=e;return $i(r,e),t.include(Zi,e),t.include(Ji,e),t.include(Ki,e),t.include(es,e),i.include(ts,e),t.include(rs,e),t.include(is,e),s.add(x.POSITION,"vec3"),n&&s.add(x.COLORFEATUREATTRIBUTE,"float"),o||a.add("vColor","vec4"),a.add("vpos","vec3"),r.uniforms.add(new ss("uColor",l=>l.color)),r.main.add(C`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${o?"vColor *= uColor;":n?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      gl_Position = transformPosition(proj, view, vpos);`),i.include(as),i.main.add(C`discardBySlice(vpos);
discardByTerrainDepth();
outputColorHighlightOID(vColor, vpos);`),t}const Va=Object.freeze(Object.defineProperty({__proto__:null,build:ii},Symbol.toStringTag,{value:"Module"}));class za extends B{constructor(t,r){super(t,r,new j(Va,()=>import("./ImageMaterial.glsl-CkjjitKN.js").then(i=>i.C)))}_createPipeline(t,r){const{oitPass:i,output:s,transparent:a,cullFace:n,draped:o,hasOccludees:l,polygonOffset:d,enableOffset:g}=t,_=i===Be.NONE,m=i===Be.FrontFace;return Y({blending:er(s)&&a?ns(i):null,culling:Is(n),depthTest:o?null:{func:os(i)},depthWrite:ls(t),drawBuffers:s===P.Depth?{buffers:[Rs.NONE]}:hs(i,s),colorWrite:Q,stencilWrite:l?cs:null,stencilTest:l?r?us:ds:null,polygonOffset:_||m?d?qa:null:gs(g)})}initializePipeline(t){return this._occludeePipelineState=this._createPipeline(t,!0),this._createPipeline(t,!1)}getPipeline(t){return t?this._occludeePipelineState:super.getPipeline()}}const qa={factor:1,units:1};let M=class extends ps{constructor(){super(...arguments),this.cullFace=yt.None,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1,this.textureCoordinateType=_s.None,this.emissionSource=fs.None,this.occlusionPass=!1,this.hasVvInstancing=!0,this.vvSize=!1,this.vvOpacity=!1}};c([A({count:yt.COUNT})],M.prototype,"cullFace",void 0),c([A()],M.prototype,"hasVertexColors",void 0),c([A()],M.prototype,"transparent",void 0),c([A()],M.prototype,"discardInvisibleFragments",void 0),c([A()],M.prototype,"polygonOffset",void 0),c([A()],M.prototype,"enableOffset",void 0),c([A()],M.prototype,"writeDepth",void 0),c([A()],M.prototype,"hasOccludees",void 0),c([A()],M.prototype,"terrainDepthTest",void 0),c([A()],M.prototype,"cullAboveTerrain",void 0),c([A()],M.prototype,"objectAndLayerIdColorInstanced",void 0),c([A()],M.prototype,"vvColor",void 0),c([A()],M.prototype,"draped",void 0);let Ga=class extends ri{constructor(e){super(e,ja),this._configuration=new M,this.supportsEdges=!0,this.produces=new Map([[E.OPAQUE_MATERIAL,t=>this._isOpaqueMaterialPass(t)],[E.OPAQUE_MATERIAL_WITHOUT_NORMALS,t=>this._isOpaqueNoSSAODepthPass(t)],[E.TRANSPARENT_MATERIAL,t=>gt(t)&&this._transparent&&this.parameters.writeDepth],[E.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,t=>tr(t)&&this._transparent&&this.parameters.writeDepth],[E.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,t=>gt(t)&&this._transparent&&!this.parameters.writeDepth],[E.DRAPED_MATERIAL,t=>Ni(t)]])}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<ms,this._configuration.terrainDepthTest=t.terrainDepthTest&&er(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=vs}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===P.Highlight||gt(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return tr(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new Ba(e)}createBufferWriter(){const e=Se().vec3f(x.POSITION);return rr()&&e.vec4u8(x.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(x.COLORFEATUREATTRIBUTE):e.vec4u8(x.COLOR),new xs(e)}},Ba=class extends ys{beginSlot(e){return this.getTechnique(za,e)}};class ja extends ws{constructor(){super(...arguments),this.color=Kt,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=yt.None,this.draped=!1,this.discardInvisibleFragments=!1}}var qt;(function(e){e[e.EnableFastUpdates=0]="EnableFastUpdates",e[e.DisableFastUpdates=1]="DisableFastUpdates",e[e.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"})(qt||(qt={}));const S={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},ka={dash:S.dash,"dash-dot":[...S.dash,...S.dot],dot:S.dot,"long-dash":S["long-dash"],"long-dash-dot":[...S["long-dash"],...S.dot],"long-dash-dot-dot":[...S["long-dash"],...S.dot,...S.dot],none:null,"short-dash":S["short-dash"],"short-dash-dot":[...S["short-dash"],...S["short-dot"]],"short-dash-dot-dot":[...S["short-dash"],...S["short-dot"],...S["short-dot"]],"short-dot":S["short-dot"],solid:null},Ya=8;function Qa(e,t){return e==null?e:{pattern:e.slice(),pixelRatio:t}}function Xa(e){return{pattern:[e,e],pixelRatio:2}}function $a(e){return e?.type==="style"?Za(e.style):null}function Za(e){return e!=null?Qa(ka[e],Ya):null}function Ja(e,t,r=null){const i=[],s=t.mapPositions;Ka(t,i);const a=i[0][1].data,n=i[0][1].indices.length,o=Ms(n);return en(t,i,o),sn(t,i,o),tn(t,i,o),rn(t,i,o),an(t,i,o),nn(t,i,o),on(t,i,a),new Cs(e,i,s,bs.Line,r)}function Ka(e,t){const{attributeData:{position:r},removeDuplicateStartEnd:i}=e,s=ln(r)&&i,a=r.length/3-(s?1:0),n=new Array(2*(a-1)),o=s?r.slice(0,-3):r;let l=0;for(let d=0;d<a-1;d++)n[l++]=d,n[l++]=d+1;t.push([x.POSITION,new X(o,n,3,s)])}function en(e,t,r){if(e.attributeData.colorFeature!=null)return;const i=e.attributeData.color;t.push([x.COLOR,new X(i??Mi,r,4)])}function tn(e,t,r){e.attributeData.normal&&t.push([x.NORMAL,new X(e.attributeData.normal,r,3)])}function rn(e,t,r){e.attributeData.colorFeature!=null&&t.push([x.COLORFEATUREATTRIBUTE,new X([e.attributeData.colorFeature],r,1,!0)])}function sn(e,t,r){e.attributeData.sizeFeature==null&&t.push([x.SIZE,new X([e.attributeData.size??1],r,1,!0)])}function an(e,t,r){e.attributeData.sizeFeature!=null&&t.push([x.SIZEFEATUREATTRIBUTE,new X([e.attributeData.sizeFeature],r,1,!0)])}function nn(e,t,r){e.attributeData.opacityFeature!=null&&t.push([x.OPACITYFEATUREATTRIBUTE,new X([e.attributeData.opacityFeature],r,1,!0)])}function on(e,t,r){if(e.overlayInfo==null||e.overlayInfo.renderCoordsHelper.viewingMode!==pr.Global||!e.overlayInfo.spatialReference.isGeographic)return;const i=Yt(r.length),s=mi(e.overlayInfo.spatialReference);for(let _=0;_<i.length;_+=3)As(r,_,i,_,s);const a=r.length/3,n=Ts(a+1);let o=hn,l=cn,d=0,g=0;W(o,i[g++],i[g++]),g++,n[0]=0;for(let _=1;_<a+1;++_)_===a&&(g=0),W(l,i[g++],i[g++]),g++,d+=Es(o,l),n[_]=d,[o,l]=[l,o];t.push([x.DISTANCETOSTART,new X(n,t[0][1].indices,1,!0)])}function ln(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}const hn=y(),cn=y();function un(e,t,r,i){const s=e.type==="polygon"?ke.CCW_IS_HOLE:ke.NONE,a=e.type==="polygon"?e.rings:e.paths,{position:n,outlines:o}=_r(a,!!e.hasZ,s,e.spatialReference),l=Yt(n.length),d=Us(n,e.spatialReference,0,l,0,n,0,n.length/3,t,r,i),g=d!=null;return{lines:g?si(o,n,l):[],projectionSuccess:g,sampledElevation:d}}function dn(e,t){const r=e.type==="polygon"?ke.CCW_IS_HOLE:ke.NONE,i=e.type==="polygon"?e.rings:e.paths,{position:s,outlines:a}=_r(i,!1,r),n=Fs(s,e.spatialReference,0,s,t,0);for(let o=2;o<s.length;o+=3)s[o]=ti;return{lines:n?si(a,s):[],projectionSuccess:n}}function si(e,t,r=null){const i=new Array;for(const{index:s,count:a}of e){if(a<=1)continue;const n=3*s,o=3*a;i.push({position:Qt(t,3*s,3*a),mapPositions:r!=null?Qt(r,n,o):void 0})}return i}const gn=Se().vec3f(x.POSITION),pn=Se().vec3f(x.POSITION).vec2f(x.UV0),_n=Se().vec3f(x.POSITION).vec4u8(x.COLOR),fn=Se().vec3f(x.POSITION).vec2f(x.UV0).vec4u8(x.OBJECTANDLAYERIDCOLOR);export{Ga as A,Dr as B,Ut as C,Kr as D,bt as E,ii as F,Tt as I,gn as a,Ja as b,qt as c,fn as d,ri as e,pn as f,Ua as g,na as h,Xa as i,Mr as j,Ft as k,dn as l,Ar as m,$a as n,fa as o,un as p,J as q,_n as r,Ae as s,ti as t,At as u,Hr as v,Ur as w,Mt as x,zr as y,Et as z};
