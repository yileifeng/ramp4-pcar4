import{r as Mt,o as Z}from"./vec2-BnynUbeJ.js";import{t as A,l as Dt}from"./vec2f64-CEUyUoff.js";import{aP as wt,lw as Ft,lx as tt,ly as Ht,x as y,z as T,K as et,aL as Nt,b_ as zt,aI as E,b$ as it,g5 as st,T as nt,ff as Ut,hp as at,lj as Bt,lz as Pt,gA as Vt,Q as Gt,s as rt,ax as Wt}from"./main-BC8gbEPx.js";import{P as H,aV as k,O as j,af as kt}from"./Geometry-6d2Fi3Pn.js";import{e as N}from"./mat4f64-BaJwL7tQ.js";import{o as jt,E as q,c as Y,P as ot}from"./vec32-CKLwdlap.js";import{n as qt,r as D}from"./vec4f64-CjUMzAyX.js";import{t as ht}from"./glUtil-n1JOrdV3.js";import{s as p,H as lt}from"./InterleavedLayout-BbMawCR1.js";import{r as Yt,o as Xt,i as Jt,E as $t,U as Kt}from"./HUDMaterial-JZfd5xsg.js";import{n as C}from"./ShaderOutput-C_OqLoo1.js";import{i as Qt}from"./IntersectorInterfaces-9nlZxCRy.js";import{b as X}from"./Octree-DwXFlTz0.js";import{e as c}from"./VertexAttribute-DFC3a3eR.js";import{n as Zt,s as te,u as ee}from"./mat3-DOnW3DjW.js";import{e as ie}from"./mat3f64-Dh9_zhFu.js";import{c as se}from"./mat4-BDUaQr32.js";import{i as ct,l as z,c as dt,x as U,b as _t,T as ne,u as ae,h as re,d as ut}from"./BufferView-BaIKDMOo.js";import{g as oe,m as he}from"./plane-DnaQmUZU.js";import{E as gt}from"./VertexArrayObject-Bo1SXp0_.js";import{F as ft}from"./enums-DBi1-Mm2.js";import{T as le,E as ce,U as de}from"./sphere-BQalhKXp.js";import{O as _e}from"./basicInterfaces-Dsf65ICa.js";import{j as ue}from"./dehydratedFeatureUtils-DGoW5D8R.js";import{N as ge,i as fe,m as me,v as pe,J as ye,_ as Ie}from"./DefaultMaterial-CdaA8o3c.js";import{c as J}from"./HighlightDefaults-OPxBBZpm.js";import{g as Se,C as Te}from"./Scheduler-D6n_mU38.js";import{E as Re,_ as be}from"./Texture-CgORJFQB.js";import"./projectBuffer-CI8y-xLT.js";import{n as ve}from"./projectVectorToVector-B5ubG6d0.js";import"./glsl-o28TenZV.js";import"./BindType-CKbZk6AG.js";import"./ShaderBuilder-Ds5biX5E.js";import"./vec42-D8CJyqHG.js";import"./NormalAttribute.glsl-CQJ1-ei8.js";import"./boundedPlane-BSNdaYKJ.js";import"./ViewingMode-CyR_b1T8.js";function B(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}function mt(t){const{size:e}=t.definition,i=t.fontString(e);let s=pt.get(i);if(!s){const n=B(xe,0,0).getContext("2d");t.setFontProperties(n,e);const a=n.measureText(Le);s=new Ae(a.actualBoundingBoxAscent,a.actualBoundingBoxDescent),pt.set(i,s)}return s}const pt=new Map;let Ae=class{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(t,e){this.maxAscent=t,this.maxDescent=e}};const xe={canvas:null},Le=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})(),yt=1;let Ee=class{constructor(t,e,i,s){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${t}--${this._parameters.key}-${this._alignment}`,this._lines=t.replaceAll(" ","\xA0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let t=this._metrics.firstLineAscent;for(let e=0;e<this._lines.length-1;e++)t+=this._lineSpacing;return t+=this._metrics.lastLineDescent,Math.ceil(t+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(this._metricsCached==null){const t=B(St,P,P).getContext("2d"),e=this._parameters.definition.pixelRatio,i=this._fontSize*e;this._parameters.setFontProperties(t,i);let s=2*this._haloSize;const n=this._parameters.definition.font;n.style!=="italic"&&n.style!=="oblique"&&n.weight!=="bold"&&n.weight!=="bolder"||(s+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let a=0,o=0,h=0,r=0,l=0;this._lines.forEach((W,M)=>{const x=t.measureText(W),F=x.width/e,Q=F+s;this._textWidths.push(F),this._lineWidths.push(Q),a=Math.max(a,Q),r=Math.max(r,x.actualBoundingBoxAscent/e),l=Math.max(l,x.actualBoundingBoxDescent/e),M===0&&(o=x.actualBoundingBoxAscent/e),M===this._lines.length-1&&(h=x.actualBoundingBoxDescent/e)});const _=mt(this._parameters),d=Math.max(r,_.maxAscent),m=Math.max(l,_.maxDescent),f=o,g=this._parameters.definition.font.decoration==="underline"?m:h,S=a;this._metricsCached=new Oe(f,g,d,m,S)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*Ce}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,yt)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(this._renderPixelRatio==null){const t=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(t,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case L.Left:return this._horizontalPadding;case L.Center:return(this.displayWidth-this._lineWidths[t])/2;case L.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[t]}}render(t,e,i){t.save();const s=e/=this.renderPixelRatio,n=i/=this.renderPixelRatio,a=this._haloSize,o=this._firstLineYOffset+this._metrics.firstLineAscent;e+=a,i+=o;const h=this._haloSize>0;h&&this._renderHalo(t,s,n,a,o),this._parameters.setFontProperties(t,this._renderedFontSize);for(let r=0;r<this._lines.length;++r){const l=this._lines[r],_=this._getLineXOffset(r);h&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,l,e+_,i),this._renderLineDecoration(t,e+_,i,this._textWidths[r])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,l,e+this._getLineXOffset(r),i),this._renderLineDecoration(t,e+_,i,this._textWidths[r]),i+=this._lineSpacing}if(H.TEXT_SHOW_BASELINE){t.strokeStyle=Tt,t.setLineDash([2,2]),t.lineWidth=1;let r=n+o;for(let l=0;l<this._lines.length;++l)this._drawLine(t,[s,r],[s+this.displayWidth,r]),r+=this._lineSpacing}if(H.TEXT_SHOW_BORDER&&(t.strokeStyle=Tt,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const r=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,n,r),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,e,i,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const a=1,o=Math.max(this._parameters.definition.size/16,a);switch(this._parameters.definition.font.decoration){case"underline":i+=2*o;break;case"line-through":i-=.33*this._midLineAscent}const h=n?this._haloSize:0;t.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(o+2*h),t.beginPath(),t.moveTo(this._toRenderUnit(e-h),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+s+h),this._toRenderUnit(i)),t.stroke()}_roundedRect(t,e,i,s){e=this._toRenderUnit(e),i=this._toRenderUnit(i);const n=this.renderedWidth,a=this.renderedHeight;s!==0?(s=wt(s,0,Math.floor(a/2)),t.beginPath(),t.moveTo(e,i+s),t.arcTo(e,i,e+s,i,s),t.lineTo(e+n-s,i),t.arcTo(e+n,i,e+n,i+s,s),t.lineTo(e+n,i+a-s),t.arcTo(e+n,i+a,e+n-s,i+a,s),t.lineTo(e+s,i+a),t.arcTo(e,i+a,e,i+a-s,s),t.closePath()):t.rect(e,i,n,a)}_renderHalo(t,e,i,s,n){const a=this.renderedWidth,o=this.renderedHeight,h=B(St,Math.max(a,P),Math.max(o,P)),r=h.getContext("2d");r.clearRect(0,0,a,o),this._parameters.setFontProperties(r,this._renderedFontSize),r.fillStyle=this._parameters.haloStyle,r.strokeStyle=this._parameters.haloStyle;const l=this._renderedHaloSize<3;r.lineJoin=l?"miter":"round",l?this._renderHaloEmulated(r,s,n):this._renderHaloNative(r,s,n);let _=n;for(let d=0;d<this._lines.length;++d){const m=this._getLineXOffset(d);this._renderLineDecoration(r,s+m,_,this._textWidths[d],!0),_+=this._lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(h,0,0,a,o,this._toRenderUnit(e),this._toRenderUnit(i),a,o),t.globalAlpha=1}_renderHaloEmulated(t,e,i){for(let s=0;s<this._lines.length;++s){const n=this._lines[s],a=this._getLineXOffset(s);for(const[o,h]of It)this._fillText(t,n,e+a+this._haloSize*o,i+this._haloSize*h);i+=this._lineSpacing}}_renderHaloNative(t,e,i){const s=2*this._haloSize;for(let n=0;n<this._lines.length;++n){const a=this._lines[n],o=this._getLineXOffset(n),h=5,r=.1;for(let l=0;l<h;l++){const _=1-(h-1)*r+l*r;t.lineWidth=this._toRenderUnit(_*s),this._strokeText(t,a,e+o,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,e,i,s){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(s))}_strokeText(t,e,i,s){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(s))}_drawLine(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke()}_drawBox(t,e,i){const s=this._toRenderUnit(e[0]),n=this._toRenderUnit(e[1]),a=this._toRenderUnit(i[0]),o=this._toRenderUnit(i[1]),h=Math.floor(s)+.5,r=Math.ceil(s+a)-.5,l=Math.floor(n)+.5,_=Math.ceil(n+o)-.5;t.beginPath(),t.moveTo(h,l),t.lineTo(r,l),t.lineTo(r,_),t.lineTo(h,_),t.lineTo(h,l),t.stroke()}};const It=[];for(let t=0;t<360;t+=360/16)It.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)]);var L;(function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"})(L||(L={}));const St={canvas:null},Ce=.2,P=512,Tt="rgb(255, 0, 255, 0.5)";let Oe=class{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(t,e,i,s,n){this.firstLineAscent=t,this.lastLineDescent=e,this.maxLineAscent=i,this.maxLineDescent=s,this.displayWidth=n}};const Me=Object.freeze({left:0,center:.5,right:1}),De=Object.freeze({"bottom-left":A(0,0),bottom:A(.5,0),"bottom-right":A(1,0),left:A(0,.5),center:A(.5,.5),right:A(1,.5),"top-left":A(0,1),top:A(.5,1),"top-right":A(1,1)});function we(t){switch(t){case"left":return L.Left;case"right":return L.Right;default:return L.Center}}function Fe(t,e){switch(e){case"bottom":return t==="left"?"bottom-left":t==="right"?"bottom-right":"bottom";case"center":return t;case"top":return t==="left"?"top-left":t==="right"?"top-right":"top"}}function He(t){return t==="middle"?"center":t}function Ne(t,e){switch(t){case"top":return Z(e,0,yt);case"bottom":return Z(e,0,-1);default:return Mt(e,Dt)}}let Rt=class{constructor(t,e){this._material=t,this._repository=e,this._map=new Map}dispose(){this._map.forEach((t,e)=>{t!=null&&this._repository.release(this._material,e)})}load(t,e,i){if(!this._material.produces.get(e)?.(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,e,i));const s=this._map.get(i);if(s!=null){if(s.ensureResources(t)===_e.LOADED)return s;this._repository.requestRender()}return null}},w=class{constructor(t=1/0,e=-1/0){this.near=t,this.far=e}set(t,e){this.near=t,this.far=e}union(t){t!=null&&(this.near=Math.min(this.near,t.near),this.far=Math.max(this.far,t.far))}within(t){return this.near<=t&&t<=this.far}};w.zero=new w(0,0);class ze{constructor(e,i,s){this._elementSize=i,this._buffer=gt.createVertex(e,ft.STATIC_DRAW),this.resize(s)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,i,s,n=0){const a=new Uint8Array(this.array,e*this.elementSize,(i-e)*this.elementSize);new Uint8Array(s.array,n*this.elementSize).set(a)}transferAll(){this._buffer.setData(this._array)}transferRange(e,i){const s=e*this._elementSize,n=i*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),s,s,n)}resize(e){const i=e*this._elementSize,s=new ArrayBuffer(i);this._array&&(e>=this._capacity?new Uint8Array(s).set(new Uint8Array(this._array)):new Uint8Array(s).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=s,this._buffer.setSize(i),this._capacity=e}}class Ue{constructor(e){this.modelOriginHi=e.getField(c.INSTANCEMODELORIGINHI,ct),this.modelOriginLo=e.getField(c.INSTANCEMODELORIGINLO,ct),this.model=e.getField(c.INSTANCEMODEL,z),this.modelNormal=e.getField(c.INSTANCEMODELNORMAL,z),this.featureAttribute=e.getField(c.INSTANCEFEATUREATTRIBUTE,dt),this.color=e.getField(c.INSTANCECOLOR,U),this.objectAndLayerIdColor=e.getField(c.INSTANCEOBJECTANDLAYERIDCOLOR,U)}}class Be{constructor(e,i){this._rctx=e,this._instanceBufferLayout=i,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,i=this._tailIndex;return e>=i?e-i:e+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){p(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){p(this._updating,"not updating"),this.size<Ft*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){p(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),p(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){p(this._updating,"not updating"),p(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(V,Math.floor(this._capacity*tt));this._resize(e)}_shrink(){const e=Math.max(V,Math.floor(this._capacity*Ht));this._resize(e)}_resize(e){if(p(this._updating,"not updating"),e===this._capacity)return;const i=new ze(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const s=this.size,n=this._compactInstances(i);p(n===s,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=n,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=i,this._view=new Ue(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const i=this._headIndex,s=this._tailIndex;return s<i?(this._buffer.copyRange(s,i,e),i-s):s>i?(this._buffer.copyRange(s,this._capacity,e),i>0&&this._buffer.copyRange(0,i,e,this._capacity-s),i+(this._capacity-s)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,i){e<i?this._buffer.transferRange(e,i):e>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(e,this._capacity))}}const V=64;var u;function Pe(t){let e=lt().mat4f64(c.LOCALTRANSFORM).mat4f64(c.GLOBALTRANSFORM).vec4f64(c.BOUNDINGSPHERE).vec3f64(c.MODELORIGIN).mat3f(c.INSTANCEMODEL).mat3f(c.INSTANCEMODELNORMAL).vec2f(c.MODELSCALEFACTORS);return t.includes(c.FEATUREATTRIBUTE)&&(e=e.vec4f(c.FEATUREATTRIBUTE)),t.includes(c.COLOR)&&(e=e.vec4u8(c.COLOR)),t.includes(c.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(c.OBJECTANDLAYERIDCOLOR)),e=e.u8(c.STATE).u8(c.LODLEVEL),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(u||(u={}));class bt{constructor(e){this.localTransform=e.getField(c.LOCALTRANSFORM,_t),this.globalTransform=e.getField(c.GLOBALTRANSFORM,_t),this.modelOrigin=e.getField(c.MODELORIGIN,ne),this.model=e.getField(c.INSTANCEMODEL,z),this.modelNormal=e.getField(c.INSTANCEMODELNORMAL,z),this.modelScaleFactors=e.getField(c.MODELSCALEFACTORS,ae),this.boundingSphere=e.getField(c.BOUNDINGSPHERE,re),this.featureAttribute=e.getField(c.FEATUREATTRIBUTE,dt),this.color=e.getField(c.COLOR,U),this.objectAndLayerIdColor=e.getField(c.OBJECTANDLAYERIDCOLOR,U),this.state=e.getField(c.STATE,ut),this.lodLevel=e.getField(c.LODLEVEL,ut)}}let O=class extends Nt{constructor(t,e){super(t),this.events=new zt,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=Pe(e),this._capacity=V,this._buffer=this._layout.createBuffer(this._capacity),this._view=new bt(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,u.ALLOCATED),this._size++,this.events.emit("instances-changed"),t}removeInstance(t){const e=this._view.state;p(t>=0&&t<this._capacity&&!!(e.get(t)&u.ALLOCATED),"invalid instance handle"),this._getStateFlag(t,u.ACTIVE)?this._setStateFlags(t,u.REMOVE):this.freeInstance(t),this.events.emit("instances-changed")}freeInstance(t){const e=this._view.state;p(t>=0&&t<this._capacity&&!!(e.get(t)&u.ALLOCATED),"invalid instance handle"),e.set(t,0),this._size--}setLocalTransform(t,e,i=!0){this._view.localTransform.setMat(t,e),i&&this.updateModelTransform(t)}getLocalTransform(t,e){this._view.localTransform.getMat(t,e)}setGlobalTransform(t,e,i=!0){this._view.globalTransform.setMat(t,e),i&&this.updateModelTransform(t)}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e)}updateModelTransform(t){const e=this._view,i=I,s=b;e.localTransform.getMat(t,vt),e.globalTransform.getMat(t,$);const n=se($,$,vt);jt(i,n[12],n[13],n[14]),e.modelOrigin.setVec(t,i),Zt(s,n),e.model.setMat(t,s);const a=oe(I,n);a.sort(),e.modelScaleFactors.set(t,0,a[1]),e.modelScaleFactors.set(t,1,a[2]),te(s,s),ee(s,s),e.modelNormal.setMat(t,s),this._setStateFlags(t,u.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:t})}getModelTransform(t,e){const i=this._view;i.model.getMat(t,b),i.modelOrigin.getVec(t,I),e[0]=b[0],e[1]=b[1],e[2]=b[2],e[3]=0,e[4]=b[3],e[5]=b[4],e[6]=b[5],e[7]=0,e[8]=b[6],e[9]=b[7],e[10]=b[8],e[11]=0,e[12]=I[0],e[13]=I[1],e[14]=I[2],e[15]=1}applyShaderTransformation(t,e){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){this._view.localTransform.getMat(t,e),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,t,e)}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(I,this,t),e*=Math.max(I[0],I[1],I[2])),e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(I,this,t),e*=Ve(I[0],I[1],I[2])),e}getModel(t,e){this._view.model.getMat(t,e)}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e)}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e)}setColor(t,e){this._view.color.setVec(t,e)}setObjectAndLayerIdColor(t,e){this._view.objectAndLayerIdColor.setVec(t,e)}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,u.VISIBLE,e),this.events.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,u.VISIBLE)}setHighlight(t,e){const{_highlightOptionsMap:i}=this,s=i.get(t);e?e!==s&&(i.set(t,e),this._setStateFlag(t,u.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):s&&(i.delete(t),this._setStateFlag(t,u.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(t){return this._getStateFlag(t,u.HIGHLIGHT)}geHighlightOptionsPrev(t){const e=this._highlightOptionsMapPrev.get(t)??null;return this._highlightOptionsMapPrev.delete(t),e}getHighlightName(t){const e=this.highlightOptionsMap.get(t)??null;return e?this._highlightOptionsMapPrev.set(t,e):this._highlightOptionsMapPrev.delete(t),e}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let i=0;i<this._capacity;++i)this.getState(i)&t&&++e;return e}_setStateFlags(t,e){const i=this._view.state;e=i.get(t)|e,i.set(t,e)}_clearStateFlags(t,e){const i=this._view.state;e=i.get(t)&~e,i.set(t,e)}_setStateFlag(t,e,i){i?this._setStateFlags(t,e):this._clearStateFlags(t,e)}_getStateFlag(t,e){return!!(this._view.state.get(t)&e)}_grow(){this._capacity=Math.max(V,Math.floor(this._capacity*tt)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new bt(this._buffer)}_findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&u.ALLOCATED;)e=e+1===this._capacity?0:e+1;return this._next=e+1===this._capacity?0:e+1,e}};function Ve(t,e,i){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),i))}y([T({constructOnly:!0})],O.prototype,"shaderTransformation",void 0),y([T()],O.prototype,"_size",void 0),y([T({readOnly:!0})],O.prototype,"size",null),O=y([et("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],O);const I=E(),b=ie(),vt=N(),$=N();class Ge extends X{constructor(e,i){super(s=>le(this._instanceData.view.boundingSphere.getVec(s,this._tmpSphere)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=i,this._tmpSphere=ce(),this._tmpMat4=N()}addInstance(e){const i=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);q(de(this._tmpSphere),this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*he(s),i.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class We{constructor(e,i){this._worldSpaceRadius=e,this._minScreenSpaceRadii=i}selectLevel(e,i,s){const n=s.computeScreenPixelSizeAt(e),a=this._worldSpaceRadius*i/n;let o=0;for(let h=1;h<this._minScreenSpaceRadii.length;++h)a>=this._minScreenSpaceRadii[h]&&(o=h);return o}}let ke=class{constructor(t,e){const i=t.renderContext.rctx,s=e.geometry,n=e.geometry.getRenderGeometry(),a=n.material;this._materials=t.materials,a.setParameters({instancedDoublePrecision:!0}),this.geometry=s,this.material=a,this.glMaterials=new Rt(a,this._materials),this.vertexBufferLayout=n.vertexBufferLayout,this.vbo=gt.createVertex(i,ft.STATIC_DRAW,n.buffer),this.vao=new Yt(i,k,new Map([["geometry",ht(n.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=n.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(t,e,i,s,n,a,o,h){return this.geometry.intersect(t,e,i,s,n,a,o,h)}};class K{static async create(e,i,s){const n=await Promise.allSettled(i.components.map(o=>e.controller.schedule(()=>new ke(e,o),s))),a=n.map(o=>o.status==="fulfilled"?o.value:null).filter(it);if(st(s)||a.length!==n.length){a.forEach(o=>o.destroy()),nt(s);for(const o of n)if(o.status==="rejected")throw o.reason}return new K(i.minScreenSpaceRadius,a)}constructor(e,i){this.minScreenSpaceRadius=e,this.components=i}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,i,s,n,a,o,h){this.components.forEach(r=>r.intersect(e,i,s,n,a,o,this.boundingSphere,h))}get boundingBox(){if(this._boundingBox==null){const e=Ut();this.components.forEach(i=>{i.boundingInfo!=null&&(at(e,i.boundingInfo.bbMin),at(e,i.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,i=E();Bt(e,i),this._boundingSphere={center:i,radius:.5*Pt(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,i)=>e+i.triangleCount,0)}}const je=t=>{const e=t.baseBoundingSphere.radius,i=t.levels.map(s=>s.minScreenSpaceRadius);return new We(e,i)};let R=class extends Xt{constructor(t,e){super(t),this.type=Qt.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new Jt,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[j.OPAQUE_MATERIAL,i=>this._produces(i)],[j.TRANSPARENT_MATERIAL,i=>!!this._hasTransparentLevels()&&this._produces(i)]]),this._instanceData=new O({shaderTransformation:t.shaderTransformation},t.optionalFields),this.addHandles(e.registerTask(Se.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=Ye(this.optionalFields),this._glInstanceBufferLayout=ht(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:t})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",({index:t})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDataMap)t.push(e[1]);return t}get _allRenderInstanceDataExceptHighlightShadow(){const t=[this._defaultRenderInstanceData];for(const e of this._highlightRenderInstanceDataMap)e[0]!==J&&t.push(e[1]);return t}hasHighlightOptions(t){return this._highlightRenderInstanceDataMap.has(t)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(t=>t.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((t,e)=>e.reduce((i,s)=>i+s.usedMemory,t),this._levels.reduce((t,e)=>t+e.components.reduce((i,s)=>i+s.usedMemory,0),0))}get renderStats(){const t=this._instanceData.size,e=[];return this._levels.forEach((i,s)=>{const n=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,a=i.triangleCount;e.push({renderedInstances:n,renderedTriangles:n*a,trianglesPerInstance:a})}),{totalInstances:t,renderedInstances:e.reduce((i,s)=>i+s.renderedInstances,0),renderedTriangles:e.reduce((i,s)=>i+s.renderedTriangles,0),levels:e}}_createRenderInstanceDataArray(t=[]){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map(i=>{t.push(new Be(e,this._instanceBufferLayout))}),t}async initializeRenderContext(t,e){this._context=t,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const i=await Promise.allSettled(this.symbol.levels.map(n=>K.create(t,n,e))),s=i.map(n=>n.status==="fulfilled"?n.value:null).filter(it);if(st(e)||s.length!==i.length){s.forEach(n=>n.destroy()),nt(e);for(const n of i)if(n.status==="rejected")throw n.reason}this._levels=s,this._levelSelector=je(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceDataMap.forEach(t=>t.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(t=>t.components.some(e=>e.material.produces.get(j.TRANSPARENT_MATERIAL)?.(C.Color)))}hasHighlights(){return Vt(this._highlightRenderInstanceDataMap,t=>t.some(e=>e.size>0))}_produces(t){return(t!==C.Highlight||this.hasHighlights())&&(t!==C.ShadowHighlight||this.hasHighlightOptions(J))}prepareRender(t){if(!H.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const e=t.bind.contentCamera.equals(this._camera);this._camera.copyFrom(t.bind.contentCamera),e||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Te),this._needFullCycle=!1)}}acquireTechniques(t){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(t.output))return null;const e=this._getInstanceDatas(t);if(!e)return null;const i=new Array,s=this.levels;return e.forEach(n=>s.forEach(({components:a},o)=>a.forEach(h=>i.push(this._beginComponent(t,n[o],h))))),i}render(t,e){const i=this._getInstanceDatas(t);if(!i||e==null)return;let s=0;t.rctx.bindVAO();const n=this.levels;i.forEach(a=>n.forEach(({components:o},h)=>o.forEach(r=>this._renderComponent(t,e[s++],a[h],r,h))))}_getInstanceDatas(t){const{output:e,bind:i}=t,s=e===C.Highlight,n=e===C.ShadowHighlight,a=!s&&!n,o=e!==C.ShadowExcludeHighlight;if(a)return o?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;if(o){if(s){const r=i.highlight?.name;if(!r)return null;const l=this._highlightRenderInstanceDataMap.get(r);return l?[l]:null}const h=this._highlightRenderInstanceDataMap.get(J);return n?h?[h]:null:Array.from(this._highlightRenderInstanceDataMap.values())}return null}intersect(t,e,i,s){if(!this.baseMaterial.visible||this._octree==null)return;const n=E();Y(n,s,i);const a=o=>{this._instanceData.getCombinedModelTransform(o,Lt),t.transform.set(Lt),q(Et,i,t.transform.inverse),q(Ct,s,t.transform.inverse);const h=this._instanceData.getState(o),r=this._instanceData.getLodLevel(o),l=this._levels.length;p(!!(h&u.ACTIVE),"invalid instance state"),p(r>=0&&r<l,"invaid lod level"),this._levels[r].intersect(t,e,Et,Ct,o,this.metadata,l)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(i,n,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){const t=this._instanceData,e=t.view?.state;if(!e)return null;this._octreeCached=new Ge(t,this.baseBoundingSphere);for(let i=0;i<t.capacity;++i)e.get(i)&u.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Gt(this._octreeCached)}queryDepthRange(t){if(this._octree==null)return new w;const e=t.viewForward,i=this._octree.findClosest(e,X.DepthOrder.FRONT_TO_BACK,t.frustum),s=this._octree.findClosest(e,X.DepthOrder.BACK_TO_FRONT,t.frustum);if(i==null||s==null)return new w;const n=t.eye,a=this._instanceData.view;a.boundingSphere.getVec(i,v),Y(v,v,n);const o=ot(v,e)-v[3];a.boundingSphere.getVec(s,v),Y(v,v,n);const h=ot(v,e)+v[3];return new w(o,h)}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,t&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(t=>t.forEach(e=>e.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(t){const{_enableLevelSelection:e,_camera:i,_levelSelector:s}=this;this._allRenderInstanceData.forEach(_=>_.forEach(d=>d.beginUpdate()));const n=this._instanceData,a=n.view;let o=n.size;const h=n.capacity;let r=this._instanceIndex;const l=Math.ceil(h/500);for(let _=0;_<o&&!t.done;++_){r===this._cycleStartIndex&&this._startUpdateCycle();const d=a.state.get(r);let m=0;if(!(d&u.ALLOCATED)){r=r+1===h?0:r+1,o++;continue}const f=a.lodLevel.get(r);if(d&u.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[f].freeTail(),d&u.HIGHLIGHT_ACTIVE){const g=n.geHighlightOptionsPrev(r);if(g){const S=this._highlightRenderInstanceDataMap.get(g);if(!S)throw new rt("Internal error in lodRenderer");S[f].freeTail()}}if(d&u.REMOVE)n.freeInstance(r);else if(d&u.VISIBLE){let g=0;if(e&&(a.modelOrigin.getVec(r,xt),g=s.selectLevel(xt,n.getCombinedMedianScaleFactor(r),i)),m=d&~(u.ACTIVE|u.TRANSFORM_CHANGED),g>=0)if(d&u.HIGHLIGHT){const S=n.getHighlightName(r);if(S){const W=()=>{const x=this._createRenderInstanceDataArray();return x.forEach(F=>F.beginUpdate()),x},M=Wt(this._highlightRenderInstanceDataMap,S,W);if(g>=M.length)throw new rt(`LodRenderer internal error - missing lodLevel ${g}`);At(M[g],a,r)}m|=u.HIGHLIGHT_ACTIVE}else At(this._defaultRenderInstanceData[g],a,r),m|=u.DEFAULT_ACTIVE;a.state.set(r,m),a.lodLevel.set(r,g)}else m=d&~(u.ACTIVE|u.TRANSFORM_CHANGED),a.state.set(r,m);if(this._octreeCached!=null){const g=!!(d&u.ACTIVE),S=!!(m&u.ACTIVE);!g&&S?this._octreeCached.addInstance(r):g&&!S?this._octreeCached.removeInstance(r):g&&S&&d&u.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(r),this._octreeCached.addInstance(r))}r=r+1===h?0:r+1,r%l==0&&t.madeProgress()}this._instanceIndex=r,this._allRenderInstanceData.forEach(_=>_.forEach(d=>d.endUpdate())),this._context.requestRender()}_beginComponent(t,e,i){return e.size===0?null:i.glMaterials.load(t.rctx,t.bind.slot,t.output)?.beginSlot(t.bind)}_renderComponent(t,e,i,s,n){if(!e)return;const{bind:a,rctx:o}=t;o.runAppleAmdDriverHelper();const h=o.bindTechnique(e,a,s.material.parameters,Xe);o.bindVAO(s.vao),e.ensureAttributeLocations(s.vao),H.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===C.Color&&(h.setUniform4fv("externalColor",Ot[Math.min(n,Ot.length-1)]),h.setUniform1i("colorMixMode",kt.replace));const r=i.capacity,l=i.headIndex,_=i.tailIndex,d=i.firstIndex,m=this._glInstanceBufferLayout,f=(g,S)=>{Re(o,k,i.buffer,m,g),o.drawArraysInstanced(e.primitiveType,0,s.vertexCount,S-g),be(o,k,i.buffer,m)};s.material.parameters.transparent&&d!=null?l>_?(p(d>=_&&d<=l,"invalid firstIndex"),f(d,l),f(_,d)):l<_&&(d<=l?(p(d>=0&&d<=l,"invalid firstIndex"),f(d,l),f(_,r),f(0,d)):(p(d>=_&&d<=r,"invalid firstIndex"),f(d,r),f(0,l),f(_,d))):l>_?f(_,l):l<_&&(f(0,l),f(_,r)),o.bindVAO(null)}};function At(t,e,i){const s=t.allocateHead();qe(e,i,t.view,s)}function qe(t,e,i,s){ue(t.modelOrigin,e,i.modelOriginHi,i.modelOriginLo,s),i.model.copyFrom(s,t.model,e),i.modelNormal.copyFrom(s,t.modelNormal,e),t.color&&i.color&&i.color.copyFrom(s,t.color,e),t.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(s,t.objectAndLayerIdColor,e),t.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(s,t.featureAttribute,e)}function Ye(t){let e=lt().vec3f(c.INSTANCEMODELORIGINHI).vec3f(c.INSTANCEMODELORIGINLO).mat3f(c.INSTANCEMODEL).mat3f(c.INSTANCEMODELNORMAL);return t!=null&&t.includes("featureAttribute")&&(e=e.vec4f(c.INSTANCEFEATUREATTRIBUTE)),t!=null&&t.includes("color")&&(e=e.vec4u8(c.INSTANCECOLOR)),t!=null&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(c.INSTANCEOBJECTANDLAYERIDCOLOR)),e}y([T({constructOnly:!0})],R.prototype,"symbol",void 0),y([T({constructOnly:!0})],R.prototype,"optionalFields",void 0),y([T({constructOnly:!0})],R.prototype,"metadata",void 0),y([T({constructOnly:!0})],R.prototype,"shaderTransformation",void 0),y([T()],R.prototype,"_instanceData",void 0),y([T()],R.prototype,"_cycleStartIndex",void 0),y([T({readOnly:!0})],R.prototype,"_enableLevelSelection",null),y([T()],R.prototype,"_updateCyclesWithStaticCamera",void 0),y([T({readOnly:!0})],R.prototype,"running",null),R=y([et("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],R);const xt=E(),v=qt(),Lt=N(),Et=E(),Ct=E(),Ot=[D(1,0,1,1),D(0,0,1,1),D(0,1,0,1),D(1,1,0,1),D(1,0,0,1)],Xe=new ge;function Je(t,e,i){return!!ve(t,e,G,i.spatialReference)&&(i.x=G[0],i.y=G[1],i.z=G[2],!0)}const G=E(),$e=Object.freeze(Object.defineProperty({__proto__:null,build:fe},Symbol.toStringTag,{value:"Module"})),Ke=Object.freeze(Object.defineProperty({__proto__:null,build:me,getRadius:pe},Symbol.toStringTag,{value:"Module"})),Qe=Object.freeze(Object.defineProperty({__proto__:null,build:ye},Symbol.toStringTag,{value:"Module"})),Ze=Object.freeze(Object.defineProperty({__proto__:null,build:Ie},Symbol.toStringTag,{value:"Module"})),ti=Object.freeze(Object.defineProperty({__proto__:null,build:$t,calculateAnchorPosition:Kt},Symbol.toStringTag,{value:"Module"}));export{Qe as D,ti as H,Ze as R,$e as S,Je as a,B as b,Ke as c,mt as e,we as f,Ne as h,Me as i,R as k,Fe as m,Ee as r,De as s,Rt as t,He as u};
