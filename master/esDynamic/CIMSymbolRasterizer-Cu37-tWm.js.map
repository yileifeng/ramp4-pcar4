{"version":3,"file":"CIMSymbolRasterizer-Cu37-tWm.js","sources":["../../node_modules/@arcgis/core/symbols/cim/CIMSymbolRasterizer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.32/esri/copyright.txt for details.\n*/\nimport e from\"./CIMResourceManager.js\";import{Transformation as t,CanvasDrawHelper as i}from\"./CIMSymbolDrawHelper.js\";import{CIMSymbolHelper as h}from\"./CIMSymbolHelper.js\";import{OverrideHelper as r}from\"./OverrideHelper.js\";import{scale as n,translate as s}from\"./rasterizingUtils.js\";import{mapCIMSymbolToGeometryType as a}from\"./utils.js\";const o=96/72;class l{constructor(t){this._spatialReference=t,this._imageDataCanvas=null,this._cimResourceManager=new e}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement(\"canvas\")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,i,s,o,l,m,g,y,d){if(!e)return null;const{data:w}=e;if(!w||\"CIMSymbolReference\"!==w.type||!w.symbol)return null;const{symbol:u}=w;l||(l=a(u));const x=await r.resolveSymbolOverrides(w,t,this._spatialReference,o,l,m,g),f=this._cimResourceManager,p=[];h.fetchResources(x,f,p),h.fetchFonts(x,f,p),p.length>0&&await Promise.all(p);const{width:b,height:M}=i;let C=c(l,b,M,s,d);const R=h.getEnvelope(x,C,f);if(!R)return null;R.x===1/0&&(R.x=b+2),R.y===1/0&&(R.y=-M/2),R.width===-1/0&&(R.width=b),R.height===-1/0&&(R.height=M);let v=1,I=0,S=0;switch(u.type){case\"CIMPointSymbol\":case\"CIMTextSymbol\":{let e=1;R.width>b&&(e=b/R.width);let t=1;R.height>M&&(t=M/R.height),\"preview\"===s&&(R.width<b&&(e=b/R.width),R.height<M&&(t=M/R.height)),v=Math.min(e,t),I=R.x+R.width/2,S=R.y+R.height/2}break;case\"CIMLineSymbol\":if(d){S=R.y+R.height/2,I=R.x+R.width/2;const e=R.width-b,t=R.height-M;C={paths:n(C.paths,{xmin:-1*R.width/2+e,xmax:R.width/2-e,ymin:-1*R.height/2+t,ymax:R.height/2-t,width:R.width-2*e,height:R.height-2*t})}}else{(y||R.height>M)&&(v=M/R.height),S=R.y+R.height/2;const e=R.x*v+b/2,t=(R.x+R.width)*v+b/2,{paths:i}=C;i[0][0][0]-=e/v,i[0][2][0]-=(t-b)/v}break;case\"CIMPolygonSymbol\":if(d){S=R.y+R.height/2,I=R.x+R.width/2;const e=R.width-b,t=R.height-M;C={paths:n(C.rings,{xmin:-1*R.width/2+e,xmax:R.width/2-e,ymin:-1*R.height/2+t,ymax:R.height/2-t,width:R.width-2*e,height:R.height-2*t})}}else{I=R.x+R.width/2,S=R.y+R.height/2;const e=R.x*v+b/2,t=(R.x+R.width)*v+b/2,i=R.y*v+M/2,h=(R.y+R.height)*v+M/2,{rings:r}=C;e<0&&(r[0][0][0]-=e,r[0][3][0]-=e,r[0][4][0]-=e),i<0&&(r[0][0][1]+=i,r[0][1][1]+=i,r[0][4][1]+=i),t>b&&(r[0][1][0]-=t-b,r[0][2][0]-=t-b),h>M&&(r[0][2][1]+=h-M,r[0][3][1]+=h-M)}}const _={type:\"cim\",data:{type:\"CIMSymbolReference\",symbol:x}};return this.rasterize(_,b,M,I,S,v,l,1,C)}rasterize(e,h,r,n,s,l,m,g=0,y=null,d=window.devicePixelRatio||1){const{data:w}=e;if(!w||\"CIMSymbolReference\"!==w.type||!w.symbol)return null;const{symbol:u}=w,x=this._canvas,f=d*o;x.width=h*f,x.height=r*f,m||(m=a(u)),y||(y=c(m,h,r,\"legend\")),x.width+=2*g,x.height+=2*g;const p=x.getContext(\"2d\",{willReadFrequently:!0}),b=t.createIdentity();b.translate(-n,-s),b.scale(l*f,-l*f),b.translate(h*f/2+g,r*f/2+g),p.clearRect(0,0,x.width,x.height);return new i(p,this._cimResourceManager,b,!0).drawSymbol(u,y),p.getImageData(0,0,x.width,x.height)}}function m(e,t,i,h){if(\"esriGeometryPolygon\"===t){return{rings:s(n(e.rings,{xmin:0,ymin:0,xmax:i,ymax:h,width:i,height:h}),-1*i/2,-1*h/2)}}if(\"esriGeometryPolyline\"===t){return{paths:s(n(e.paths,{xmin:0,ymin:0,xmax:i,ymax:h,width:i,height:h}),-1*i/2,-1*h/2)}}return null}function c(e,t,i,h,r){const n=1,s=-t/2+n,a=t/2-n,o=i/2-n,l=-i/2+n;if(r&&(\"esriGeometryPolygon\"===e||\"esriGeometryPolyline\"===e)){const h=m(r,e,t,i);if(h)return h}switch(e){case\"esriGeometryPoint\":return{x:0,y:0};case\"esriGeometryPolyline\":return{paths:[[[s,0],[0,0],[a,0]]]};default:return\"legend\"===h?{rings:[[[s,o],[a,0],[a,l],[s,l],[s,o]]]}:{rings:[[[s,o],[a,o],[a,l],[s,l],[s,o]]]}}}export{l as CIMSymbolRasterizer};\n"],"names":["o","l","t","e","i","s","m","g","y","d","u","a","x","r","f","h","b","M","C","c","R","v","I","S","n","_"],"mappings":"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","x_google_ignoreList":[0]}